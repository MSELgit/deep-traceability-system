# 仕様変更提案：望ましさ方向（望大/望小）への対応

## 概要

トレードオフ判定において、性能の望ましさ方向（望大↑/望小↓）が混在するケースへの対応を行う。本文書は実装完了後の最終仕様として、全変更の実装状況を記録する。

### 背景

従来のエネルギー式は、全性能が望大（larger-is-better）であることを暗黙に仮定していた。しかし実データ（洋上風力事例）では、同一性能に対して望大票と望小票が混在するケースが存在する。

- **P3（海域占有面積）**：↓3票 + ↑1票（方向合意度 = −0.50）
- **P6（視認性）**：↑3票 + ↓1票（方向合意度 = +0.50）

このような混在票がある場合、構造的対立（cosθ < 0）が一部のステークホルダーにとってはシナジーとなるため、エネルギー計算が過大評価される。

---

## 1. エネルギー計算式の変更

**ステータス：✅ 実装済み**

### 1.1 新たに必要なデータ

ニーズ-性能マトリクスから、各性能について以下を算出・保持する。

| 変数 | 定義 | 算出方法 |
|------|------|---------|
| `n_i_up` | 望大票数 $n_i^\uparrow$ | ↑方向の按分票の合計 |
| `n_i_down` | 望小票数 $n_i^\downarrow$ | ↓方向の按分票の合計 |
| `delta_i` | 正味方向票 $\delta_i = n_i^\uparrow - n_i^\downarrow$ | 上記の差 |
| `W_i` | 重み（従来通り） | $W_i = n_i^\uparrow + n_i^\downarrow$（変更なし） |
| `consensus_i` | 方向合意度 $\delta_i / W_i$ | 表示用。$[-1, +1]$ の範囲 |

**実装箇所：**
- `backend/app/services/structural_energy.py` — `compute_structural_energy()` で W_i, delta_i から E_ij を計算
- `backend/app/services/structural_tradeoff.py` — `performance_consensus` マップ（{db_perf_id: δ_i/W_i}）をレスポンスに含む
- `frontend/src/components/matrix/NeedPerformanceMatrix.vue` — 方向別票数（n_up, n_down）の集計
- `backend/app/models/database.py` — `direction_up_votes`, `direction_down_votes` フィールド

### 1.2 エネルギー式の変更

#### 変更前

```
E_ij = W_i * W_j * L(C_ij) / (ΣW_k)²
```

ここで `L(x) = max(-x, 0)` は損失関数。

#### 変更後

```
E_ij = (W_i * W_j * |C_ij| - delta_i * delta_j * C_ij) / (2 * (ΣW_k)²)
```

#### 実装の詳細

**`structural_energy.py`** での計算：
```python
# 個別ペアの寄与（正規化前）
contribution = W_i * W_j * abs(C_ij) - delta_i * delta_j * C_ij
# 全体エネルギー
E = sum(contributions) / (2 * sum_W ** 2)
```

**注意：正規化因子 `2 * sum_W²` は全ペア合計に対して1回だけ適用する。** 初期実装では個別ペアごとに `/2.0` を行い二重除算となるバグがあったが修正済み。

#### 変更の影響範囲

- **全票同方向の性能ペア**（`|delta_i| = W_i` かつ `|delta_j| = W_j`）：変更前と完全一致。検証ポイントとして使える。
- **混在票を含むペア**：エネルギー値が変化する（一般に減少する）。
- **全体エネルギー `E = Σ E_ij`** および **標高 `H`** に波及する。
- **高さ `H_ij` の計算**：変更なし（`H` は `cosθ` ベースで方向情報に依存しない）。
- **mountain_calculator.py の partial_energies**：正規化因子を適用して正しいエネルギー値を計算するよう修正済み。

### 1.3 追加の計算量

`energy_contributions` 配列の各エントリに以下を追加：

| フィールド | 計算式 | 意味 |
|-----------|--------|------|
| `consensus_i` | `delta_i / W_i` | P_i の方向合意度 |
| `consensus_j` | `delta_j / W_j` | P_j の方向合意度 |
| `lambda_ij` | `E_ij / C_ij` | エネルギー強度係数 |
| `offset_rate` | `1 - E_ij / E_max` | 相殺率（混在票による減衰） |

**実装箇所：** `backend/app/services/structural_energy.py` L140-170

---

## 2. Shapley値分解の解釈変更

**ステータス：✅ 実装済み**

### 2.1 計算ロジック

Shapley値分解は `C_ij` を値関数とするゲームで、各要素の構造的寄与 `φ_e` を計算する。

**計算ロジック自体の変更は不要。** `shapley_calculator.py` は変更なし。

### 2.2 変換係数 `λ_ij`

`C_ij` の符号が確定している場合、`E_ij` は `C_ij` の定数倍として表せる。

```
λ_ij = E_ij / C_ij
```

**実装：** フロントエンド側で計算（`TradeoffAnalysisModal.vue` の `onCellClick()` 内）。

```typescript
// λ_ij = E_ij / C_ij
let lambdaIJ: number | undefined;
if (Math.abs(cij) > 1e-12) {
  lambdaIJ = eij / cij;
}
```

バックエンド側でも `structural_energy.py` の `energy_contributions` に `lambda_ij` を格納（APIレスポンスで取得可能）。

### 2.3 エネルギー空間でのShapley値

Shapley値 `φ_e`（構造的寄与）に `λ_ij` を掛けることで、エネルギー空間での寄与が得られる。

```
φ_e^(E) = λ_ij × φ_e
```

**実装：** `ShapleyBreakdown.vue` の表示層で変換。保存されたShapley値自体は変更しない。

**重要な性質：** λ_ij は定数スカラーであるため、構造寄与とエネルギー寄与のパーセンテージ（寄与割合）は数学的に同一。ノード群・エッジ群で別々に分母を計算することで一致を保証。

```typescript
// ノード群・エッジ群で別々に分母を計算
const nodeTotalAbsLambdaPhi = nodeShapleyValues.reduce(
  (sum, item) => sum + Math.abs(item.phi * lambda), 0
);
const edgeTotalAbsLambdaPhi = edgeShapleyValues.reduce(
  (sum, item) => sum + Math.abs(item.phi * lambda), 0
);
```

### 2.4 エネルギー寄与の符号解釈

エネルギー寄与 `φ_e^(E) = λ_ij × φ_e` の符号には明確な意味がある：

| φ_e^(E) | 意味 | 色 |
|----------|------|-----|
| 正（> 0） | このエッジがトレードオフエネルギーを**悪化**させる | 赤 |
| 負（< 0） | このエッジがトレードオフエネルギーを**緩和**させる | ティール |

**実装：** `ShapleyBreakdown.vue` の `energySignClass()` および `energyBarStyle()` で色分け。

---

## 3. UI/表示の変更

### 設計原則

**構造的な量（客観的事実）と価値的な量（ステークホルダーにとっての良し悪し）に異なる色系統を使い、混同を避ける。**

| 量の種類 | 色系統 | 理由 |
|---------|--------|------|
| 構造的（cosθ, φ_e） | 青/橙（中立色） | 正負に良い悪いの意味がないため |
| 価値的（E_ij, φ_e^(E)） | 白/赤（悪化）、ティール（緩和） | 大きい＝困難という価値判断を含むため |

### 3.1 cosθマトリクスの色分け変更

**ステータス：✅ 実装済み**

#### 変更前
- `-1`：赤、`0`：黄、`+1`：緑（Diverging: 赤-黄-緑）

#### 変更後
- `-1`：濃い青(`#1565C0`)、`0`：白(`#FFFFFF`)、`+1`：濃い橙(`#EF6C00`)

#### 実装箇所
- `MatrixHeatmap.vue` の `getCellColor()` — RGB補間で色生成
- 凡例グラデーション：`linear-gradient(to right, #1565C0, #FFFFFF, #EF6C00)`
- 凡例ラベル：`-1 (Structural Opposition)` / `0` / `+1 (Structural Cooperation)`

### 3.2 エネルギーマトリクスの色分け

**ステータス：✅ 変更なし（設計通り）**

- `0`：白、最大値：赤（Sequential: 白-赤）
- エネルギーは望ましさ方向を反映済みなので、「赤＝深刻なトレードオフ」は正しい。

### 3.3 エネルギーマトリクスへの方向インジケータ

**ステータス：✅ 実装済み（提案から仕様変更あり）**

#### 提案時の案
- セル角にアイコン（⇅マーク）を表示

#### 実際の実装
以下3つの要素を組み合わせて実装：

**① 方向インジケータ行（列ヘッダ下に追加）**
- エネルギーモード時のみ表示される追加行
- 各性能の方向合意度を記号で表示：
  - `↑` : 全票望大（consensus = +1.0）
  - `↓` : 全票望小（consensus = -1.0）
  - `↗` : 混在・望大寄り（0 < consensus < 1）
  - `↙` : 混在・望小寄り（-1 < consensus < 0）

**② 行ラベルの方向アイコン**
- 行の性能名の左側に同じ方向記号を表示

**③ 相殺率バッジ**
- 混在票のあるペアのセルに `~50%` のような相殺率テキストを表示
- 紫色(`#AB47BC`)で表示
- 計算式：`offset_rate = (1 + consensus_i * consensus_j * sign(C_ij)) / 2`

**実装箇所：** `MatrixHeatmap.vue` の `hasAnyConsensus`, `getDirectionSymbol()`, `getOffsetRate()` 等

### 3.4 マトリクスセルのホバーツールチップ拡張

**ステータス：✅ 実装済み**

#### 変更後の表示内容

```
P1 vs P3
cos θ = -0.82（構造的対立）
E_ij = 0.035

方向合意度：
  P1: δ/W = +1.00（全票望大 ↑）
  P3: δ/W = -0.50（混在 ↑1票 ↓3票）

構造的対立のうち約50%がシナジーとして相殺
```

**実装箇所：** `MatrixHeatmap.vue` の `getCellTooltip()`

### 3.5 Shapley棒グラフの色分け変更 + 2モード切替

**ステータス：✅ 実装済み**

#### 構造モード（デフォルト）

| 寄与方向 | 色 | 意味 |
|---------|------|------|
| `φ_e < 0` | 青（`#64B5F6`→`#1565C0`） | 構造的対立方向に寄与 |
| `φ_e > 0` | 橙（`#FFB74D`→`#EF6C00`） | 構造的協調方向に寄与 |

cosθマトリクスと色が対応する。

#### エネルギーモード（切替時）

| 寄与方向 | 色 | 意味 |
|---------|------|------|
| `λφ_e > 0` | 赤（`rgba(211,47,47,...)`） | トレードオフエネルギーを悪化 |
| `λφ_e < 0` | ティール（`rgba(0,150,136,...)`） | トレードオフエネルギーを緩和 |

**注：提案時は全て白→赤グラデーションとしていたが、正負の区別ができないため赤/ティールに変更。**

#### 切替UI

棒グラフ上部にトグルスイッチを配置（`lambdaIJ` が利用可能な場合のみ表示）：

```
[構造寄与 (φ)] / [エネルギー寄与 (λφ)]
```

**実装箇所：** `ShapleyBreakdown.vue` の `shapleyMode` ref、`energySignClass()`、`energyBarStyle()`

### 3.6 Shapley棒グラフへのアノテーション追加

**ステータス：✅ 実装済み**

棒グラフのヘッダに選択中の性能ペアの方向情報を表示。

#### 表示例

```
(P1, P3): cosθ = -0.82（構造的対立）| E = 0.035
⚠ P3 の望ましさ方向が混在（δ/W = -0.50）：構造的対立の約50%がシナジーとして相殺
```

混在票がないペアではこの警告行を表示しない。

**実装箇所：** `ShapleyBreakdown.vue` の `hasMixedConsensus`, `mixedConsensusInfos`, `offsetRate`

### 3.7 経路ハイライトへの方向アイコン追加

**ステータス：✅ 実装済み**

#### 性能ノードの方向アイコン

| 方向合意度 | アイコン | 意味 |
|-----------|---------|------|
| `δ/W = +1` | ↑ | 全票望大 |
| `δ/W = -1` | ↓ | 全票望小 |
| `-1 < δ/W < +1` | ⇅ | 混在（紫色 `#AB47BC`） |

**実装箇所：** `TradeoffNetworkViewer.vue` の `getDirectionIcon()`, `getDirectionColor()`

### 3.8 ネットワークハイライトの構造/エネルギーモード切替

**ステータス：✅ 実装済み（提案時にはなかった追加機能）**

Shapley棒グラフと同様に、ネットワーク可視化にも構造/エネルギーモード切替を追加。

#### 構造モード（デフォルト）

| 要素 | 色 | 意味 |
|------|-----|------|
| −φ エッジ/ノード | 青系（`#1565C0`, `#64B5F6`, `#BBDEFB`） | 構造的対立方向に寄与 |
| +φ エッジ/ノード | 橙系（`#EF6C00`, `#FFB74D`, `#FFE0B2`） | 構造的協調方向に寄与 |

#### エネルギーモード

| 要素 | 色 | 意味 |
|------|-----|------|
| +λφ エッジ/ノード | 赤系（`#C62828`, `#E57373`, `#FFCDD2`） | エネルギー悪化 |
| −λφ エッジ/ノード | ティール系（`#00695C`, `#4DB6AC`, `#B2DFDB`） | エネルギー緩和 |

#### 切替UI

ネットワークビューアのツールバーにトグルボタンを配置：

```
[構造 (φ)] / [エネルギー (λφ)]
```

#### モード連動凡例

ビューア下部に寄与色凡例を表示。モードに応じて凡例の色・ラベルが切り替わる。

**実装箇所：**
- `TradeoffNetworkViewer.vue` — `networkMode` ref、`getEnergySign()`、SVGマーカー定義（赤/ティール）
- `TradeoffAnalysisModal.vue` — `lambdaIJ` の受け渡し、外部凡例を削除（ビューア内部に移動）

### 3.9 カップリング（Tab3）・離散化信頼度（Tab4）

**変更なし。** カップリングは構造的指標のみで完結し、離散化信頼度も望ましさ方向とは独立。

---

## 4. 変更ファイル一覧

### バックエンド（4ファイル）

| ファイル | 変更内容 |
|---------|---------|
| `backend/app/services/structural_energy.py` | 4象限エネルギー式、consensus_i, lambda_ij, offset_rate |
| `backend/app/services/structural_tradeoff.py` | performance_consensus マップ、エネルギー式のフォールバック |
| `backend/app/services/mountain_calculator.py` | partial_energies の正規化修正 |
| `backend/app/models/database.py` | direction_up_votes, direction_down_votes フィールド |

### フロントエンド（7ファイル）

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/utils/api.ts` | StructuralTradeoffResult 型に performance_consensus 追加 |
| `frontend/src/components/analysis/MatrixHeatmap.vue` | 青/橙色変更、方向インジケータ行、相殺率バッジ、ツールチップ拡張 |
| `frontend/src/components/analysis/ShapleyBreakdown.vue` | 青/橙色変更、構造/エネルギーモード切替、赤/ティール色分け、アノテーション |
| `frontend/src/components/analysis/TradeoffNetworkViewer.vue` | 青/橙色変更、構造/エネルギーモード切替、赤/ティール色分け、方向アイコン、凡例 |
| `frontend/src/components/analysis/TradeoffAnalysisModal.vue` | データフロー（consensus, lambdaIJ等のprops転送）|
| `frontend/src/components/mountain/DesignCaseDetail.vue` | total_energy, spectral_radius の取得 |
| `frontend/src/components/matrix/NeedPerformanceMatrix.vue` | 方向別票数の集計 |

### 変更しなかったファイル

| ファイル | 理由 |
|---------|------|
| `shapley_calculator.py` | 計算ロジック自体は変更不要。表示層でλスケーリング |
| `coupling_calculator.py` | 構造的指標のみで完結 |
| Tab3 (Coupling) / Tab4 (Confidence) | 望ましさ方向とは独立 |
| `MountainView.vue` 等の3D表示 | エネルギー値を表示するだけ |

---

## 5. 色設計サマリ（最終版）

| 表示要素 | 変更前 | 変更後 | 色の意味 |
|---------|--------|--------|---------|
| cosθマトリクス | 赤(-1)─黄(0)─緑(+1) | **青(-1)─白(0)─橙(+1)** | 構造的方向（中立） |
| Eマトリクス | 白(0)─赤(高) | 白(0)─赤(高)【変更なし】 | トレードオフ深刻度（価値的） |
| Shapley棒（構造モード） | 赤(φ<0)─緑(φ>0) | **青(φ<0)─橙(φ>0)** | 構造的寄与方向（中立） |
| Shapley棒（Eモード） | N/A（新規） | **赤(λφ>0)─ティール(λφ<0)** | エネルギー悪化/緩和 |
| ネットワーク（構造モード） | 赤/緑 | **青/橙** | 構造的寄与方向（中立） |
| ネットワーク（Eモード） | N/A（新規） | **赤/ティール** | エネルギー悪化/緩和 |
| 性能ノード方向 | なし | **↑/↓/⇅ アイコン** | 望ましさ方向 |
| マトリクス方向行 | なし | **↑/↓/↗/↙ + 相殺率%** | 望ましさ方向 + 混在度 |

**一貫した原則：青/橙 = 構造的事実を見ている、赤/ティール = エネルギー（価値判断）を見ている**

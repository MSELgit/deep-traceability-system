# 望大・望小性能を考慮したトレードオフ理論の再定式化

## 1. 用語について

「望大性能」「望小性能」は品質工学（タグチメソッド）における「望大特性」「望小特性」に由来する表現で、工学分野で広く通用する。論文での表記候補：

| 候補 | 備考 |
|------|------|
| **望大性能 / 望小性能** | 本論文の文脈（性能＝Performance）に合致。推奨 |
| 望大特性 / 望小特性 | タグチの原語に忠実だが「特性」と「性能」が混在する |
| Larger-the-better (LTB) / Smaller-the-better (STB) | 英語併記する場合 |

以下では **望大性能**（$d_i = +1$）・**望小性能**（$d_i = -1$）と表記する。

---

## 2. 問題の検証：単純な例

### 設定
- 属性 $A_1$ のみ、変数 $V_1$ のみ
- $A_1 \to P_1$：正のエッジ（$+b_1$）
- $A_1 \to P_2$：負のエッジ（$-b_2$）
- $b_1, b_2 > 0$

### 総効果行列

$$T = B_{PA} \cdot B_{AV} = \begin{pmatrix} b_1 \\ -b_2 \end{pmatrix}$$

$$C_{12} = T_{1\cdot} \cdot T_{2\cdot} = b_1 \cdot (-b_2) = -b_1 b_2 < 0$$

$$\cos\theta_{12} < 0 \quad \Rightarrow \quad \text{「構造的トレードオフあり」と判定}$$

### ケース1：P1 望大、P2 望大（論文の暗黙の前提）

| 介入 | $\Delta P_1$ | $\Delta P_2$ | $P_1$ にとって | $P_2$ にとって |
|------|-------------|-------------|---------------|---------------|
| $\Delta V_1 > 0$ | $+$ (増加) | $-$ (減少) | ✅ 改善 | ❌ 悪化 |
| $\Delta V_1 < 0$ | $-$ (減少) | $+$ (増加) | ❌ 悪化 | ✅ 改善 |

**→ 正真正銘のトレードオフ。** $\cos\theta < 0$ の判定は正しい。

### ケース2：P1 望小、P2 望大

| 介入 | $\Delta P_1$ | $\Delta P_2$ | $P_1$ にとって | $P_2$ にとって |
|------|-------------|-------------|---------------|---------------|
| $\Delta V_1 > 0$ | $+$ (増加) | $-$ (減少) | ❌ 悪化（望小なのに増加） | ❌ 悪化 |
| $\Delta V_1 < 0$ | $-$ (減少) | $+$ (増加) | ✅ 改善（望小で減少） | ✅ 改善 |

**→ 同時改善が可能。トレードオフではなく相乗効果。**

にもかかわらず $C_{12} < 0$ のままなので、現行理論は **「トレードオフあり」と誤判定する**。

### 結論

> 現行の $\cos\theta$ による判定は、全性能が望大であるという暗黙の仮定に依存しており、望小性能が混在すると判定が反転しうる。

---

## 3. 単純な場合の修正：望ましさ方向の符号補正

### 望ましさ調整済み感度ベクトル

各性能 $P_i$ に対して望ましさ方向 $d_i \in \{+1, -1\}$ を定義し：

$$\tilde{T}_{i\cdot} = d_i \cdot T_{i\cdot}$$

### 修正された構造的トレードオフ指標

$$\cos\tilde{\theta}_{ij} = d_i \cdot d_j \cdot \cos\theta_{ij}$$

| $d_i$ | $d_j$ | 効果 |
|--------|--------|------|
| 同方向（望大-望大 or 望小-望小） | — | $\cos\tilde\theta = \cos\theta$（変化なし） |
| 異方向（望大-望小 or 望小-望大） | — | $\cos\tilde\theta = -\cos\theta$（**符号反転**） |

修正定理：$\cos\tilde\theta_{ij} < 0 \iff$ 望ましさの意味でトレードオフが存在する。

---

## 4. 核心的問題：混合望ましさ（7章のDeep Traceability）

### 問題の構造

ニーズ-性能マトリクスにおいて、**同一性能に対して望大票（↑）と望小票（↓）が混在する**。

例：性能 $P_1$ について $n_1^\uparrow = 20$ 票、$n_1^\downarrow = 50$ 票、合計 $W_1 = 70$ 票

このとき $d_1$ を $+1$ にも $-1$ にも一意に定めることができない。

### なぜ「単純な書き換え」では済まないか

性能の定義自体を反転させると、20票分の望ましさが壊れる。したがって性能レベルでの符号反転では解決できず、**票の単位で望ましさを考慮した再定式化が必要**。

---

## 5. エネルギー計算式の再定義

### 現行の定式化（論文の式 eq:energy_definition）

$$E = \frac{\sum_{i < j} W_i W_j \cdot \mathcal{L}(C_{ij})}{\left(\sum_{i=1}^I W_i\right)^2}, \qquad \mathcal{L}(x) = \begin{cases} |x| & (x < 0) \\ 0 & (x \geq 0) \end{cases}$$

**問題点：** $C_{ij} < 0$ を一律に「トレードオフ」として計上しているが、望ましさ方向を考慮すると、一部の票にとってはシナジーである。

### 4象限分解

$(P_i, P_j)$ ペアに対する票の方向の組み合わせ4通り：

| 組み合わせ | 票数の積 | 望ましさ調整後の $C$ | トレードオフ条件 |
|-----------|---------|---------------------|----------------|
| $(↑, ↑)$ | $n_i^\uparrow n_j^\uparrow$ | $C_{ij}$ | $C_{ij} < 0$ |
| $(↑, ↓)$ | $n_i^\uparrow n_j^\downarrow$ | $-C_{ij}$ | $C_{ij} > 0$ |
| $(↓, ↑)$ | $n_i^\downarrow n_j^\uparrow$ | $-C_{ij}$ | $C_{ij} > 0$ |
| $(↓, ↓)$ | $n_i^\downarrow n_j^\downarrow$ | $C_{ij}$ | $C_{ij} < 0$ |

修正エネルギー（展開形）：

$$E_{ij} = \frac{(n_i^\uparrow n_j^\uparrow + n_i^\downarrow n_j^\downarrow) \cdot \mathcal{L}(C_{ij}) + (n_i^\uparrow n_j^\downarrow + n_i^\downarrow n_j^\uparrow) \cdot \mathcal{L}(-C_{ij})}{(\sum_k W_k)^2}$$

### 簡潔な閉形式

**正味方向票**（net directional vote）を導入する：

$$\delta_i := n_i^\uparrow - n_i^\downarrow$$

代数的恒等式：

$$n_i^\uparrow n_j^\uparrow + n_i^\downarrow n_j^\downarrow = \frac{W_i W_j + \delta_i \delta_j}{2}, \qquad n_i^\uparrow n_j^\downarrow + n_i^\downarrow n_j^\uparrow = \frac{W_i W_j - \delta_i \delta_j}{2}$$

損失関数の性質：

$$\mathcal{L}(x) + \mathcal{L}(-x) = |x|, \qquad \mathcal{L}(x) - \mathcal{L}(-x) = -x$$

代入すると：

$$\boxed{E_{ij} = \frac{W_i W_j \, |C_{ij}| \;-\; \delta_i \delta_j \, C_{ij}}{2\left(\sum_k W_k\right)^2}}$$

$$E = \sum_{i < j} E_{ij}$$

---

## 6. 簡潔式の検証

### 検証1：全票望大（$\delta_i = W_i,\ \delta_j = W_j$）

$$E_{ij} = \frac{W_i W_j(|C_{ij}| - C_{ij})}{2(\sum W_k)^2} = \begin{cases} \frac{W_i W_j |C_{ij}|}{(\sum W_k)^2} & (C_{ij} < 0) \\ 0 & (C_{ij} \geq 0)\end{cases}$$

旧式と完全一致。 ✅

### 検証2：$P_1$ 全票望小、$P_2$ 全票望大、$C_{12} < 0$

$\delta_1 = -W_1,\ \delta_2 = W_2$

$$E_{12} = \frac{W_1 W_2 |C_{12}| - (-W_1)(W_2) C_{12}}{2(\sum W_k)^2} = \frac{W_1 W_2(-C_{12}) + W_1 W_2 C_{12}}{2(\sum W_k)^2} = 0$$

シナジーとして正しくゼロ。 ✅

### 検証3：完全分裂（$\delta_i = 0$）

$$E_{ij} = \frac{W_i W_j |C_{ij}|}{2(\sum W_k)^2}$$

$C_{ij}$ の符号によらず常にエネルギー半分が計上される。どちらに動かしても半数が不満を持つので物理的に正しい。 ✅

### 検証4：$\delta$ の連続変化（$C_{12} < 0$、$W_1 = W_2 = 50$）

| $n_1^\uparrow$ | $n_1^\downarrow$ | $\delta_1$ | $E_{12}$ 分子 |
|---|---|---|---|
| 50 | 0 | +50 | $5000|C|$ |
| 40 | 10 | +30 | $4000|C|$ |
| 25 | 25 | 0 | $2500|C|$ |
| 10 | 40 | −30 | $1000|C|$ |
| 0 | 50 | −50 | $0$ |

全票望大 → 完全分裂 → 全票望小に移行するにつれ、$5000 \to 2500 \to 0$ と単調変化。 ✅

### 検証5：構造的シナジー（$C_{12} > 0$）+ 異方向票

$P_1$：$n_1^\uparrow = 0, n_1^\downarrow = 50$（望小）、$P_2$：$n_2^\uparrow = 50, n_2^\downarrow = 0$（望大）

$\delta_1 = -50,\ \delta_2 = 50$、$|C_{12}| = C_{12}$

$$E_{12} = \frac{2500 C_{12} - (-2500) C_{12}}{2(\sum W_k)^2} = \frac{5000 C_{12}}{2(\sum W_k)^2}$$

旧式では $\mathcal{L}(C_{12}) = 0$ でエネルギーゼロだが、新式ではこの「隠れたトレードオフ」を正しく検出する。 ✅

---

## 7. エントロピー重み付き有効投票数について

### 提案された式

$$I(a, b) = (a + b) \cdot [1 + H(x)], \qquad H(x) = -x\log_2 x - (1-x)\log_2(1-x)$$

の導入は不要。理由を3点述べる。

### 理由1：4象限分解が同じ効果を内包している

$\delta_i / W_i \in [-1, +1]$ を**方向合意度**（directional consensus）と呼ぶ。

- $|\delta_i / W_i| = 1$：全会一致（全票が同方向）
- $|\delta_i / W_i| = 0$：完全分裂

4象限分解の簡潔式 $E_{ij} = (W_i W_j |C_{ij}| - \delta_i \delta_j C_{ij}) / 2(\sum W_k)^2$ において、$\delta_i$ が小さい（票が分裂している）ほど第2項の打ち消し効果が弱まり、エネルギーは自動的に増大する。エントロピー関数が捉えようとしている「票の分裂 → 調整困難性の増大」は、既に理論的に内包されている。

### 理由2：票数保存の破壊

Deep Traceabilityの根幹は「ステークホルダーの票数がニーズ → 性能へと保存的に配分される」というトレーサビリティにある。$I(a,b) \geq a + b$（等号は $a=0$ or $b=0$ のみ）なので、エントロピー重み付けは票数を「水増し」する。$\sum I_i > \sum W_i$（= 総投入票数）となり、ステークホルダーからの逆追跡が不可能になる。

### 理由3：標高への副作用

$W_i$ は標高 $H$ の計算にも使われる。票が分裂した性能の重みを増やすと、「多くのステークホルダーが関心を持つ性能」と「意見が割れている性能」の区別がつかなくなる。

### 結論

エントロピー関数の直感は正しいが、4象限分解の $\delta_i$ が同じ効果を理論的に導出可能な形で実現している。論文には4象限分解のみを採用し、$\delta_i / W_i$ を「方向合意度」として紹介すれば十分。

---

## 8. 数学的性質の保存

| 性質 | 旧式 | 新式 | 保存 |
|------|------|------|------|
| $E \geq 0$ | ✅ | ✅（各項の分子 $W_i W_j|C| - \delta_i\delta_j C \geq 0$） | ✅ |
| 全ペアシナジー $\Rightarrow E=0$ | ✅ | 混合票の場合は $E > 0$ だが物理的に正しい | ✅ |
| 部分エネルギー加法分解 $E = \sum E_{ij}$ | ✅ | ✅ | ✅ |
| 旧式が特殊ケース | — | 全票同方向で旧式と一致 | ✅ |

**$E_{ij} \geq 0$ の証明：**

$W_i W_j |C_{ij}| - \delta_i \delta_j C_{ij} \geq 0$ を示す。$|\delta_i| \leq W_i,\ |\delta_j| \leq W_j$ より $|\delta_i \delta_j| \leq W_i W_j$。したがって $|\delta_i \delta_j C_{ij}| \leq W_i W_j |C_{ij}|$。ゆえに $W_i W_j |C_{ij}| - \delta_i \delta_j C_{ij} \geq W_i W_j |C_{ij}| - |\delta_i \delta_j C_{ij}| \geq 0$。 $\square$

---

## 9. $\cos\theta$ の解釈への影響

### 構造的指標としての $\cos\theta$ は変更不要

$\cos\theta_{ij}$ はあくまで因果構造の記述であり、望ましさとは独立。

### 解釈表

| 構造 | 望ましさ方向 | 真のトレードオフ？ |
|------|------------|-----------------|
| $\cos\theta < 0$（構造的対立） | 同方向 | ✅ Yes |
| $\cos\theta < 0$（構造的対立） | 異方向 | ❌ No（シナジー） |
| $\cos\theta > 0$（構造的協調） | 同方向 | ❌ No（シナジー） |
| $\cos\theta > 0$（構造的協調） | 異方向 | ✅ Yes（**隠れたトレードオフ**） |

最後のケースが特に重要：構造的には協調しているが、望ましさが逆方向であるために実質トレードオフになる。

---

## 10. 実装上の変更

### データモデル

ニーズ-性能マトリクスの各セルに方向情報 $d_{ji} \in \{+1, -1, 0\}$ が必要。

### 票数の分離

$$n_i^\uparrow = \sum_{j:\ d_{ji} = +1} v_{ji}^{(NP)}, \qquad n_i^\downarrow = \sum_{j:\ d_{ji} = -1} v_{ji}^{(NP)}, \qquad W_i = n_i^\uparrow + n_i^\downarrow$$

### 修正箇所

- **標高 $H$：変更不要**（効用関数が望ましさを吸収済み）
- **エネルギー $E$：修正式を適用**
- **Shapley値分解：要検討**（$C_{ij}$ の代わりに修正 $\tilde{C}_{ij}$ を用いるか）

---

## 11. まとめ

### 発見された問題

1. $\cos\theta$ の判定は全性能望大を暗黙に仮定しており、望小性能混在時に誤判定する
2. 純粋な望大/望小なら符号反転で解決するが、同一性能に↑↓が混在する場合は原理的に不可能
3. エネルギー $E$ の計算式の再定義が必要

### 解決策

4象限分解により、票単位で望ましさを考慮した修正エネルギー：

$$E_{ij} = \frac{W_i W_j \, |C_{ij}| - \delta_i \delta_j \, C_{ij}}{2(\sum_k W_k)^2}, \qquad \delta_i = n_i^\uparrow - n_i^\downarrow$$

旧式を特殊ケースとして包含し、全数学的性質を保存する。

エントロピー重み付け等の追加ヒューリスティックは不要。$\delta_i$ が票の分裂による調整困難性を理論的かつ自然に捉えている。

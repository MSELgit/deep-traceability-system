# ネットワークJSON インポート ガイド

本ドキュメントは、Deep Traceability System のPAVEネットワークをJSON形式でインポートする方法を説明します。
**AIツール（Claude, ChatGPT等）にこのファイルをそのまま読み込ませることで、正しいJSON形式を自動生成させることができます。**

---

## 概要

設計案のネットワークは4層構造（PAVEモデル）で構成されます。通常はGUI上で手動構築しますが、JSON形式でインポートすることで一括作成が可能です。

### フロー

```
1. AIまたは手作業でJSONを作成
2. ネットワークエディタ画面で「JSON Import」ボタンをクリック
3. JSONをペースト（またはファイル選択）
4. 「バリデーション & プレビュー」で内容を確認
5. 性能ノードのマッチングを確認・選択
6. 「インポート実行」でネットワークに反映（自動レイアウト）
```

---

## PAVEモデル（4層構造）

ネットワークは以下の4層から構成されます。

| Layer | 記号 | 名称 | 説明 | 例 |
|-------|------|------|------|-----|
| 1 | **P** | Performance（性能） | システムが達成すべき性能指標。事前にシステムに登録された性能ツリーの末端（リーフ）ノードと対応する | 航続距離, 加速性能, 車両重量 |
| 2 | **A** | Attribute（属性） | 性能に影響を与える物理的・設計的な属性 | 空気抵抗係数, バッテリー容量, 車体剛性 |
| 3 | **V** | Variable（変数） | 設計者が操作できる設計変数 | 車体形状, フレーム構造, 電池セル数 |
| 4 | **E** | Entity（モノ・環境） | 物理的な構成要素（Object）や外部環境条件（Environment） | ボディパネル, フレーム材料, 風環境 |

### エッジの方向ルール（重要）

以下の接続パターンのみ有効です。これ以外はバリデーションエラーになります。

| 接続 | 方向 | 説明 |
|------|------|------|
| **A → P** | 有向 | 属性が性能に影響を与える |
| **V → A** | 有向 | 変数が属性に影響を与える |
| **A → A** | 有向 | 属性間の相互作用（ループ可） |
| **V ↔ E** | 無向 | 変数とモノ・環境の関連付け |
| **E ↔ E** | 無向 | モノ同士・環境同士の関連 |

**禁止される接続:** P→任意, V→P, E→P, E→A, V→V, A→V

---

## JSONフォーマット仕様

### 基本構造

```json
{
  "$schema": "pave-network/v1",
  "weight_mode": "discrete_7",
  "nodes": [ ... ],
  "edges": [ ... ]
}
```

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `$schema` | No | バージョン識別子。省略可 |
| `weight_mode` | No | エッジ重みモード。省略時はエディタの現在設定を継承 |
| `nodes` | **Yes** | ノード配列 |
| `edges` | No | エッジ配列。省略時はノードのみインポート |

### ノード定義

```json
{ "label": "ノード名", "layer": "A" }
```

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `label` | **Yes** | ノードの表示名。同一ネットワーク内で一意であること |
| `layer` | **Yes** | 所属レイヤー（下記の値を受け付ける） |
| `subtype` | No | Layer E のみ: `"environment"` を指定すると環境ノードになる。省略時は `"object"` |

**`layer` に指定可能な値:**

| Layer | 受け付ける値（大文字小文字不問） |
|-------|--------------------------------|
| P (性能) | `"P"`, `"performance"`, `"性能"`, `1` |
| A (属性) | `"A"`, `"attribute"`, `"attr"`, `"属性"`, `2` |
| V (変数) | `"V"`, `"variable"`, `"var"`, `"変数"`, `3` |
| E (モノ・環境) | `"E"`, `"entity"`, `"object"`, `"environment"`, `"モノ"`, `"環境"`, `4` |

> **注意:** `id` と `x`, `y` 座標は不要です。IDは自動生成され、座標はインポート後に自動レイアウトされます。

#### 性能ノード（Layer P）について

性能ノードの `label` は、システムに事前登録された性能ツリーの**末端ノード名**と一致する必要があります。以下のマッチング方式で自動照合されます:

1. **完全一致**: `"P1 - 航続距離"` → そのまま一致
2. **プレフィックス一致**: `"P1"` → `"P1 - 航続距離"` に一致
3. **名前部分一致**: `"航続距離"` → `"P1 - 航続距離"` に一致
4. **曖昧一致**: 類似度70%以上で候補提示

一意に特定できない場合はインポート画面で候補から選択できます。

### エッジ定義

```json
{ "from": "始点ノード名", "to": "終点ノード名", "weight": 3 }
```

| フィールド | 必須 | 説明 |
|-----------|------|------|
| `from` | **Yes** | 始点ノードの `label`（`source` もエイリアスとして使用可） |
| `to` | **Yes** | 終点ノードの `label`（`target` もエイリアスとして使用可） |
| `weight` | No | エッジの重み。省略時は `0`。V↔E, E↔E エッジでは無視される |

### 重みモード（weight_mode）

| モード | 有効な重み値 | 用途 |
|--------|------------|------|
| `discrete_3` | -1, 0, +1 | 単純な正/負/無の3段階 |
| `discrete_5` | -3, -1, 0, +1, +3 | 5段階評価 |
| `discrete_7` | -5, -3, -1, 0, +1, +3, +5 | 7段階の詳細評価（デフォルト） |
| `continuous` | -1.0 ~ +1.0 の任意の実数 | 連続値 |

> 指定されたモードの有効値に一致しない重みは、最も近い有効値に自動で丸められます（警告表示あり）。

---

## 完全なJSONサンプル

### サンプル1: 電気自動車の設計案ネットワーク

```json
{
  "weight_mode": "discrete_7",
  "nodes": [
    { "label": "P1 - 航続距離", "layer": "P" },
    { "label": "P2 - 加速性能", "layer": "P" },
    { "label": "空気抵抗係数", "layer": "A" },
    { "label": "車体剛性", "layer": "A" },
    { "label": "バッテリー容量", "layer": "A" },
    { "label": "車体形状", "layer": "V" },
    { "label": "フレーム構造", "layer": "V" },
    { "label": "電池セル数", "layer": "V" },
    { "label": "ボディパネル", "layer": "E" },
    { "label": "フレーム材料", "layer": "E" },
    { "label": "リチウムイオン電池", "layer": "E" },
    { "label": "風環境", "layer": "E", "subtype": "environment" }
  ],
  "edges": [
    { "from": "空気抵抗係数", "to": "P1 - 航続距離", "weight": 3 },
    { "from": "空気抵抗係数", "to": "P2 - 加速性能", "weight": -1 },
    { "from": "バッテリー容量", "to": "P1 - 航続距離", "weight": 5 },
    { "from": "バッテリー容量", "to": "P2 - 加速性能", "weight": -3 },
    { "from": "車体剛性", "to": "P2 - 加速性能", "weight": 1 },
    { "from": "車体形状", "to": "空気抵抗係数", "weight": 5 },
    { "from": "フレーム構造", "to": "車体剛性", "weight": 3 },
    { "from": "電池セル数", "to": "バッテリー容量", "weight": 5 },
    { "from": "車体形状", "to": "ボディパネル" },
    { "from": "フレーム構造", "to": "フレーム材料" },
    { "from": "電池セル数", "to": "リチウムイオン電池" },
    { "from": "車体形状", "to": "風環境" }
  ]
}
```

### サンプル2: 最小構成

```json
{
  "nodes": [
    { "label": "P1 - 航続距離", "layer": "P" },
    { "label": "バッテリー容量", "layer": "A" },
    { "label": "電池セル数", "layer": "V" },
    { "label": "リチウムイオン電池", "layer": "E" }
  ],
  "edges": [
    { "from": "バッテリー容量", "to": "P1 - 航続距離", "weight": 5 },
    { "from": "電池セル数", "to": "バッテリー容量", "weight": 3 },
    { "from": "電池セル数", "to": "リチウムイオン電池" }
  ]
}
```

---

## AI向けプロンプトテンプレート

以下のプロンプトをAIに渡すことで、正しい形式のJSONを生成させることができます。
`{...}` の部分を実際のプロジェクトの情報で置き換えてください。

````
あなたはシステム設計の専門家です。以下の設計案について、PAVEネットワーク構造をJSON形式で作成してください。

## 対象システム
{システムの説明を記載}

## 登録済みの性能（Performance）一覧
以下の性能が登録されています。性能ノードのlabelはこれらの名前に一致させてください。
{性能リストを記載。例:
- P1 - 航続距離
- P2 - 加速性能
- P3 - 車両重量
}

## 設計案の概要
{この設計案の特徴・方針を記載}

## 出力形式

以下のJSON形式で出力してください:

```json
{
  "weight_mode": "discrete_7",
  "nodes": [
    { "label": "性能名", "layer": "P" },
    { "label": "属性名", "layer": "A" },
    { "label": "変数名", "layer": "V" },
    { "label": "モノ名", "layer": "E" },
    { "label": "環境名", "layer": "E", "subtype": "environment" }
  ],
  "edges": [
    { "from": "始点ラベル", "to": "終点ラベル", "weight": 重み値 }
  ]
}
```

### ルール
- **Layer P（性能）**: 上記の登録済み性能名をそのまま使用すること
- **Layer A（属性）**: 性能に影響を与える物理的・設計的な属性
- **Layer V（変数）**: 設計者が操作できる設計パラメータ
- **Layer E（モノ・環境）**: 物理的な構成要素や外部環境条件
- **エッジ方向**: A→P, V→A, A→A のみ有向。V↔E, E↔E は無向（weightなし）
- **重み値**: -5, -3, -1, 0, +1, +3, +5 の7段階（正=促進, 負=抑制）
- 全ての性能ノードに対して、少なくとも1つ以上のA→Pエッジが存在すること
- 全てのAノードに対して、少なくとも1つ以上のV→Aエッジが存在すること
- 全てのVノードに対して、少なくとも1つ以上のV↔Eエッジが存在すること
````

---

## エラー耐性（自動修正される項目）

インポート時に以下の問題は自動的に対処されます。

| 問題 | 対処 |
|------|------|
| `"layer": "Performance"` など大文字表記 | 小文字化して認識 |
| `"layer": "Attr"` などの省略形 | マッピングテーブルで認識 |
| `"source"` / `"target"` を使用 | `"from"` / `"to"` のエイリアスとして認識 |
| `"name"` を使用 | `"label"` のエイリアスとして認識 |
| JSON内のコメント (`// ...`) | パース前に除去 |
| 末尾カンマ (`[1, 2, ]`) | パース前に除去 |
| `{"network": {"nodes": ...}}` のラッパー | 自動アンラップ |
| 離散モードで範囲外の重み値 | 最も近い有効値に丸め（警告表示） |
| 連続モードで ±1 を超える重み | ±1 にクランプ（警告表示） |

---

## インポートモード

| モード | 動作 |
|--------|------|
| **置換** | 既存のネットワーク（性能ノード以外のノード・全エッジ）を削除し、JSONの内容で置き換える |
| **マージ** | 既存ネットワークに追加。同じラベル+レイヤーのノードは既存を再利用 |

---

## よくある質問

**Q: ノードのIDや座標は指定できますか？**
A: 指定しても無視されます。IDは自動生成され、座標はインポート後の自動レイアウトで決まります。

**Q: 同じ名前のノードを複数作れますか？**
A: 同一ラベルのノードは重複として警告が出てスキップされます。ラベルはネットワーク内で一意にしてください。

**Q: エッジの`type`フィールドは必要ですか？**
A: 不要です。自動的に設定されます。

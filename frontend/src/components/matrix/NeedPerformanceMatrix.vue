<template>
  <div class="need-performance-matrix">
    <div class="section-header">
      <h2>çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹</h2>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="matrix-toolbar">
      <button class="toolbar-button template-download-button" @click="downloadTemplateFile">
        <svg width="20" height="20" viewBox="0 0 48 48" class="excel-icon">
          <defs>
            <linearGradient id="toolbar-excel-gradient" x1="5.822" y1="11.568" x2="20.178" y2="36.432" gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="#18884f"/>
              <stop offset=".5" stop-color="#117e43"/>
              <stop offset="1" stop-color="#0b6631"/>
            </linearGradient>
          </defs>
          <path d="M29 23l-17-3v22.167A1.833 1.833 0 0 0 13.833 44h29.334A1.833 1.833 0 0 0 45 42.167V34z" fill="#185c37"/>
          <path d="M29 4H13.833A1.833 1.833 0 0 0 12 5.833V14l17 10 9 3 7-3V14z" fill="#21a366"/>
          <path fill="#107c41" d="M12 14h17v10H12z"/>
          <path d="M24.167 12H12v25h12.167A1.839 1.839 0 0 0 26 35.167V13.833A1.839 1.839 0 0 0 24.167 12z" opacity=".1"/>
          <path d="M23.167 13H12v25h11.167A1.839 1.839 0 0 0 25 36.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
          <path d="M23.167 13H12v23h11.167A1.839 1.839 0 0 0 25 34.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
          <path d="M22.167 13H12v23h10.167A1.839 1.839 0 0 0 24 34.167V14.833A1.839 1.839 0 0 0 22.167 13z" opacity=".2"/>
          <rect x="2" y="13" width="22" height="22" rx="1.833" fill="url(#toolbar-excel-gradient)"/>
          <path d="M7.677 29.958l3.856-5.975L8 18.041h2.842l1.928 3.8c.178.361.3.629.366.806h.025q.19-.432.4-.839l2.061-3.765h2.609l-3.623 5.907 3.715 6.008h-2.776l-2.227-4.171a3.5 3.5 0 0 1-.266-.557h-.033a2.638 2.638 0 0 1-.258.54l-2.293 4.188z" fill="#fff"/>
          <path d="M43.167 4H29v10h16V5.833A1.833 1.833 0 0 0 43.167 4z" fill="#33c481"/>
          <path fill="#107c41" d="M29 24h16v10H29z"/>
        </svg>
        <span>åŠ¹ç”¨é–¢æ•°ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
      </button>
      
      <div class="toolbar-divider"></div>
      
      <button class="toolbar-button matrix-image-button" @click="downloadMatrixAsImageVertical">
        <FontAwesomeIcon :icon="['fas', 'camera']" />
        <span>ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
      </button>
      
      <button class="toolbar-button matrix-excel-button" @click="downloadMatrixAsExcel">
        <svg width="20" height="20" viewBox="0 0 48 48" class="excel-icon">
          <defs>
            <linearGradient id="matrix-excel-gradient" x1="5.822" y1="11.568" x2="20.178" y2="36.432" gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="#18884f"/>
              <stop offset=".5" stop-color="#117e43"/>
              <stop offset="1" stop-color="#0b6631"/>
            </linearGradient>
          </defs>
          <path d="M29 23l-17-3v22.167A1.833 1.833 0 0 0 13.833 44h29.334A1.833 1.833 0 0 0 45 42.167V34z" fill="#185c37"/>
          <path d="M29 4H13.833A1.833 1.833 0 0 0 12 5.833V14l17 10 9 3 7-3V14z" fill="#21a366"/>
          <path fill="#107c41" d="M12 14h17v10H12z"/>
          <path d="M24.167 12H12v25h12.167A1.839 1.839 0 0 0 26 35.167V13.833A1.839 1.839 0 0 0 24.167 12z" opacity=".1"/>
          <path d="M23.167 13H12v25h11.167A1.839 1.839 0 0 0 25 36.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
          <path d="M23.167 13H12v23h11.167A1.839 1.839 0 0 0 25 34.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
          <path d="M22.167 13H12v23h10.167A1.839 1.839 0 0 0 24 34.167V14.833A1.839 1.839 0 0 0 22.167 13z" opacity=".2"/>
          <rect x="2" y="13" width="22" height="22" rx="1.833" fill="url(#matrix-excel-gradient)"/>
          <path d="M7.677 29.958l3.856-5.975L8 18.041h2.842l1.928 3.8c.178.361.3.629.366.806h.025q.19-.432.4-.839l2.061-3.765h2.609l-3.623 5.907 3.715 6.008h-2.776l-2.227-4.171a3.5 3.5 0 0 1-.266-.557h-.033a2.638 2.638 0 0 1-.258.54l-2.293 4.188z" fill="#fff"/>
          <path d="M43.167 4H29v10h16V5.833A1.833 1.833 0 0 0 43.167 4z" fill="#33c481"/>
          <path fill="#107c41" d="M29 24h16v10H29z"/>
        </svg>
        <span>ãƒãƒˆãƒªã‚¯ã‚¹ã‚’Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
      </button>
    </div>

    <!-- çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div v-if="needs.length > 0 && (stakeholders.length > 0 || performances.length > 0)" class="matrix-container">
      <table class="matrix-table">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼: éšå±¤çš„ãªæ€§èƒ½åˆ— -->
        <thead>
          <!-- ç¬¬1è¡Œ: ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <tr>
            <th :rowspan="maxPerformanceLevel + 1" class="corner-cell">ãƒ‹ãƒ¼ã‚º</th>
            <th :colspan="stakeholders.length" class="group-header stakeholder-group">
              ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼
            </th>
            <th :rowspan="maxPerformanceLevel + 1" class="group-header total-votes-header">
              åˆè¨ˆç¥¨æ•°
            </th>
            <th :colspan="getAllPerformanceColumns().length" class="group-header performance-group">
              æ€§èƒ½ï¼ˆéšå±¤è¡¨ç¤ºï¼‰
            </th>
          </tr>
          
          <!-- ç¬¬2è¡Œä»¥é™: éšå±¤çš„ãªæ€§èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼ -->
          <tr v-for="level in maxPerformanceLevel" :key="`level-${level}`">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœ€åˆã®è¡Œã®ã¿ï¼‰ -->
            <template v-if="level === 1">
              <th 
                v-for="stakeholder in stakeholders" 
                :key="stakeholder.id"
                :rowspan="maxPerformanceLevel"
                class="stakeholder-header"
              >
                <div class="stakeholder-header-content">
                  <div class="stakeholder-name-vertical">{{ stakeholder.name }}</div>
                  <div class="stakeholder-votes-horizontal">{{ stakeholder.votes }}ç¥¨</div>
                </div>
              </th>
            </template>
            
            <!-- æ€§èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå„ãƒ¬ãƒ™ãƒ«ï¼‰ -->
            <th
              v-for="cell in getMatrixCellsAtLevel(level)"
              :key="cell.performance.id"
              :colspan="cell.colspan"
              :rowspan="cell.rowspan"
              :class="[
                'performance-header', 
                `level-${level}`, 
                `root-${getRootIndexForPerformance(cell.performance.id) % 8}`,
                { 'is-leaf': cell.performance.is_leaf }
              ]"
            >
              <div class="header-content">
                <span>{{ cell.performance.name }}</span>
                <span v-if="cell.performance.unit" class="unit-text">({{ cell.performance.unit }})</span>
              </div>
            </th>
          </tr>
        </thead>

        <!-- ãƒœãƒ‡ã‚£: ãƒ‹ãƒ¼ã‚ºè¡Œ -->
        <tbody>
          <tr v-for="need in needs" :key="need.id">
            <!-- ãƒ‹ãƒ¼ã‚ºå -->
            <td class="need-header">
              <div class="need-info">
                {{ need.name }}
                <span v-if="need.category" class="category-tag">
                  {{ need.category }}
                </span>
              </div>
            </td>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼Ã—ãƒ‹ãƒ¼ã‚ºã‚»ãƒ« -->
            <td
              v-for="stakeholder in stakeholders"
              :key="`sh-${stakeholder.id}`"
              class="matrix-cell stakeholder-cell"
              :class="{ active: hasStakeholderRelation(stakeholder.id, need.id) }"
              @click="toggleStakeholderRelation(stakeholder.id, need.id)"
            >
              <div class="cell-content">
                <template v-if="hasStakeholderRelation(stakeholder.id, need.id)">
                  {{ getStakeholderVotesForNeed(stakeholder.id, need.id).toFixed(1) }}
                </template>
              </div>
            </td>

            <!-- åˆè¨ˆç¥¨æ•°ã‚»ãƒ« -->
            <td class="matrix-cell total-votes-cell">
              <div class="cell-content total-votes-value">
                {{ getTotalVotesForNeed(need.id).toFixed(1) }}
              </div>
            </td>

            <!-- æ€§èƒ½Ã—ãƒ‹ãƒ¼ã‚ºã‚»ãƒ«ï¼ˆæœ«ç«¯ã®ã¿ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ -->
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`perf-${perf.id}`"
              class="matrix-cell performance-cell"
              :class="[
                getPerformanceRelationClass(need.id, perf.id),
                { 
                  'non-leaf': !perf.is_leaf,
                  'unchecked': isUncheckedCell(need.id, perf.id)
                }
              ]"
              @click="perf.is_leaf ? cyclePerformanceRelation(need.id, perf.id) : null"
            >
              <div class="cell-content">
                <template v-if="perf.is_leaf">
                  <!-- åŠ¹ç”¨é–¢æ•°ãƒœã‚¿ãƒ³ -->
                  <button
                    v-if="getUtilityButtonType(need.id, perf.id) !== 'none'"
                    class="utility-button"
                    :class="`utility-button-${getUtilityButtonType(need.id, perf.id)}`"
                    @click="openUtilityModal(need.id, perf.id, $event)"
                    :title="getUtilityButtonType(need.id, perf.id) === 'warning' ? 'åŠ¹ç”¨é–¢æ•°ã®ç¢ºèªãŒå¿…è¦ã§ã™' : 'åŠ¹ç”¨é–¢æ•°ã‚’è¨­å®š'"
                  >
                    <span v-if="getUtilityButtonType(need.id, perf.id) === 'add'">+</span>
                    <span v-else-if="getUtilityButtonType(need.id, perf.id) === 'check'">âœ“</span>
                    <span v-else-if="getUtilityButtonType(need.id, perf.id) === 'warning'">!</span>
                  </button>
                  
                  <span class="arrow-symbol">{{ getPerformanceRelationSymbol(need.id, perf.id) }}</span>
                  <span v-if="getPerformanceRelation(need.id, perf.id)" class="performance-votes">
                    {{ getPerformanceVotesForNeed(need.id, perf.id).toFixed(1) }}
                  </span>
                </template>
                <template v-else>
                  <span class="non-leaf-indicator">-</span>
                </template>
              </div>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: â†‘ç¥¨æ•° -->
          <tr class="summary-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty"></td>
            <td class="summary-label-cell">â†‘ç¥¨æ•°</td>
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`up-${perf.id}`"
              class="summary-cell"
            >
              <span v-if="perf.is_leaf" class="summary-value">{{ getUpVotesForPerformance(perf.id).toFixed(1) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: â†“ç¥¨æ•° -->
          <tr class="summary-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty"></td>
            <td class="summary-label-cell">â†“ç¥¨æ•°</td>
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`down-${perf.id}`"
              class="summary-cell"
            >
              <span v-if="perf.is_leaf" class="summary-value">{{ getDownVotesForPerformance(perf.id).toFixed(1) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: æœ‰åŠ¹æŠ•ç¥¨æ•° -->
          <tr class="summary-row effective-votes-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty effective-votes-empty"></td>
            <td class="summary-label-cell effective-votes-label">æœ‰åŠ¹æŠ•ç¥¨æ•°</td>
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`effective-${perf.id}`"
              class="summary-cell effective-votes-cell"
            >
              <span v-if="perf.is_leaf" class="summary-value">{{ getEffectiveVotesForPerformance(perf.id).toFixed(1) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: å¤§é …ç›®ã”ã¨ã®æœ‰åŠ¹æŠ•ç¥¨æ•° -->
          <tr class="summary-row root-summary-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty root-summary-empty"></td>
            <td class="summary-label-cell root-summary-label">V</td>
            <td
              v-for="group in rootGroups"
              :key="`root-${group.rootIndex}`"
              :colspan="group.colspan"
              :class="['summary-cell', 'root-summary-cell', `root-cell-${group.rootIndex % 8}`]"
            >
              <span class="root-value">{{ getEffectiveVotesForRoot(group.rootIndex).toFixed(1) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: på€¤ (æœ‰åŠ¹æŠ•ç¥¨æ•° / V) -->
          <tr class="summary-row p-value-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty p-value-empty"></td>
            <td class="summary-label-cell p-value-label">p= Î£v_i / V</td>
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`p-${perf.id}`"
              class="summary-cell p-value-cell"
            >
              <span v-if="perf.is_leaf" class="summary-value">{{ getPValueForPerformance(perf.id).toFixed(3) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: pÂ² -->
          <tr class="summary-row p-squared-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty p-squared-empty"></td>
            <td class="summary-label-cell p-squared-label">pÂ²</td>
            <td
              v-for="perf in getAllPerformanceColumns()"
              :key="`p2-${perf.id}`"
              class="summary-cell p-squared-cell"
              :style="{ backgroundColor: perf.is_leaf ? getColorScaleGreenYellowRed(getPSquaredForPerformance(perf.id), pSquaredMin, pSquaredMax) : '' }"
            >
              <span v-if="perf.is_leaf" class="summary-value">{{ getPSquaredForPerformance(perf.id).toFixed(4) }}</span>
            </td>
          </tr>

          <!-- é›†è¨ˆè¡Œ: HHI (å¤§é …ç›®ã”ã¨ã®Î£pÂ²) -->
          <tr class="summary-row hhi-row">
            <td :colspan="stakeholders.length + 1" class="summary-empty hhi-empty"></td>
            <td class="summary-label-cell hhi-label">HHI = Î£pÂ²</td>
            <td
              v-for="group in rootGroups"
              :key="`hhi-${group.rootIndex}`"
              :colspan="group.colspan"
              class="summary-cell hhi-cell"
              :style="{ backgroundColor: getColorScaleGreenYellowRed(getHHIForRoot(group.rootIndex), hhiMin, hhiMax) }"
            >
              <span class="summary-value hhi-value">{{ getHHIForRoot(group.rootIndex).toFixed(4) }}</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- åˆ†è§£ä¸è¶³ã®æ€§èƒ½åˆ†æï¼ˆãƒãƒˆãƒªã‚¯ã‚¹ã®å¤–ï¼‰ -->
    <DecompositionAnalysis
      :analysis="insufficientDecompositionAnalysis"
      :needsCount="needs.length"
      :hasStakeholdersOrPerformances="stakeholders.length > 0 || performances.length > 0"
      @navigate-to-performance="navigateToPerformanceManagement"
    />

    <!-- åŠ¹ç”¨é–¢æ•°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div v-if="showUtilityModal && currentUtilityEdit" class="modal-overlay" @click="closeUtilityModal">
      <div class="modal-content utility-modal" @click.stop>
        <h3>åŠ¹ç”¨é–¢æ•°è¨­å®š</h3>
        
        <div class="modal-info">
          <div class="info-row">
            <strong>æ€§èƒ½:</strong>
            <span>{{ performances.find(p => p.id === currentUtilityEdit!.performanceId)?.name }}</span>
          </div>
          <div class="info-row">
            <strong>ãƒ‹ãƒ¼ã‚º:</strong>
            <span>{{ needs.find(n => n.id === currentUtilityEdit!.needId)?.name }}</span>
          </div>
          <div class="info-row">
            <strong>æ–¹å‘:</strong>
            <span class="direction-badge">
              {{ getPerformanceRelationSymbol(currentUtilityEdit!.needId, currentUtilityEdit!.performanceId) }}
              {{ getPerformanceRelation(currentUtilityEdit!.needId, currentUtilityEdit!.performanceId)?.direction === 'up' ? 'å‘ä¸Š' : 'æŠ‘åˆ¶' }}
            </span>
          </div>
        </div>

        <div class="graph-section">
          <div class="graph-container">
            <!-- ã‚¤ãƒ³ãƒ•ã‚©ã¨è¨­å®šãƒœã‚¿ãƒ³ -->
            <div class="graph-controls">
              <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³: å¸¸ã«è¡¨ç¤º -->
              <button 
                class="graph-control-button import-button" 
                @click.stop="handleImportExcel"
                title="Excelã‹ã‚‰åŠ¹ç”¨é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                  <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
              </button>
              <!-- ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³: åŠ¹ç”¨é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
              <button 
                v-if="hasUtilityFunction()"
                class="graph-control-button camera-button" 
                @click.stop="handleDownloadGraph"
                title="ã‚°ãƒ©ãƒ•ã‚’ç”»åƒã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
              >
                <FontAwesomeIcon :icon="['fas', 'camera']" />
              </button>
              <!-- ã‚¨ã‚¯ã‚»ãƒ«ãƒœã‚¿ãƒ³: åŠ¹ç”¨é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
              <button 
                v-if="hasUtilityFunction()"
                class="graph-control-button excel-button" 
                @click.stop="handleDownloadExcel"
                title="åŠ¹ç”¨é–¢æ•°ã‚’Excelã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
              >
                <svg width="16" height="16" viewBox="0 0 48 48">
                  <defs>
                    <linearGradient id="excel-gradient" x1="5.822" y1="11.568" x2="20.178" y2="36.432" gradientUnits="userSpaceOnUse">
                      <stop offset="0" stop-color="#18884f"/>
                      <stop offset=".5" stop-color="#117e43"/>
                      <stop offset="1" stop-color="#0b6631"/>
                    </linearGradient>
                  </defs>
                  <path d="M29 23l-17-3v22.167A1.833 1.833 0 0 0 13.833 44h29.334A1.833 1.833 0 0 0 45 42.167V34z" fill="#185c37"/>
                  <path d="M29 4H13.833A1.833 1.833 0 0 0 12 5.833V14l17 10 9 3 7-3V14z" fill="#21a366"/>
                  <path fill="#107c41" d="M12 14h17v10H12z"/>
                  <path d="M24.167 12H12v25h12.167A1.839 1.839 0 0 0 26 35.167V13.833A1.839 1.839 0 0 0 24.167 12z" opacity=".1"/>
                  <path d="M23.167 13H12v25h11.167A1.839 1.839 0 0 0 25 36.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
                  <path d="M23.167 13H12v23h11.167A1.839 1.839 0 0 0 25 34.167V14.833A1.839 1.839 0 0 0 23.167 13z" opacity=".2"/>
                  <path d="M22.167 13H12v23h10.167A1.839 1.839 0 0 0 24 34.167V14.833A1.839 1.839 0 0 0 22.167 13z" opacity=".2"/>
                  <rect x="2" y="13" width="22" height="22" rx="1.833" fill="url(#excel-gradient)"/>
                  <path d="M7.677 29.958l3.856-5.975L8 18.041h2.842l1.928 3.8c.178.361.3.629.366.806h.025q.19-.432.4-.839l2.061-3.765h2.609l-3.623 5.907 3.715 6.008h-2.776l-2.227-4.171a3.5 3.5 0 0 1-.266-.557h-.033a2.638 2.638 0 0 1-.258.54l-2.293 4.188z" fill="#fff"/>
                  <path d="M43.167 4H29v10h16V5.833A1.833 1.833 0 0 0 43.167 4z" fill="#33c481"/>
                  <path fill="#107c41" d="M29 24h16v10H29z"/>
                </svg>
              </button>
              <!-- ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³: åŠ¹ç”¨é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
              <button 
                v-if="hasUtilityFunction()"
                class="graph-control-button copy-button" 
                @click.stop="handleCopyUtilityFunction"
                title="åŠ¹ç”¨é–¢æ•°ã‚’ã‚³ãƒ”ãƒ¼"
              >
                <FontAwesomeIcon :icon="['fas', 'copy']" />
              </button>
              <!-- ãƒšãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³: åŒã˜æ€§èƒ½ã«ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
              <button 
                v-if="canPasteUtilityFunction()"
                class="graph-control-button paste-button" 
                @click.stop="handlePasteUtilityFunction"
                title="åŠ¹ç”¨é–¢æ•°ã‚’è²¼ã‚Šä»˜ã‘"
              >
                <FontAwesomeIcon :icon="['fas', 'paste']" />
              </button>
              <button 
                class="graph-control-button info-button" 
                @click.stop="toggleInfoPopup"
                title="ä½¿ã„æ–¹"
              >
                <FontAwesomeIcon :icon="['fas', 'info-circle']" />
              </button>
              <button 
                class="graph-control-button settings-button" 
                @click.stop="toggleSettingsPopup"
                title="è¨­å®š"
              >
                <FontAwesomeIcon :icon="['fas', 'gear']" />
              </button>
              
              <!-- ã‚¤ãƒ³ãƒ•ã‚©ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
              <div v-if="showInfoPopup" class="graph-popup info-popup" @click.stop>
                <div class="popup-header">
                  <h4>ã‚°ãƒ©ãƒ•ã®ä½¿ã„æ–¹</h4>
                  <button class="popup-close" @click="showInfoPopup = false">Ã—</button>
                </div>
                <div class="popup-content">
                  <p class="info-section-title">ã€é€£ç¶šé–¢æ•°ã€‘</p>
                  <ul class="info-list">
                    <li><strong>ç‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆ:</strong> ã‚°ãƒ©ãƒ•å†…ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li><strong>ç‚¹ã‚’å‰Šé™¤:</strong> ãƒ—ãƒ­ãƒƒãƒˆã—ãŸç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li><strong>ç·šã®è¡¨ç¤º:</strong> 2ç‚¹ä»¥ä¸Šã§è‡ªå‹•çš„ã«çµã°ã‚Œã¾ã™</li>
                    <li><strong>åº§æ¨™ç¢ºèª:</strong> ç‚¹ã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼</li>
                    <li><strong>è»¸ç¯„å›²:</strong> ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´å¯èƒ½</li>
                  </ul>
                  <p class="info-section-title">ã€é›¢æ•£é–¢æ•°ã€‘</p>
                  <ul class="info-list">
                    <li><strong>ç‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆ:</strong> ã‚°ãƒ©ãƒ•å†…ã‚¯ãƒªãƒƒã‚¯ã§æœ€å¯„ã‚Šã®ç‚¹ã®åŠ¹ç”¨å€¤ã‚’æ›´æ–°</li>
                    <li><strong>ç‚¹ã‚’å‰Šé™¤:</strong> ç·‘ã®ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆã¾ãŸã¯ãƒãƒˆãƒªã‚¯ã‚¹ã§è¡Œå‰Šé™¤ï¼‰</li>
                    <li><strong>åº§æ¨™ç¢ºèª:</strong> ç‚¹ã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼</li>
                  </ul>
                  <p class="info-section-title">ã€ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã€‘</p>
                  <ul class="info-list">
                    <li><strong>ã‚³ãƒ”ãƒ¼:</strong> åŠ¹ç”¨é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã€<FontAwesomeIcon :icon="['fas', 'copy']" />ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    <li><strong>ãƒšãƒ¼ã‚¹ãƒˆ:</strong> åŒã˜æ€§èƒ½ã®åˆ¥ã®ãƒ‹ãƒ¼ã‚ºã«ã®ã¿è²¼ã‚Šä»˜ã‘å¯èƒ½ã§ã™</li>
                  </ul>
                </div>
              </div>
              
              <!-- è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
              <div v-if="showSettingsPopup" class="graph-popup settings-popup" @click.stop>
                <div class="popup-header">
                  <h4>ç·šã®è£œå®Œè¨­å®š</h4>
                  <button class="popup-close" @click="showSettingsPopup = false">Ã—</button>
                </div>
                <div class="popup-content">
                  <div class="setting-item">
                    <label class="setting-label">è£œå®Œæ–¹æ³• (é€£ç¶šé–¢æ•°ã®ã¿):</label>
                    <select v-model="interpolationType" class="setting-select" :disabled="currentUtilityEdit?.type === 'discrete'">
                      <option value="linear">ç·šå½¢è£œå®Œ</option>
                      <option value="step">ã‚¹ãƒ†ãƒƒãƒ—è£œå®Œ</option>
                      <option value="smooth">ã‚¹ãƒ ãƒ¼ã‚ºè£œå®Œ</option>
                    </select>
                  </div>
                  <div class="setting-description">
                    <template v-if="currentUtilityEdit?.type === 'discrete'">
                      âš ï¸ é›¢æ•£é–¢æ•°ã§ã¯ç·šã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚å„é›¢æ•£å€¤ã¯ç‹¬ç«‹ã—ãŸç‚¹ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </template>
                    <template v-else-if="interpolationType === 'linear'">
                      ç‚¹ã¨ç‚¹ã‚’ç›´ç·šã§çµã³ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                    </template>
                    <template v-else-if="interpolationType === 'step'">
                      éšæ®µçŠ¶ã«è£œå®Œã—ã¾ã™ï¼ˆæ®µéšçš„ãªå¤‰åŒ–ï¼‰
                    </template>
                    <template v-else-if="interpolationType === 'smooth'">
                      æ›²ç·šã§æ»‘ã‚‰ã‹ã«è£œå®Œã—ã¾ã™
                    </template>
                  </div>
                </div>
              </div>
            </div>
            
            <svg class="utility-graph" viewBox="0 0 420 330" preserveAspectRatio="xMidYMid meet" @click="handleGraphClick">
              <!-- èƒŒæ™¯ -->
              <rect x="50" y="20" width="330" height="260" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1"/>
              
              <!-- ã‚°ãƒªãƒƒãƒ‰ç·šï¼ˆç¸¦ï¼‰ -->
              <line v-for="i in 10" :key="`v-${i}`" 
                :x1="50 + i * 33" :y1="20" 
                :x2="50 + i * 33" :y2="280" 
                stroke="#e9ecef" stroke-width="1"/>
              
              <!-- ã‚°ãƒªãƒƒãƒ‰ç·šï¼ˆæ¨ªï¼‰ -->
              <line v-for="i in 10" :key="`h-${i}`" 
                :x1="50" :y1="20 + i * 26" 
                :x2="380" :y2="20 + i * 26" 
                stroke="#e9ecef" stroke-width="1"/>
              
              <!-- åŸºæº–ç·š: y=0.5 (é»„è‰²) -->
              <line x1="50" :y1="20 + 260 * 0.5" x2="380" :y2="20 + 260 * 0.5" 
                stroke="#fbbf24" stroke-width="2" stroke-dasharray="5,5" opacity="0.7"/>
              
              <!-- åŸºæº–ç·š: y=0.8 (èµ¤) -->
              <line x1="50" :y1="20 + 260 * 0.2" x2="380" :y2="20 + 260 * 0.2" 
                stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5" opacity="0.7"/>
              
              <!-- Yè»¸ -->
              <line x1="50" y1="20" x2="50" y2="280" stroke="#495057" stroke-width="2"/>
              
              <!-- Xè»¸ -->
              <line x1="50" y1="280" x2="380" y2="280" stroke="#495057" stroke-width="2"/>
              
              <!-- ãƒ—ãƒ­ãƒƒãƒˆã•ã‚ŒãŸç‚¹ï¼ˆé€£ç¶šé–¢æ•°ï¼‰ -->
              <g v-if="currentUtilityEdit?.type === 'continuous'" v-for="(point, index) in utilityPoints" :key="`point-${index}`">
                <circle 
                  :cx="point.x" 
                  :cy="point.y" 
                  r="5" 
                  fill="#3b82f6" 
                  stroke="#1e40af" 
                  stroke-width="2"
                  class="utility-point"
                  @click.stop="removePoint(index)"
                  @mouseenter="showTooltip(point, $event)"
                  @mouseleave="hideTooltip"
                  style="cursor: pointer;"
                />
              </g>
              
              <!-- ãƒ—ãƒ­ãƒƒãƒˆã•ã‚ŒãŸç‚¹ï¼ˆé›¢æ•£é–¢æ•°ï¼‰ -->
              <g v-if="currentUtilityEdit?.type === 'discrete'" v-for="(point, index) in discreteGraphPoints" :key="`discrete-${index}`">
                <circle 
                  :cx="point.x" 
                  :cy="point.y" 
                  r="6" 
                  fill="#10b981" 
                  stroke="#059669" 
                  stroke-width="2"
                  class="utility-point discrete-point"
                  @click.stop="removeDiscreteRow(index)"
                  @mouseenter="showDiscreteTooltip(point, index, $event)"
                  @mouseleave="hideTooltip"
                  style="cursor: pointer;"
                />
              </g>
              
              <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
              <g v-if="tooltip.visible" class="custom-tooltip">
                <rect 
                  :x="tooltip.x - 60" 
                  :y="tooltip.y - 28" 
                  width="120" 
                  height="24" 
                  rx="4"
                  fill="#212529" 
                  opacity="0.9"
                />
                <text 
                  :x="tooltip.x" 
                  :y="tooltip.y - 12" 
                  font-size="11" 
                  fill="white" 
                  text-anchor="middle"
                  font-weight="500"
                >
                  {{ tooltip.content }}
                </text>
              </g>
              
              <!-- ãƒ—ãƒ­ãƒƒãƒˆç‚¹ã‚’çµã¶ç·šï¼ˆé€£ç¶šé–¢æ•°ï¼‰ -->
              <polyline 
                v-if="currentUtilityEdit?.type === 'continuous' && utilityPoints.length > 1 && interpolationType !== 'smooth'"
                :points="getPolylinePoints()"
                fill="none"
                stroke="#3b82f6"
                stroke-width="2"
                opacity="0.6"
                :key="`polyline-${utilityPoints.length}-${interpolationType}`"
              />
              
              <!-- ã‚¹ãƒ ãƒ¼ã‚ºè£œå®Œç”¨ã®ãƒ‘ã‚¹ï¼ˆé€£ç¶šé–¢æ•°ï¼‰ -->
              <path
                v-if="currentUtilityEdit?.type === 'continuous' && utilityPoints.length > 1 && interpolationType === 'smooth'"
                :d="getSmoothPath()"
                fill="none"
                stroke="#3b82f6"
                stroke-width="2"
                opacity="0.6"
                :key="`path-${utilityPoints.length}-${interpolationType}`"
              />
              
              <!-- Yè»¸ãƒ©ãƒ™ãƒ« -->
              <text x="25" y="25" font-size="12" fill="#495057" font-weight="600">1.0</text>
              <text x="25" y="153" font-size="12" fill="#495057" font-weight="600">0.5</text>
              <text x="25" y="283" font-size="12" fill="#495057" font-weight="600">0.0</text>
              
              <!-- Yè»¸ã‚¿ã‚¤ãƒˆãƒ« -->
              <text x="15" y="150" font-size="14" fill="#495057" font-weight="600" 
                transform="rotate(-90, 15, 150)">åŠ¹ç”¨å€¤</text>
              
              <!-- Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆé€£ç¶šé–¢æ•°ã®å ´åˆï¼‰ -->
              <template v-if="currentUtilityEdit?.type === 'continuous'">
                <text x="50" y="295" font-size="11" fill="#495057" text-anchor="middle">{{ axisRange.min }}</text>
                <text x="215" y="295" font-size="11" fill="#495057" text-anchor="middle">{{ ((axisRange.min + axisRange.max) / 2).toFixed(2) }}</text>
                <text x="380" y="295" font-size="11" fill="#495057" text-anchor="middle">{{ axisRange.max }}</text>
              </template>
              
              <!-- Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆé›¢æ•£é–¢æ•°ã®å ´åˆï¼‰ -->
              <template v-if="currentUtilityEdit?.type === 'discrete'">
                <g v-for="(row, index) in discreteRows" :key="`label-${index}`">
                  <text 
                    :x="getDiscreteXPosition(index)" 
                    y="295" 
                    font-size="10" 
                    fill="#495057" 
                    text-anchor="middle"
                  >
                    {{ row.label || `#${index + 1}` }}
                  </text>
                </g>
              </template>
              
              <!-- Xè»¸ã‚¿ã‚¤ãƒˆãƒ« -->
              <text x="215" y="310" font-size="14" fill="#495057" font-weight="600" 
                text-anchor="middle">
                {{ getCurrentPerformanceUnit() ? `${performances.find(p => p.id === currentUtilityEdit!.performanceId)?.name} (${getCurrentPerformanceUnit()})` : `${performances.find(p => p.id === currentUtilityEdit!.performanceId)?.name}` }}
              </text>
              
              <!-- åŸºæº–ç·šã®ãƒ©ãƒ™ãƒ« -->
              <text x="385" :y="20 + 260 * 0.5 + 5" font-size="11" fill="#f59e0b" font-weight="600">0.5</text>
              <text x="385" :y="20 + 260 * 0.2 + 5" font-size="11" fill="#dc2626" font-weight="600">0.8</text>
            </svg>
          </div>
          
          <!-- ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ -->
          <div class="type-switcher">
            <span class="type-label">ã‚¿ã‚¤ãƒ—:</span>
            <button 
              class="type-button" 
              :class="{ active: currentUtilityEdit?.type === 'continuous' }"
              @click="switchToType('continuous')"
            >
              <span class="type-icon">{{ currentUtilityEdit?.type === 'continuous' ? 'â—' : 'â—‹' }}</span>
              é€£ç¶š
            </button>
            <button 
              class="type-button" 
              :class="{ active: currentUtilityEdit?.type === 'discrete' }"
              @click="switchToType('discrete')"
            >
              <span class="type-icon">{{ currentUtilityEdit?.type === 'discrete' ? 'â—' : 'â—‹' }}</span>
              é›¢æ•£
            </button>
          </div>
          
          <!-- æ¨ªè»¸ç¯„å›²è¨­å®šï¼ˆé€£ç¶šé–¢æ•°ã®å ´åˆã®ã¿ï¼‰ -->
          <div v-if="currentUtilityEdit?.type === 'continuous'" class="axis-range-control">
            <div class="range-header">
              <span class="range-label">æ¨ªè»¸ç¯„å›²:</span>
              <span class="range-tip">0ä»˜è¿‘ã¯ç´°ã‹ãèª¿æ•´å¯èƒ½</span>
            </div>
            
            <div class="range-single-row">
              <input 
                type="number" 
                v-model.number="axisRange.min" 
                @input="updateRangeFromInput"
                step="any"
                class="range-input"
                placeholder="ä¸‹é™"
              />
              
              <div ref="rangeSliderElement" class="nouislider-container"></div>
              
              <input 
                type="number" 
                v-model.number="axisRange.max" 
                @input="updateRangeFromInput"
                step="any"
                class="range-input"
                placeholder="ä¸Šé™"
              />
            </div>
          </div>
          
          <!-- é›¢æ•£é–¢æ•°ç”¨ã®ãƒãƒˆãƒªã‚¯ã‚¹å…¥åŠ› -->
          <div v-if="currentUtilityEdit?.type === 'discrete'" class="discrete-matrix-control">
            <div class="matrix-header">
              <span class="matrix-label">é›¢æ•£å€¤ãƒãƒˆãƒªã‚¯ã‚¹:</span>
              <button class="add-row-button" @click="addDiscreteRow">
                ï¼‹ è¡Œã‚’è¿½åŠ 
              </button>
            </div>
            
            <div class="discrete-matrix">
              <table class="discrete-table">
                <thead>
                  <tr>
                    <th class="label-column">æ€§èƒ½å€¤ãƒ©ãƒ™ãƒ«</th>
                    <th class="value-column">åŠ¹ç”¨å€¤ (0-1)</th>
                    <th class="action-column"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, index) in discreteRows" :key="index" class="discrete-row">
                    <td class="label-cell">
                      <input 
                        type="text" 
                        v-model="row.label"
                        class="discrete-input label-input"
                        placeholder="ä¾‹: å°ã•ã„"
                      />
                    </td>
                    <td class="value-cell">
                      <input 
                        type="number" 
                        v-model.number="row.value"
                        class="discrete-input value-input"
                        placeholder="0.0 - 1.0"
                        min="0"
                        max="1"
                        step="0.01"
                      />
                    </td>
                    <td class="action-cell">
                      <button 
                        class="remove-row-button"
                        @click="removeDiscreteRow(index)"
                        :disabled="discreteRows.length <= 1"
                      >
                        âœ•
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="matrix-hint">
              ğŸ’¡ åŠ¹ç”¨å€¤ã¯æ‰‹å…¥åŠ›ã›ãšã€ä¸Šã®ã‚°ãƒ©ãƒ•ã§ç‚¹ã‚’ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã‚‚è¨­å®šã§ãã¾ã™
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button 
            v-if="getUtilityButtonType(currentUtilityEdit!.needId, currentUtilityEdit!.performanceId) === 'check' || getUtilityButtonType(currentUtilityEdit!.needId, currentUtilityEdit!.performanceId) === 'warning'"
            class="danger" 
            @click="resetUtilityFunction"
          >
            åˆæœŸåŒ–
          </button>
          <div class="spacer"></div>
          <button class="secondary" @click="closeUtilityModal">
            ä¿å­˜ã›ãšã«çµ‚äº†
          </button>
          <button class="primary" @click="saveUtilityFunction">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- ç©ºçŠ¶æ…‹ -->
    <div v-else-if="!(needs.length > 0 && (stakeholders.length > 0 || performances.length > 0))" class="empty-matrix">
      <p>ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã€ãƒ‹ãƒ¼ã‚ºã€æ€§èƒ½ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, ref, onMounted, nextTick, watch } from 'vue'
import { useProjectStore } from '../../stores/projectStore'
import { storeToRefs } from 'pinia'
import type { Performance } from '../../types/project'
import noUiSlider from 'nouislider'
import 'nouislider/dist/nouislider.css'
import type { target as noUiSliderTarget } from 'nouislider'
import * as XLSX from 'xlsx'
import DecompositionAnalysis from './DecompositionAnalysis.vue'
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'

const emit = defineEmits<{
  navigateToPerformance: []
}>()

// åŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
interface UtilityFunction {
  need_id: string
  performance_id: string
  direction: 'up' | 'down'
  type: 'continuous' | 'discrete' // é€£ç¶š or é›¢æ•£
  axisMin?: number // æ¨ªè»¸ã®ä¸‹é™ï¼ˆé€£ç¶šé–¢æ•°ç”¨ï¼‰
  axisMax?: number // æ¨ªè»¸ã®ä¸Šé™ï¼ˆé€£ç¶šé–¢æ•°ç”¨ï¼‰
  points?: UtilityPoint[] // ãƒ—ãƒ­ãƒƒãƒˆã•ã‚ŒãŸç‚¹
  discreteRows?: DiscreteRow[] // é›¢æ•£é–¢æ•°ã®ãƒãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿
  saved: boolean // ä¿å­˜æ¸ˆã¿ãƒ•ãƒ©ã‚°
  warning: boolean // è­¦å‘ŠçŠ¶æ…‹ãƒ•ãƒ©ã‚°
  archived: boolean // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–çŠ¶æ…‹ãƒ•ãƒ©ã‚°
}

const projectStore = useProjectStore()
const {
  currentProject,
  stakeholders,
  needs,
  performances,
  stakeholderNeedRelations,
  needPerformanceRelations
} = storeToRefs(projectStore)

// åŠ¹ç”¨é–¢æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
const utilityFunctions = ref<UtilityFunction[]>([])

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºçŠ¶æ…‹
const showUtilityModal = ref(false)
const currentUtilityEdit = ref<{
  needId: string
  performanceId: string
  type: 'continuous' | 'discrete'
} | null>(null)

// æ¨ªè»¸ç¯„å›²ã®è¨­å®šï¼ˆé€£ç¶šé–¢æ•°ç”¨ï¼‰
const axisRange = ref({
  min: 0,
  max: 100
})

// noUiSliderç”¨ã®ref
const rangeSliderElement = ref<HTMLElement | null>(null)
let rangeSliderInstance: any = null

// ãƒ—ãƒ­ãƒƒãƒˆã•ã‚ŒãŸç‚¹ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
interface UtilityPoint {
  x: number // SVGåº§æ¨™
  y: number // SVGåº§æ¨™
  valueX: number // å®Ÿéš›ã®Xå€¤ï¼ˆæ€§èƒ½å€¤ï¼‰
  valueY: number // å®Ÿéš›ã®Yå€¤ï¼ˆåŠ¹ç”¨å€¤ 0-1ï¼‰
}

// ç¾åœ¨ç·¨é›†ä¸­ã®åŠ¹ç”¨é–¢æ•°ã®ç‚¹
const utilityPoints = ref<UtilityPoint[]>([])

// é›¢æ•£é–¢æ•°ç”¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
interface DiscreteRow {
  label: string // æ€§èƒ½å€¤ã®ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹: ã€Œå°ã•ã„ã€ï¼‰
  value: number // åŠ¹ç”¨å€¤ (0-1)
}

// é›¢æ•£é–¢æ•°ã®è¡Œãƒ‡ãƒ¼ã‚¿
const discreteRows = ref<DiscreteRow[]>([
  { label: '', value: 0 }
])

// é›¢æ•£é–¢æ•°ã®è¡Œã‚’è¿½åŠ 
function addDiscreteRow() {
  discreteRows.value.push({ label: '', value: 0 })
}

// é›¢æ•£é–¢æ•°ã®è¡Œã‚’å‰Šé™¤
function removeDiscreteRow(index: number) {
  if (discreteRows.value.length > 1) {
    discreteRows.value.splice(index, 1)
  }
}

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºçŠ¶æ…‹
const showInfoPopup = ref(false)
const showSettingsPopup = ref(false)

// ç·šã®è£œå®Œã‚¿ã‚¤ãƒ—
const interpolationType = ref<'linear' | 'step' | 'smooth'>('linear')

// ã‚³ãƒ”ãƒ¼ã—ãŸåŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿
const copiedUtilityFunction = ref<{
  performanceId: string
  type: 'continuous' | 'discrete'
  points: Array<{ x: number; y: number; valueX: number; valueY: number }>
  discreteMapping: Array<{ label: string; value: number }>
  axisRange: { min: number; max: number }
  interpolationType: 'linear' | 'step' | 'smooth'
} | null>(null)

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºç”¨
const tooltip = ref<{
  visible: boolean
  x: number
  y: number
  content: string
}>({
  visible: false,
  x: 0,
  y: 0,
  content: ''
})

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒˆã‚°ãƒ«é–¢æ•°
function toggleInfoPopup() {
  showInfoPopup.value = !showInfoPopup.value
  if (showInfoPopup.value) {
    showSettingsPopup.value = false
  }
}

function toggleSettingsPopup() {
  showSettingsPopup.value = !showSettingsPopup.value
  if (showSettingsPopup.value) {
    showInfoPopup.value = false
  }
}

function handleCopyUtilityFunction() {
  if (!currentUtilityEdit.value) return
  
  // ç¾åœ¨ã®åŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
  copiedUtilityFunction.value = {
    performanceId: currentUtilityEdit.value.performanceId,
    type: currentUtilityEdit.value.type,
    points: [...utilityPoints.value],
    discreteMapping: discreteRows.value.map(row => ({ ...row })),
    axisRange: { ...axisRange.value },
    interpolationType: interpolationType.value
  }
  
}

function handleDownloadGraph() {
  if (!currentUtilityEdit.value) return
  
  // SVGè¦ç´ ã‚’å–å¾—
  const svgElement = document.querySelector('.utility-graph') as SVGElement
  if (!svgElement) return
  
  // SVGã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ
  const svgClone = svgElement.cloneNode(true) as SVGElement
  
  // SVGã‚’æ–‡å­—åˆ—ã«å¤‰æ›
  const svgData = new XMLSerializer().serializeToString(svgClone)
  const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })
  
  // Canvasã‚’ä½œæˆã—ã¦SVGã‚’æç”»
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')
  if (!ctx) return
  
  const img = new Image()
  const url = URL.createObjectURL(svgBlob)
  
  img.onload = () => {
    // é«˜è§£åƒåº¦ã§æç”»
    canvas.width = 1260 // 420 * 3
    canvas.height = 990 // 330 * 3
    
    // ç™½èƒŒæ™¯ã‚’æç”»
    ctx.fillStyle = 'white'
    ctx.fillRect(0, 0, canvas.width, canvas.height)
    
    // SVGã‚’æç”»
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
    
    // PNGã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    canvas.toBlob((blob) => {
      if (!blob) return
      
      const performance = performances.value.find(p => p.id === currentUtilityEdit.value!.performanceId)
      const need = needs.value.find(n => n.id === currentUtilityEdit.value!.needId)
      const filename = `åŠ¹ç”¨é–¢æ•°_${performance?.name || 'performance'}_${need?.name || 'need'}.png`
      
      const link = document.createElement('a')
      link.href = URL.createObjectURL(blob)
      link.download = filename
      link.click()
      
      URL.revokeObjectURL(url)
      URL.revokeObjectURL(link.href)
    }, 'image/png')
  }
  
  img.src = url
}

function handleDownloadExcel() {
  if (!currentUtilityEdit.value) return
  
  const performance = performances.value.find(p => p.id === currentUtilityEdit.value!.performanceId)
  const need = needs.value.find(n => n.id === currentUtilityEdit.value!.needId)
  const relation = getPerformanceRelation(currentUtilityEdit.value.needId, currentUtilityEdit.value.performanceId)
  
  // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆ
  const wb = XLSX.utils.book_new()
  
  // ã€ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã€‘ã‚’ä½œæˆ
  if (currentUtilityEdit.value.type === 'continuous') {
    // é€£ç¶šé–¢æ•°ã®å ´åˆ
    const dataRows: (string | number)[][] = [
      ['é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿'],
      [''],
      ['è£œå®Œæ–¹æ³•', interpolationType.value === 'linear' ? 'ç·šå½¢' : interpolationType.value === 'step' ? 'ã‚¹ãƒ†ãƒƒãƒ—' : 'ã‚¹ãƒ ãƒ¼ã‚º', 'ã€Œç·šå½¢ã€ã€Œã‚¹ãƒ†ãƒƒãƒ—ã€ã€Œã‚¹ãƒ ãƒ¼ã‚ºã€ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'],
      ['è»¸ç¯„å›²ï¼ˆæœ€å°ï¼‰', axisRange.value.min, ''],
      ['è»¸ç¯„å›²ï¼ˆæœ€å¤§ï¼‰', axisRange.value.max, ''],
      [''],
      ['æ€§èƒ½å€¤', 'åŠ¹ç”¨å€¤']
    ]
    
    // ãƒã‚¤ãƒ³ãƒˆã‚’Xå€¤ã§ã‚½ãƒ¼ãƒˆ
    const sortedPoints = [...utilityPoints.value].sort((a, b) => a.valueX - b.valueX)
    
    sortedPoints.forEach(point => {
      dataRows.push([point.valueX, point.valueY])
    })
    
    const ws_data = XLSX.utils.aoa_to_sheet(dataRows)
    
    // åˆ—å¹…ã‚’è¨­å®š
    ws_data['!cols'] = [
      { wch: 20 },
      { wch: 15 },
      { wch: 40 }
    ]
    
    XLSX.utils.book_append_sheet(wb, ws_data, 'é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿')
  } else {
    // é›¢æ•£é–¢æ•°ã®å ´åˆ
    const dataRows: (string | number)[][] = [
      ['é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿'],
      [''],
      ['ãƒ©ãƒ™ãƒ«', 'åŠ¹ç”¨å€¤']
    ]
    
    discreteRows.value.forEach(row => {
      if (row.label !== '' || row.value !== 0) {
        dataRows.push([row.label, row.value])
      }
    })
    
    const ws_data = XLSX.utils.aoa_to_sheet(dataRows)
    
    // åˆ—å¹…ã‚’è¨­å®š
    ws_data['!cols'] = [
      { wch: 20 },
      { wch: 15 }
    ]
    
    XLSX.utils.book_append_sheet(wb, ws_data, 'é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿')
  }
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const filename = `åŠ¹ç”¨é–¢æ•°_${performance?.name || 'performance'}_${need?.name || 'need'}.xlsx`
  XLSX.writeFile(wb, filename)
}

function handleImportExcel() {
  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  const input = document.createElement('input')
  input.type = 'file'
  input.accept = '.xlsx,.xls'
  
  input.onchange = (e: Event) => {
    const target = e.target as HTMLInputElement
    const file = target.files?.[0]
    if (!file) return
    
    const reader = new FileReader()
    reader.onload = (event) => {
      try {
        const data = new Uint8Array(event.target?.result as ArrayBuffer)
        const workbook = XLSX.read(data, { type: 'array' })
        
        // ã‚·ãƒ¼ãƒˆåã‹ã‚‰é–¢æ•°ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
        let functionType: 'continuous' | 'discrete' | null = null
        
        if (workbook.Sheets['é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿']) {
          functionType = 'continuous'
        } else if (workbook.Sheets['é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿']) {
          functionType = 'discrete'
        } else {
          alert('ã‚¨ãƒ©ãƒ¼: ã€Œé€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯ã€Œé›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
          return
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        if (functionType === 'continuous') {
          const dataSheet = workbook.Sheets['é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿']
          if (!dataSheet) {
            alert('ã‚¨ãƒ©ãƒ¼: ã€Œé€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            return
          }
          
          const dataJson = XLSX.utils.sheet_to_json(dataSheet, { header: 1 }) as any[][]
          
          // è£œå®Œæ–¹æ³•ã‚’å–å¾—ï¼ˆB3ã‚»ãƒ« = ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹[2][1]ï¼‰
          const interpolationValue = dataJson[2]?.[1]
          
          let newInterpolationType: 'linear' | 'step' | 'smooth' = 'linear'
          if (typeof interpolationValue === 'string') {
            const normalizedValue = interpolationValue.trim()
            if (normalizedValue === 'ç·šå½¢' || normalizedValue === 'linear') {
              newInterpolationType = 'linear'
            } else if (normalizedValue === 'ã‚¹ãƒ†ãƒƒãƒ—' || normalizedValue === 'step') {
              newInterpolationType = 'step'
            } else if (normalizedValue === 'ã‚¹ãƒ ãƒ¼ã‚º' || normalizedValue === 'smooth') {
              newInterpolationType = 'smooth'
            }
          }
          
          
          // è»¸ç¯„å›²ã‚’å–å¾—
          const minValue = Number(dataJson[3]?.[1])
          const maxValue = Number(dataJson[4]?.[1])
          
          // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ï¼ˆ8è¡Œç›®ä»¥é™ = ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹7ä»¥é™ï¼‰
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€Œæ€§èƒ½å€¤, åŠ¹ç”¨å€¤ã€ã‚’ã‚¹ã‚­ãƒƒãƒ—
          const points: Array<{ x: number; y: number; valueX: number; valueY: number }> = []
          for (let i = 7; i < dataJson.length; i++) {
            const row = dataJson[i]
            if (row && row[0] !== undefined && row[1] !== undefined) {
              const valueX = Number(row[0])
              const valueY = Number(row[1])
              
              // æ•°å€¤ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–ï¼‰
              if (!isNaN(valueX) && !isNaN(valueY)) {
                // SVGåº§æ¨™ã«å¤‰æ›
                const x = 50 + ((valueX - minValue) / (maxValue - minValue)) * 330
                const y = 20 + (1 - valueY) * 260
                
                points.push({ x, y, valueX, valueY })
              }
            }
          }
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ï¼ˆé †åºãŒé‡è¦ï¼‰
          currentUtilityEdit.value!.type = 'continuous'
          axisRange.value = { min: minValue, max: maxValue }
          interpolationType.value = newInterpolationType
          utilityPoints.value = points
          
          
          // æ¬¡ã®ãƒ†ã‚£ãƒƒã‚¯ã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å†åˆæœŸåŒ–ã—ã€ã‚°ãƒ©ãƒ•ã‚’å¼·åˆ¶å†æç”»
          nextTick(() => {
            initRangeSlider()
            // å¼·åˆ¶çš„ã«å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼
            if (utilityPoints.value.length > 0) {
              const temp = [...utilityPoints.value]
              utilityPoints.value = temp
            }
          })
          
          alert(`é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆè£œå®Œæ–¹æ³•: ${newInterpolationType === 'linear' ? 'ç·šå½¢' : newInterpolationType === 'step' ? 'ã‚¹ãƒ†ãƒƒãƒ—' : 'ã‚¹ãƒ ãƒ¼ã‚º'}ï¼‰`)
        } else {
          const dataSheet = workbook.Sheets['é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿']
          if (!dataSheet) {
            alert('ã‚¨ãƒ©ãƒ¼: ã€Œé›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
            return
          }
          
          const dataJson = XLSX.utils.sheet_to_json(dataSheet, { header: 1 }) as any[][]
          
          // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ï¼ˆ4è¡Œç›®ä»¥é™ = ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3ä»¥é™ï¼‰
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€Œãƒ©ãƒ™ãƒ«, åŠ¹ç”¨å€¤ã€ã‚’ã‚¹ã‚­ãƒƒãƒ—
          const rows: Array<{ label: string; value: number }> = []
          for (let i = 3; i < dataJson.length; i++) {
            const row = dataJson[i]
            if (row && row[0] !== undefined && row[1] !== undefined) {
              const value = Number(row[1])
              // åŠ¹ç”¨å€¤ãŒæ•°å€¤ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–ï¼‰
              if (!isNaN(value)) {
                rows.push({
                  label: String(row[0]),
                  value: value
                })
              }
            }
          }
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
          currentUtilityEdit.value!.type = 'discrete'
          discreteRows.value = rows.length > 0 ? rows : [{ label: '', value: 0 }]
          
          alert('é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ')
        }
        
      } catch (error) {
        console.error('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error)
        alert('ã‚¨ãƒ©ãƒ¼: Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    }
    
    reader.readAsArrayBuffer(file)
  }
  
  input.click()
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
function downloadTemplateFile() {
  // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆ
  const wb = XLSX.utils.book_new()
  
  // ã€èª¬æ˜ã‚·ãƒ¼ãƒˆã€‘ã‚’ä½œæˆ
  const instructionsData: (string | number)[][] = [
    ['åŠ¹ç”¨é–¢æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«'],
    [''],
    ['ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€åŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚'],
    ['ä»¥ä¸‹ã®æ‰‹é †ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š'],
    [''],
    ['ã€ä½¿ã„æ–¹ã€‘'],
    ['1. åŠ¹ç”¨é–¢æ•°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒãƒˆãƒªã‚¯ã‚¹ã®æ€§èƒ½Ã—ãƒ‹ãƒ¼ã‚ºã‚»ãƒ«ã§åŠ¹ç”¨é–¢æ•°ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰'],
    ['2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯'],
    ['3. ä½¿ç”¨ã—ãŸã„ã‚·ãƒ¼ãƒˆï¼ˆã€Œé€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯ã€Œé›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ï¼‰ã‚’ç·¨é›†'],
    ['4. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'],
    [''],
    ['ã€æ³¨æ„äº‹é …ã€‘'],
    ['ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ï¼ˆé€£ç¶š/é›¢æ•£ï¼‰ã¯ã€ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒˆåã§è‡ªå‹•åˆ¤å®šã•ã‚Œã¾ã™'],
    ['ãƒ»ã€Œé€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆã‚’ä½¿ã†å ´åˆ: é€£ç¶šé–¢æ•°ã¨ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™'],
    ['ãƒ»ã€Œé›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆã‚’ä½¿ã†å ´åˆ: é›¢æ•£é–¢æ•°ã¨ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™'],
    ['ãƒ»é€£ç¶šé–¢æ•°ã®è£œå®Œæ–¹æ³•ã¯ã€Œç·šå½¢ã€ã€Œã‚¹ãƒ†ãƒƒãƒ—ã€ã€Œã‚¹ãƒ ãƒ¼ã‚ºã€ã®ã„ãšã‚Œã‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„'],
    ['ãƒ»ã‚·ãƒ¼ãƒˆåã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„'],
    ['ãƒ»ä¸¡æ–¹ã®ã‚·ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ãŒå„ªå…ˆã•ã‚Œã¾ã™'],
  ]
  
  const ws_instructions = XLSX.utils.aoa_to_sheet(instructionsData)
  ws_instructions['!cols'] = [{ wch: 90 }]
  XLSX.utils.book_append_sheet(wb, ws_instructions, 'èª¬æ˜')
  
  // ã€é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆè¦‹æœ¬ï¼‰ã€‘ã‚’ä½œæˆ
  const continuousData: (string | number)[][] = [
    ['é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿'],
    [''],
    ['è£œå®Œæ–¹æ³•', 'ç·šå½¢', 'ã€Œç·šå½¢ã€ã€Œã‚¹ãƒ†ãƒƒãƒ—ã€ã€Œã‚¹ãƒ ãƒ¼ã‚ºã€ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'],
    ['è»¸ç¯„å›²ï¼ˆæœ€å°ï¼‰', 0, 'æ€§èƒ½å€¤ã®æœ€å°å€¤ã‚’å…¥åŠ›'],
    ['è»¸ç¯„å›²ï¼ˆæœ€å¤§ï¼‰', 100, 'æ€§èƒ½å€¤ã®æœ€å¤§å€¤ã‚’å…¥åŠ›'],
    [''],
    ['æ€§èƒ½å€¤', 'åŠ¹ç”¨å€¤'],
    [0, 0],
    [25, 0.3],
    [50, 0.6],
    [75, 0.85],
    [100, 1.0],
    [''],
    ['â€» ä¸Šè¨˜ã¯è¦‹æœ¬ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚'],
    ['â€» æ€§èƒ½å€¤ã¨åŠ¹ç”¨å€¤ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'],
    ['â€» åŠ¹ç”¨å€¤ã¯0ã€œ1ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'],
  ]
  
  const ws_continuous = XLSX.utils.aoa_to_sheet(continuousData)
  ws_continuous['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 50 }]
  
  XLSX.utils.book_append_sheet(wb, ws_continuous, 'é€£ç¶šé–¢æ•°ãƒ‡ãƒ¼ã‚¿')
  
  // ã€é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆè¦‹æœ¬ï¼‰ã€‘ã‚’ä½œæˆ
  const discreteData: (string | number)[][] = [
    ['é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿'],
    [''],
    ['ãƒ©ãƒ™ãƒ«', 'åŠ¹ç”¨å€¤'],
    ['ã¨ã¦ã‚‚å°ã•ã„', 0.2],
    ['å°ã•ã„', 0.4],
    ['æ™®é€š', 0.6],
    ['å¤§ãã„', 0.8],
    ['ã¨ã¦ã‚‚å¤§ãã„', 1.0],
    [''],
    ['â€» ä¸Šè¨˜ã¯è¦‹æœ¬ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚'],
    ['â€» ãƒ©ãƒ™ãƒ«ã¯ä»»æ„ã®æ–‡å­—åˆ—ã€åŠ¹ç”¨å€¤ã¯0ã€œ1ã®ç¯„å›²ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'],
  ]
  
  const ws_discrete = XLSX.utils.aoa_to_sheet(discreteData)
  ws_discrete['!cols'] = [{ wch: 20 }, { wch: 15 }]
  XLSX.utils.book_append_sheet(wb, ws_discrete, 'é›¢æ•£é–¢æ•°ãƒ‡ãƒ¼ã‚¿')
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const filename = 'åŠ¹ç”¨é–¢æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.xlsx'
  XLSX.writeFile(wb, filename)
}

// ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç¸¦æ›¸ãå¯¾å¿œç‰ˆï¼‰
async function downloadMatrixAsImageVertical() {
  try {
    const button = document.querySelector('.matrix-image-button span')
    if (button) {
      button.textContent = 'ç”»åƒç”Ÿæˆä¸­...'
    }
    
    // è¤‡æ•°ã®å€™è£œã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ã‚’å–å¾—
    let targetElement: HTMLElement | null = null
    
    // å€™è£œ1: matrix-table ã‚’ç›´æ¥å–å¾—
    const matrixTable = document.querySelector('.matrix-table') as HTMLElement
    if (matrixTable && matrixTable.offsetWidth > 0) {
      targetElement = matrixTable
    }
    
    // å€™è£œ2: matrix-container ã‚’å–å¾—
    if (!targetElement) {
      const matrixContainer = document.querySelector('.matrix-container') as HTMLElement
      if (matrixContainer && matrixContainer.offsetWidth > 0) {
        targetElement = matrixContainer
      }
    }
    
    // å€™è£œ3: tableè¦ç´ ã‚’ç›´æ¥å–å¾—
    if (!targetElement) {
      const tables = document.querySelectorAll('table')
      for (const table of tables) {
        const htmlTable = table as HTMLElement
        if (htmlTable.offsetWidth > 0) {
          targetElement = htmlTable
          break
        }
      }
    }
    
    if (!targetElement) {
      console.error('No valid element found')
      alert('ãƒãƒˆãƒªã‚¯ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
      if (button) button.textContent = 'ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      return
    }
    
    // ç¸¦æ›¸ãè¦ç´ ã‚’å–å¾—ã—ã¦ä¸€æ™‚çš„ã«éè¡¨ç¤ºã«ã™ã‚‹
    const verticalElements = targetElement.querySelectorAll('.performance-header')
    const originalVisibility: { element: HTMLElement; visibility: string; color: string }[] = []

    verticalElements.forEach(el => {
      const htmlEl = el as HTMLElement
      const computedStyle = window.getComputedStyle(htmlEl)
      originalVisibility.push({
        element: htmlEl,
        visibility: computedStyle.visibility,
        color: computedStyle.color
      })
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’é€æ˜ã«ã™ã‚‹ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ä¿æŒï¼‰
      htmlEl.style.color = 'transparent'
    })
    
    // html2canvasã§ç”»åƒåŒ–ï¼ˆç¸¦æ›¸ããƒ†ã‚­ã‚¹ãƒˆã¯é€æ˜ï¼‰
    const html2canvas = (await import('html2canvas')).default as any
    const baseCanvas = await html2canvas(targetElement, {
      scale: 2,
      backgroundColor: '#ffffff',
      logging: false,
      useCORS: true,
      allowTaint: true,
      ignoreElements: (element: HTMLElement) => {
        return element.tagName === 'CANVAS' && element.getAttribute('data-engine')?.includes('three.js')
      }
    })
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…ƒã«æˆ»ã™
    originalVisibility.forEach(({ element, visibility, color }) => {
      element.style.visibility = visibility
      element.style.color = color
    })
    
    
    if (baseCanvas.width === 0 || baseCanvas.height === 0) {
      alert('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚µã‚¤ã‚ºãŒ0ã§ã™ï¼‰')
      if (button) button.textContent = 'ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      return
    }
    
    // æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆã—ã¦ç¸¦æ›¸ããƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
    const finalCanvas = document.createElement('canvas')
    finalCanvas.width = baseCanvas.width
    finalCanvas.height = baseCanvas.height
    const ctx = finalCanvas.getContext('2d')
    
    if (!ctx) {
      alert('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
      if (button) button.textContent = 'ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      return
    }
    
    // ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’æç”»
    ctx.drawImage(baseCanvas, 0, 0)
    
    // æ€§èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¸¦æ›¸ãã§å†æç”»
    const tableRect = targetElement.getBoundingClientRect()
    const scrollLeft = targetElement.scrollLeft || 0
    const scrollTop = targetElement.scrollTop || 0
    
    verticalElements.forEach(el => {
      const htmlEl = el as HTMLElement
      const rect = htmlEl.getBoundingClientRect()
      const computedStyle = window.getComputedStyle(htmlEl)
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—ï¼ˆscaleè€ƒæ…®ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è£œæ­£ï¼‰
      const x = (rect.left - tableRect.left + scrollLeft) * 2
      const y = (rect.top - tableRect.top + scrollTop) * 2
      const width = rect.width * 2
      const height = rect.height * 2
      
      
      // å…ƒã®èƒŒæ™¯è‰²ã‚’å–å¾—ã—ã¦æç”»
      const bgColor = computedStyle.backgroundColor
      ctx.fillStyle = bgColor
      ctx.fillRect(x, y, width, height)
      
      // ã‚»ãƒ«ã®å¢ƒç•Œç·šã‚’å†æç”»ï¼ˆé€šå¸¸ã®å¢ƒç•Œç·šï¼‰
      ctx.strokeStyle = '#dee2e6'
      ctx.lineWidth = 1
      ctx.strokeRect(x, y, width, height)
      
      // æœ«ç«¯æ€§èƒ½ï¼ˆis-leafï¼‰ã®å ´åˆã¯å¤ªã„è‰²ä»˜ãå¢ƒç•Œç·šã‚’è¿½åŠ 
      if (htmlEl.classList.contains('is-leaf')) {
        const borderColor = computedStyle.borderTopColor || computedStyle.borderColor
        ctx.strokeStyle = borderColor
        ctx.lineWidth = 4
        ctx.strokeRect(x + 2, y + 2, width - 4, height - 4)
      }
      
      // ç¸¦æ›¸ããƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
      const text = htmlEl.textContent?.trim() || ''
      if (text) {
        drawVerticalText(ctx, text, x, y, width, height)
      }
    })
    
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    finalCanvas.toBlob((blob: Blob | null) => {
      if (!blob) {
        alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ')
        return
      }
      
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹_${new Date().toISOString().slice(0, 10)}.png`
      link.click()
      URL.revokeObjectURL(url)
      
    }, 'image/png', 0.95)
    
    if (button) {
      button.textContent = 'ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
    }
    
  } catch (error) {
    console.error('ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error)
    alert(`ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error}`)
    
    const button = document.querySelector('.matrix-image-button span')
    if (button) {
      button.textContent = 'ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
    }
  }
}

// ç¸¦æ›¸ããƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function drawVerticalText(
  ctx: CanvasRenderingContext2D,
  text: string,
  x: number,
  y: number,
  width: number,
  height: number
) {
  // ã‚»ãƒ«ã®ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´
  const maxFontSize = 28
  const minFontSize = 16
  const size = Math.max(minFontSize, Math.min(maxFontSize, width * 0.6))
  const kerning = 0.7 // æ–‡å­—é–“éš”
  
  // ã‚µãƒ–ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
  const subCanvas = document.createElement('canvas')
  const subCtx = subCanvas.getContext('2d')
  if (!subCtx) return
  
  // ãƒ†ã‚­ã‚¹ãƒˆã®å®Ÿéš›ã®é«˜ã•ã‚’è¨ˆç®—
  const textHeight = size * kerning * text.length + (size * (1 - kerning))
  
  // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ãƒ«å†…ã«ä¸­å¤®é…ç½®
  const startX = x + (width - size) / 2
  const startY = y + Math.max(8, (height - textHeight) / 2)
  
  ;[...text].forEach((char, i) => {
    subCanvas.width = subCanvas.height = size * 2
    subCtx.clearRect(0, 0, subCanvas.width, subCanvas.height)
    subCtx.textAlign = 'center'
    subCtx.textBaseline = 'middle'
    subCtx.font = `bold ${size}px sans-serif`
    subCtx.fillStyle = '#495057'
    
    // ã€Œãƒ¼ã€ã¯90åº¦å›è»¢
    if (char === 'ãƒ¼') {
      subCtx.translate(size, size)
      subCtx.rotate(90 * Math.PI / 180)
      subCtx.translate(-size, -size)
    }
    
    subCtx.fillText(char, size, size)
    
    // å›è»¢ã‚’æˆ»ã™
    if (char === 'ãƒ¼') {
      subCtx.translate(size, size)
      subCtx.rotate(-90 * Math.PI / 180)
      subCtx.translate(-size, -size)
    }
    
    // ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
    ctx.drawImage(subCanvas, startX, startY + size * kerning * i, size, size)
  })
}

// ãƒãƒˆãƒªã‚¯ã‚¹ã‚’Excelã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
function downloadMatrixAsExcel() {
  // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ä½œæˆ
  const wb = XLSX.utils.book_new()
  
  // ãƒãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
  const matrixData: (string | number)[][] = []
  
  // éšå±¤çš„ãªæ€§èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
  const perfColumns = getAllPerformanceColumns()
  
  // ç¬¬1è¡Œ: ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼
  const headerRow1: (string | number)[] = ['ãƒ‹ãƒ¼ã‚º']
  stakeholders.value.forEach(() => headerRow1.push(''))
  headerRow1.push('åˆè¨ˆç¥¨æ•°')
  perfColumns.forEach(() => headerRow1.push(''))
  matrixData.push(headerRow1)
  
  // ç¬¬2è¡Œä»¥é™: éšå±¤çš„ãªæ€§èƒ½ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒãƒˆãƒªã‚¯ã‚¹ã¨åŒã˜æ§‹é€ ï¼‰
  for (let level = 1; level <= maxPerformanceLevel.value; level++) {
    const levelRow: (string | number)[] = []
    
    // æœ€åˆã®åˆ—ï¼ˆãƒ‹ãƒ¼ã‚ºåˆ—ï¼‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼åˆ—ã¯ç©º
    if (level === 1) {
      levelRow.push('') // ãƒ‹ãƒ¼ã‚ºåˆ—
      stakeholders.value.forEach(sh => levelRow.push(`${sh.name} (${sh.votes}ç¥¨)`))
      levelRow.push('') // åˆè¨ˆç¥¨æ•°åˆ—
    } else {
      levelRow.push('')
      stakeholders.value.forEach(() => levelRow.push(''))
      levelRow.push('')
    }
    
    // æ€§èƒ½ã®éšå±¤ãƒ˜ãƒƒãƒ€ãƒ¼
    const cellsAtLevel = getMatrixCellsAtLevel(level)
    cellsAtLevel.forEach(cell => {
      const displayName = cell.performance.unit 
        ? `${cell.performance.name} (${cell.performance.unit})` 
        : cell.performance.name
      levelRow.push(displayName)
      
      // colspanãŒã‚ã‚‹å ´åˆã¯ç©ºã‚»ãƒ«ã‚’è¿½åŠ 
      for (let i = 1; i < cell.colspan; i++) {
        levelRow.push('')
      }
    })
    
    matrixData.push(levelRow)
  }
  
  // ãƒ‡ãƒ¼ã‚¿è¡Œ: å„ãƒ‹ãƒ¼ã‚º
  needs.value.forEach(need => {
    const row: (string | number)[] = [need.name]
    
    // ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼Ã—ãƒ‹ãƒ¼ã‚º
    stakeholders.value.forEach(sh => {
      const votes = getStakeholderVotesForNeed(sh.id, need.id)
      row.push(hasStakeholderRelation(sh.id, need.id) ? votes.toFixed(1) : '')
    })
    
    // åˆè¨ˆç¥¨æ•°
    row.push(getTotalVotesForNeed(need.id).toFixed(1))
    
    // æ€§èƒ½Ã—ãƒ‹ãƒ¼ã‚º
    perfColumns.forEach(perf => {
      if (perf.is_leaf) {
        const symbol = getPerformanceRelationSymbol(need.id, perf.id)
        const votes = getPerformanceVotesForNeed(need.id, perf.id)
        row.push(symbol ? `${symbol} ${votes.toFixed(1)}` : '')
      } else {
        row.push('-')
      }
    })
    
    matrixData.push(row)
  })
  
  // é›†è¨ˆè¡Œ: â†‘ç¥¨æ•°
  const upVotesRow: (string | number)[] = ['â†‘ç¥¨æ•°']
  stakeholders.value.forEach(() => upVotesRow.push(''))
  upVotesRow.push('')
  perfColumns.forEach(perf => {
    upVotesRow.push(perf.is_leaf ? getUpVotesForPerformance(perf.id).toFixed(1) : '')
  })
  matrixData.push(upVotesRow)
  
  // é›†è¨ˆè¡Œ: â†“ç¥¨æ•°
  const downVotesRow: (string | number)[] = ['â†“ç¥¨æ•°']
  stakeholders.value.forEach(() => downVotesRow.push(''))
  downVotesRow.push('')
  perfColumns.forEach(perf => {
    downVotesRow.push(perf.is_leaf ? getDownVotesForPerformance(perf.id).toFixed(1) : '')
  })
  matrixData.push(downVotesRow)
  
  // é›†è¨ˆè¡Œ: æœ‰åŠ¹æŠ•ç¥¨æ•°
  const effectiveVotesRow: (string | number)[] = ['æœ‰åŠ¹æŠ•ç¥¨æ•°']
  stakeholders.value.forEach(() => effectiveVotesRow.push(''))
  effectiveVotesRow.push('')
  perfColumns.forEach(perf => {
    effectiveVotesRow.push(perf.is_leaf ? getEffectiveVotesForPerformance(perf.id).toFixed(1) : '')
  })
  matrixData.push(effectiveVotesRow)
  
  // é›†è¨ˆè¡Œ: på€¤
  const pValueRow: (string | number)[] = ['p= Î£v_i / V']
  stakeholders.value.forEach(() => pValueRow.push(''))
  pValueRow.push('')
  perfColumns.forEach(perf => {
    pValueRow.push(perf.is_leaf ? getPValueForPerformance(perf.id).toFixed(4) : '')
  })
  matrixData.push(pValueRow)
  
  // é›†è¨ˆè¡Œ: pÂ²
  const pSquaredRow: (string | number)[] = ['pÂ²']
  stakeholders.value.forEach(() => pSquaredRow.push(''))
  pSquaredRow.push('')
  perfColumns.forEach(perf => {
    pSquaredRow.push(perf.is_leaf ? getPSquaredForPerformance(perf.id).toFixed(4) : '')
  })
  matrixData.push(pSquaredRow)
  
  // ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
  const ws = XLSX.utils.aoa_to_sheet(matrixData)
  
  // åˆ—å¹…ã‚’è‡ªå‹•èª¿æ•´
  const columnWidths = matrixData[0].map((_, colIndex) => {
    const maxLength = Math.max(
      ...matrixData.map(row => {
        const cell = row[colIndex]
        return cell ? String(cell).length : 0
      })
    )
    return { wch: Math.min(maxLength + 2, 30) }
  })
  ws['!cols'] = columnWidths
  
  XLSX.utils.book_append_sheet(wb, ws, 'çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹')
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const filename = `çµ±åˆãƒãƒˆãƒªã‚¯ã‚¹_${new Date().toISOString().slice(0, 10)}.xlsx`
  XLSX.writeFile(wb, filename)
}


function handlePasteUtilityFunction() {
  if (!currentUtilityEdit.value || !copiedUtilityFunction.value) return
  
  // åŒã˜æ€§èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  if (currentUtilityEdit.value.performanceId !== copiedUtilityFunction.value.performanceId) {
    console.warn('ç•°ãªã‚‹æ€§èƒ½ã«ã¯è²¼ã‚Šä»˜ã‘ã§ãã¾ã›ã‚“')
    return
  }
  
  // ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘
  currentUtilityEdit.value.type = copiedUtilityFunction.value.type
  utilityPoints.value = copiedUtilityFunction.value.points.map(p => ({ ...p }))
  discreteRows.value = copiedUtilityFunction.value.discreteMapping.map(row => ({ ...row }))
  axisRange.value = { ...copiedUtilityFunction.value.axisRange }
  interpolationType.value = copiedUtilityFunction.value.interpolationType
  
  // é€£ç¶šé–¢æ•°ã®å ´åˆã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å†åˆæœŸåŒ–
  if (currentUtilityEdit.value.type === 'continuous') {
    nextTick(() => {
      initRangeSlider()
    })
  }
  
}

// åŠ¹ç”¨é–¢æ•°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
function hasUtilityFunction(): boolean {
  if (!currentUtilityEdit.value) return false
  
  if (currentUtilityEdit.value.type === 'continuous') {
    return utilityPoints.value.length > 0
  } else {
    return discreteRows.value.some(row => row.label !== '' || row.value !== 0)
  }
}

// ãƒšãƒ¼ã‚¹ãƒˆå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
function canPasteUtilityFunction(): boolean {
  if (!currentUtilityEdit.value || !copiedUtilityFunction.value) return false
  return currentUtilityEdit.value.performanceId === copiedUtilityFunction.value.performanceId
}

// ã‚°ãƒ©ãƒ•ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
function handleGraphClick(event: MouseEvent) {
  const svg = event.currentTarget as SVGElement
  const rect = svg.getBoundingClientRect()
  
  // SVGåº§æ¨™ç³»ã«å¤‰æ›
  const svgX = ((event.clientX - rect.left) / rect.width) * 420
  const svgY = ((event.clientY - rect.top) / rect.height) * 330
  
  // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆx: 50-380, y: 20-280ï¼‰
  if (svgX < 50 || svgX > 380 || svgY < 20 || svgY > 280) {
    return
  }
  
  if (currentUtilityEdit.value?.type === 'continuous') {
    // é€£ç¶šé–¢æ•°ã®å ´åˆ
    const valueX = ((svgX - 50) / 330) * (axisRange.value.max - axisRange.value.min) + axisRange.value.min
    const valueY = 1 - ((svgY - 20) / 260) // Yè»¸ã¯ä¸ŠãŒ1ã€ä¸‹ãŒ0
    
    // ç‚¹ã‚’è¿½åŠ ï¼ˆXå€¤ã§ã‚½ãƒ¼ãƒˆï¼‰
    utilityPoints.value.push({
      x: svgX,
      y: svgY,
      valueX: valueX,
      valueY: Math.max(0, Math.min(1, valueY)) // 0-1ã«ã‚¯ãƒ©ãƒ³ãƒ—
    })
    
    // Xå€¤ã§ã‚½ãƒ¼ãƒˆ
    utilityPoints.value.sort((a, b) => a.valueX - b.valueX)
  } else {
    // é›¢æ•£é–¢æ•°ã®å ´åˆã¯æœ€ã‚‚è¿‘ã„é›¢æ•£å€¤ã‚’ç‰¹å®š
    if (discreteRows.value.length === 0) return
    
    let closestIndex = 0
    let minDistance = Infinity
    
    for (let i = 0; i < discreteRows.value.length; i++) {
      const x = getDiscreteXPosition(i)
      const distance = Math.abs(x - svgX)
      if (distance < minDistance) {
        minDistance = distance
        closestIndex = i
      }
    }
    
    // åŠ¹ç”¨å€¤ã‚’æ›´æ–°
    const valueY = 1 - ((svgY - 20) / 260)
    discreteRows.value[closestIndex].value = Math.max(0, Math.min(1, valueY))
  }
}

// é›¢æ•£é–¢æ•°ç”¨: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰Xåº§æ¨™ã‚’è¨ˆç®—
function getDiscreteXPosition(index: number): number {
  if (discreteRows.value.length <= 1) {
    return 215 // ä¸­å¤®
  }
  const spacing = 330 / (discreteRows.value.length - 1)
  return 50 + index * spacing
}

// é›¢æ•£é–¢æ•°ã®ç‚¹ã‚’ã‚°ãƒ©ãƒ•ç”¨ã«å¤‰æ›
const discreteGraphPoints = computed(() => {
  if (currentUtilityEdit.value?.type !== 'discrete') return []
  
  return discreteRows.value.map((row, index) => ({
    x: getDiscreteXPosition(index),
    y: 20 + (1 - row.value) * 260,
    valueX: index,
    valueY: row.value,
    label: row.label
  }))
})

// ç‚¹ã‚’å‰Šé™¤
function removePoint(index: number) {
  utilityPoints.value.splice(index, 1)
}

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
function showTooltip(point: UtilityPoint, event: MouseEvent) {
  const target = event.currentTarget as SVGElement
  const svg = target.closest('svg')
  if (!svg) return
  
  const rect = svg.getBoundingClientRect()
  
  tooltip.value = {
    visible: true,
    x: event.clientX - rect.left,
    y: event.clientY - rect.top - 10,
    content: `X: ${point.valueX.toFixed(2)}, Y: ${point.valueY.toFixed(3)}`
  }
}

// é›¢æ•£é–¢æ•°ç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
function showDiscreteTooltip(point: any, index: number, event: MouseEvent) {
  const target = event.currentTarget as SVGElement
  const svg = target.closest('svg')
  if (!svg) return
  
  const rect = svg.getBoundingClientRect()
  
  tooltip.value = {
    visible: true,
    x: event.clientX - rect.left,
    y: event.clientY - rect.top - 10,
    content: `${point.label || '#' + (index + 1)}: ${point.valueY.toFixed(3)}`
  }
}

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—éè¡¨ç¤º
function hideTooltip() {
  tooltip.value.visible = false
}

// ãƒãƒªãƒ©ã‚¤ãƒ³ã®ãƒã‚¤ãƒ³ãƒˆæ–‡å­—åˆ—ã‚’å–å¾—
function getPolylinePoints(): string {
  if (utilityPoints.value.length < 2) return ''
  
  if (interpolationType.value === 'linear') {
    // ç·šå½¢è£œå®Œ: å˜ç´”ã«ç‚¹ã‚’çµã¶
    return utilityPoints.value.map(p => `${p.x},${p.y}`).join(' ')
  } else if (interpolationType.value === 'step') {
    // ã‚¹ãƒ†ãƒƒãƒ—è£œå®Œ: éšæ®µçŠ¶ã«
    const points: string[] = []
    for (let i = 0; i < utilityPoints.value.length; i++) {
      const current = utilityPoints.value[i]
      points.push(`${current.x},${current.y}`)
      
      if (i < utilityPoints.value.length - 1) {
        const next = utilityPoints.value[i + 1]
        // æ°´å¹³ç·šã‚’è¿½åŠ 
        points.push(`${next.x},${current.y}`)
      }
    }
    return points.join(' ')
  } else {
    // smooth: ç·šå½¢ã§ã„ã£ãŸã‚“è¿”ã™ï¼ˆå¾Œã§pathã«å¤‰æ›´äºˆå®šï¼‰
    return utilityPoints.value.map(p => `${p.x},${p.y}`).join(' ')
  }
}

// ã‚¹ãƒ ãƒ¼ã‚ºè£œå®Œç”¨ã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆï¼ˆCatmull-Rom ã‚¹ãƒ—ãƒ©ã‚¤ãƒ³ï¼‰
function getSmoothPath(): string {
  if (utilityPoints.value.length < 2) return ''
  
  const points = utilityPoints.value
  if (points.length === 2) {
    // 2ç‚¹ã®å ´åˆã¯ç›´ç·š
    return `M ${points[0].x},${points[0].y} L ${points[1].x},${points[1].y}`
  }
  
  // Catmull-Romã‚¹ãƒ—ãƒ©ã‚¤ãƒ³ã§æ»‘ã‚‰ã‹ãªæ›²ç·šã‚’ç”Ÿæˆ
  let path = `M ${points[0].x},${points[0].y}`
  
  for (let i = 0; i < points.length - 1; i++) {
    const p0 = points[Math.max(0, i - 1)]
    const p1 = points[i]
    const p2 = points[i + 1]
    const p3 = points[Math.min(points.length - 1, i + 2)]
    
    // åˆ¶å¾¡ç‚¹ã‚’è¨ˆç®—
    const cp1x = p1.x + (p2.x - p0.x) / 6
    const cp1y = p1.y + (p2.y - p0.y) / 6
    const cp2x = p2.x - (p3.x - p1.x) / 6
    const cp2y = p2.y - (p3.y - p1.y) / 6
    
    path += ` C ${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`
  }
  
  return path
}

// å¯¾æ•°çš„ã‚¹ã‚±ãƒ¼ãƒ«ã®å¤‰æ›é–¢æ•°
function sliderToValue(sliderPos: number): number {
  // sliderPos: -100 ~ 100
  const absPos = Math.abs(sliderPos)
  const sign = sliderPos >= 0 ? 1 : -1
  
  if (absPos <= 20) return sign * absPos * 0.1 // 0-20: 0.1åˆ»ã¿
  if (absPos <= 40) return sign * (2 + (absPos - 20)) // 21-40: 1åˆ»ã¿
  if (absPos <= 60) return sign * (22 + (absPos - 40) * 5) // 41-60: 5åˆ»ã¿
  if (absPos <= 80) return sign * (122 + (absPos - 60) * 50) // 61-80: 50åˆ»ã¿
  return sign * (1122 + (absPos - 80) * 500) // 81-100: 500åˆ»ã¿
}

function valueToSlider(value: number): number {
  const absValue = Math.abs(value)
  const sign = value >= 0 ? 1 : -1
  
  if (absValue <= 2) return sign * Math.round(absValue / 0.1)
  if (absValue <= 22) return sign * (20 + Math.round(absValue - 2))
  if (absValue <= 122) return sign * (40 + Math.round((absValue - 22) / 5))
  if (absValue <= 1122) return sign * (60 + Math.round((absValue - 122) / 50))
  return sign * (80 + Math.round((absValue - 1122) / 500))
}

// noUiSliderã®åˆæœŸåŒ–
function initRangeSlider() {
  if (!rangeSliderElement.value) {
    console.warn('rangeSliderElement is not available')
    return
  }
  
  // æ—¢å­˜ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒã‚ã‚Œã°ç ´æ£„
  if (rangeSliderInstance) {
    try {
      rangeSliderInstance.destroy()
    } catch (e) {
      console.warn('Failed to destroy existing slider:', e)
    }
    rangeSliderInstance = null
  }
  
  const minSliderPos = valueToSlider(axisRange.value.min)
  const maxSliderPos = valueToSlider(axisRange.value.max)
  
  try {
    rangeSliderInstance = noUiSlider.create(rangeSliderElement.value, {
      start: [minSliderPos, maxSliderPos],
      connect: true,
      range: {
        'min': -100,
        'max': 100
      },
      step: 1,
      tooltips: [
        { to: (value) => sliderToValue(value).toFixed(2) },
        { to: (value) => sliderToValue(value).toFixed(2) }
      ]
    })
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    rangeSliderInstance.on('update', (values: any) => {
      const [minPos, maxPos] = values.map(Number)
      axisRange.value.min = sliderToValue(minPos)
      axisRange.value.max = sliderToValue(maxPos)
      updatePointCoordinates()
    })
  } catch (e) {
    console.error('Failed to create noUiSlider:', e)
  }
}

// è»¸ç¯„å›²ãŒå¤‰ã‚ã£ãŸã¨ãã«ãƒã‚¤ãƒ³ãƒˆã®SVGåº§æ¨™ã‚’æ›´æ–°
function updatePointCoordinates() {
  utilityPoints.value = utilityPoints.value.map(p => {
    const x = 50 + ((p.valueX - axisRange.value.min) / (axisRange.value.max - axisRange.value.min)) * 330
    const y = 20 + (1 - p.valueY) * 260
    return {
      x: Math.max(50, Math.min(380, x)), // ã‚°ãƒ©ãƒ•ç¯„å›²å†…ã«ã‚¯ãƒ©ãƒ³ãƒ—
      y,
      valueX: p.valueX,
      valueY: p.valueY
    }
  })
}

// ç›´æ¥å…¥åŠ›æ™‚ã®å‡¦ç†
function updateRangeFromInput() {
  // ä¸‹é™ãŒä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
  if (axisRange.value.min >= axisRange.value.max) {
    axisRange.value.min = axisRange.value.max - 0.01
  }
  
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
  if (rangeSliderInstance) {
    const minSliderPos = valueToSlider(axisRange.value.min)
    const maxSliderPos = valueToSlider(axisRange.value.max)
    rangeSliderInstance.set([minSliderPos, maxSliderPos])
  }
  
  // ãƒã‚¤ãƒ³ãƒˆã®åº§æ¨™ã‚‚æ›´æ–°
  updatePointCoordinates()
}

// ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
function switchToType(type: 'continuous' | 'discrete') {
  if (!currentUtilityEdit.value) return
  
  currentUtilityEdit.value.type = type
  
  // é€£ç¶šé–¢æ•°ã«åˆ‡ã‚Šæ›¿ãˆãŸå ´åˆã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å†åˆæœŸåŒ–
  if (type === 'continuous') {
    nextTick(() => {
      initRangeSlider()
    })
  }
}

// æœ‰åŠ¹ãªæ€§èƒ½IDã®ã‚»ãƒƒãƒˆ
const validPerformanceIds = computed(() => {
  return new Set(performances.value.map(p => p.id))
})

// å­˜åœ¨ã™ã‚‹æ€§èƒ½ã¸ã®é–¢ä¿‚ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const validNeedPerformanceRelations = computed(() => {
  return needPerformanceRelations.value.filter(r => 
    validPerformanceIds.value.has(r.performance_id)
  )
})

// æœ€å¤§éšå±¤ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
const maxPerformanceLevel = computed(() => {
  if (performances.value.length === 0) return 0
  return Math.max(...performances.value.map(p => p.level)) + 1
})

// ãƒã‚§ãƒƒã‚¯ãŒ1ã¤ã‚‚ã¤ã„ã¦ã„ãªã„ãƒ‹ãƒ¼ã‚ºï¼ˆè¡Œï¼‰ã‚’åˆ¤å®š
const uncheckedNeedIds = computed(() => {
  // æœ«ç«¯æ€§èƒ½ã®IDã‚»ãƒƒãƒˆã‚’ä½œæˆ
  const leafPerformanceIds = new Set(
    performances.value.filter(p => p.is_leaf).map(p => p.id)
  )
  
  const checkedNeedIds = new Set<string>()
  // æœ«ç«¯æ€§èƒ½ã¸ã®é–¢ä¿‚ã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  validNeedPerformanceRelations.value.forEach(r => {
    if (leafPerformanceIds.has(r.performance_id)) {
      checkedNeedIds.add(r.need_id)
    }
  })
  
  return new Set(needs.value.filter(n => !checkedNeedIds.has(n.id)).map(n => n.id))
})

// ãƒã‚§ãƒƒã‚¯ãŒ1ã¤ã‚‚ã¤ã„ã¦ã„ãªã„æ€§èƒ½ï¼ˆåˆ—ï¼‰ã‚’åˆ¤å®š
const uncheckedPerformanceIds = computed(() => {
  // æœ«ç«¯æ€§èƒ½ã®IDã‚»ãƒƒãƒˆã‚’ä½œæˆ
  const leafPerformanceIds = new Set(
    performances.value.filter(p => p.is_leaf).map(p => p.id)
  )
  
  const checkedPerformanceIds = new Set<string>()
  // æœ«ç«¯æ€§èƒ½ã¸ã®é–¢ä¿‚ã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  validNeedPerformanceRelations.value.forEach(r => {
    if (leafPerformanceIds.has(r.performance_id)) {
      checkedPerformanceIds.add(r.performance_id)
    }
  })
  
  return new Set(
    performances.value
      .filter(p => p.is_leaf && !checkedPerformanceIds.has(p.id))
      .map(p => p.id)
  )
})

// ãƒãƒˆãƒªã‚¯ã‚¹ã‚»ãƒ«æƒ…å ±
interface MatrixCell {
  performance: Performance
  colspan: number
  rowspan: number
  isVisible: boolean  // ã“ã®ã‚»ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆcolspanã§å¸åã•ã‚Œã‚‹å ´åˆã¯falseï¼‰
}

// ãƒãƒˆãƒªã‚¯ã‚¹ç”¨ã®2æ¬¡å…ƒé…åˆ—ã‚’ç”Ÿæˆ
const performanceMatrix = computed(() => {
  if (performances.value.length === 0) return []
  
  const maxLevel = maxPerformanceLevel.value
  const matrix: MatrixCell[][] = []
  
  // å„ãƒ¬ãƒ™ãƒ«ã®è¡Œã‚’åˆæœŸåŒ–
  for (let i = 0; i < maxLevel; i++) {
    matrix.push([])
  }
  
  // æœ«ç«¯æ€§èƒ½ã®åˆ—æ•°ã‚’è¨ˆç®—
  function countLeafColumns(perf: Performance): number {
    if (perf.is_leaf) return 1
    const children = performances.value.filter(p => p.parent_id === perf.id)
    if (children.length === 0) return 1
    return children.reduce((sum, child) => sum + countLeafColumns(child), 0)
  }
  
  // æ·±ã•å„ªå…ˆæ¢ç´¢ã§ãƒãƒˆãƒªã‚¯ã‚¹ã‚’æ§‹ç¯‰
  function buildMatrix(perf: Performance, level: number) {
    const leafCount = countLeafColumns(perf)
    const children = performances.value.filter(p => p.parent_id === perf.id)
    
    // æœ«ç«¯æ€§èƒ½ã®å ´åˆã¯ã€æ®‹ã‚Šã®éšå±¤åˆ†rowspanã‚’è¨­å®š
    const rowspan = perf.is_leaf ? (maxLevel - level) : 1
    
    // ã“ã®ã‚»ãƒ«ã‚’ç¾åœ¨ã®è¡Œã«è¿½åŠ 
    matrix[level].push({
      performance: perf,
      colspan: leafCount,
      rowspan: rowspan,
      isVisible: true
    })
    
    // å­è¦ç´ ãŒã‚ã‚‹å ´åˆã¯å†å¸°çš„ã«å‡¦ç†
    if (children.length > 0) {
      children.forEach(child => buildMatrix(child, level + 1))
    }
  }
  
  // ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã‹ã‚‰é–‹å§‹
  const roots = performances.value.filter(p => !p.parent_id || p.parent_id === null)
  roots.forEach(root => buildMatrix(root, 0))
  
  return matrix
})

// æŒ‡å®šãƒ¬ãƒ™ãƒ«ã®ãƒãƒˆãƒªã‚¯ã‚¹ã‚»ãƒ«ã‚’å–å¾—
function getMatrixCellsAtLevel(level: number): MatrixCell[] {
  if (level < 1 || level > performanceMatrix.value.length) return []
  return performanceMatrix.value[level - 1]
}

// å…¨æ€§èƒ½ã‚’åˆ—ã®é †ç•ªã§å–å¾—ï¼ˆæœ«ç«¯ã®ã¿ã€å·¦ã‹ã‚‰å³ã®é †åºï¼‰
function getAllPerformanceColumns(): Performance[] {
  const result: Performance[] = []
  
  // æ·±ã•å„ªå…ˆæ¢ç´¢ã§æœ«ç«¯æ€§èƒ½ã‚’å·¦ã‹ã‚‰å³ã®é †ã«åé›†ï¼ˆé…åˆ—é †åºã‚’ä¿æŒï¼‰
  function collectLeaves(parentId: string | null | undefined) {
    // é…åˆ—é †åºã‚’ä¿æŒã™ã‚‹ãŸã‚ã€filterã—ãŸé †åºãã®ã¾ã¾
    const children = performances.value.filter(p => p.parent_id === parentId)
    
    for (const child of children) {
      if (child.is_leaf) {
        result.push(child)
      } else {
        // è¦ªæ€§èƒ½ã®å ´åˆã¯å­ã‚’æ¢ç´¢
        collectLeaves(child.id)
      }
    }
  }
  
  // ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã‹ã‚‰é–‹å§‹
  collectLeaves(null)
  collectLeaves(undefined)
  
  return result
}

// æ€§èƒ½ãŒå±ã™ã‚‹å¤§é …ç›®(ãƒ«ãƒ¼ãƒˆ)ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
function getRootIndexForPerformance(performanceId: string): number {
  // ãƒ«ãƒ¼ãƒˆæ€§èƒ½ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
  const roots = performances.value.filter(p => !p.parent_id || p.parent_id === null)
  
  // ã“ã®æ€§èƒ½ã®ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹
  function findRoot(perf: Performance): Performance {
    if (!perf.parent_id) return perf
    const parent = performances.value.find(p => p.id === perf.parent_id)
    if (!parent) return perf
    return findRoot(parent)
  }
  
  const performance = performances.value.find(p => p.id === performanceId)
  if (!performance) return 0
  
  const root = findRoot(performance)
  const index = roots.findIndex(r => r.id === root.id)
  return index >= 0 ? index : 0
}

// å¤§é …ç›®ã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
interface RootGroup {
  rootIndex: number
  rootPerformance: Performance
  leafPerformances: Performance[]
  colspan: number
}

const rootGroups = computed((): RootGroup[] => {
  const roots = performances.value.filter(p => !p.parent_id || p.parent_id === null)
  const allLeafPerformances = getAllPerformanceColumns()
  
  return roots.map((root, index) => {
    // ã“ã®ãƒ«ãƒ¼ãƒˆã«å±ã™ã‚‹æœ«ç«¯æ€§èƒ½ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const leafPerformances = allLeafPerformances.filter(
      leaf => getRootIndexForPerformance(leaf.id) === index
    )
    
    return {
      rootIndex: index,
      rootPerformance: root,
      leafPerformances: leafPerformances,
      colspan: leafPerformances.length
    }
  })
})

// å¤§é …ç›®ã”ã¨ã®æœ‰åŠ¹æŠ•ç¥¨æ•°ã‚’è¨ˆç®—
function getEffectiveVotesForRoot(rootIndex: number): number {
  const group = rootGroups.value.find(g => g.rootIndex === rootIndex)
  if (!group) return 0
  
  let total = 0
  group.leafPerformances.forEach(perf => {
    total += getEffectiveVotesForPerformance(perf.id)
  })
  
  return total
}

// på€¤ã‚’è¨ˆç®—: æ€§èƒ½ã®æœ‰åŠ¹æŠ•ç¥¨æ•° / å¤§é …ç›®ã®æœ‰åŠ¹æŠ•ç¥¨æ•°(V)
function getPValueForPerformance(performanceId: string): number {
  const rootIndex = getRootIndexForPerformance(performanceId)
  const V = getEffectiveVotesForRoot(rootIndex)
  
  if (V === 0) return 0
  
  const effectiveVotes = getEffectiveVotesForPerformance(performanceId)
  return effectiveVotes / V
}

// pÂ²ã‚’è¨ˆç®—
function getPSquaredForPerformance(performanceId: string): number {
  const p = getPValueForPerformance(performanceId)
  return p * p
}

// HHI (Herfindahl-Hirschman Index) ã‚’è¨ˆç®—: å¤§é …ç›®ã”ã¨ã®Î£pÂ²
function getHHIForRoot(rootIndex: number): number {
  const group = rootGroups.value.find(g => g.rootIndex === rootIndex)
  if (!group) return 0
  
  let sum = 0
  group.leafPerformances.forEach(perf => {
    sum += getPSquaredForPerformance(perf.id)
  })
  
  return sum
}

// pÂ²è¡Œã®å…¨å€¤ã‚’å–å¾—ã—ã¦ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ã®ç¯„å›²ã‚’è¨ˆç®—
const pSquaredValues = computed(() => {
  return getAllPerformanceColumns().map(perf => getPSquaredForPerformance(perf.id))
})

const pSquaredMin = computed(() => Math.min(...pSquaredValues.value.filter(v => v > 0)))
const pSquaredMax = computed(() => Math.max(...pSquaredValues.value))

// HHIè¡Œã®å…¨å€¤ã‚’å–å¾—ã—ã¦ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ã®ç¯„å›²ã‚’è¨ˆç®—
const hhiValues = computed(() => {
  return rootGroups.value.map(group => getHHIForRoot(group.rootIndex))
})

const hhiMin = computed(() => Math.min(...hhiValues.value.filter(v => v > 0)))
const hhiMax = computed(() => Math.max(...hhiValues.value))

// Vè¡Œã®å…¨å€¤ã‚’å–å¾—ã—ã¦ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ã®ç¯„å›²ã‚’è¨ˆç®—
const vMin = computed(() => Math.min(...hhiValues.value.filter(v => v > 0)))
const vMax = computed(() => Math.max(...hhiValues.value))

// ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«: æ·¡ã„é’ã‹ã‚‰æ·¡ã„ãƒ”ãƒ³ã‚¯ (pÂ²ã¨HHIç”¨)
function getColorScale(value: number, min: number, max: number): string {
  if (value === 0 || max === min) return 'rgb(255, 255, 255)'
  
  const normalized = (value - min) / (max - min)
  
  // æ·¡ã„é’(173, 216, 230) ã‹ã‚‰ ç™½(255, 255, 255) ã‚’çµŒç”±ã—ã¦ æ·¡ã„ãƒ”ãƒ³ã‚¯(255, 182, 193) ã¸
  let r, g, b
  if (normalized > 0.5) {
    // 0.5-1.0: ç™½ã‹ã‚‰æ·¡ã„ãƒ”ãƒ³ã‚¯
    const t = (normalized - 0.5) * 2
    r = 255
    g = Math.round(255 - 73 * t)  // 255 â†’ 182
    b = Math.round(255 - 62 * t)  // 255 â†’ 193
  } else {
    // 0.0-0.5: æ·¡ã„é’ã‹ã‚‰ç™½
    const t = normalized * 2
    r = Math.round(173 + 82 * t)  // 173 â†’ 255
    g = Math.round(216 + 39 * t)  // 216 â†’ 255
    b = Math.round(230 + 25 * t)  // 230 â†’ 255
  }
  
  return `rgb(${r}, ${g}, ${b})`
}

// ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«: ç·‘ã‹ã‚‰é»„ã‚’çµŒç”±ã—ã¦èµ¤ (Vè¡Œç”¨)
function getColorScaleGreenYellowRed(value: number, min: number, max: number): string {
  if (value === 0 || max === min) return 'rgb(255, 255, 255)'
  
  const normalized = (value - min) / (max - min)
  
  // ç·‘(99, 190, 123) ã‹ã‚‰ é»„(255, 235, 59) ã‚’çµŒç”±ã—ã¦ èµ¤(231, 114, 111) ã¸
  let r, g, b
  if (normalized > 0.5) {
    // 0.5-1.0: é»„ã‹ã‚‰èµ¤
    const t = (normalized - 0.5) * 2
    r = Math.round(255 - 24 * t)   // 255 â†’ 231
    g = Math.round(235 - 121 * t)  // 235 â†’ 114
    b = Math.round(59 - 52 * (1 - t) * t + 52)  // 59 â†’ 111
  } else {
    // 0.0-0.5: ç·‘ã‹ã‚‰é»„
    const t = normalized * 2
    r = Math.round(99 + 156 * t)   // 99 â†’ 255
    g = Math.round(190 + 45 * t)   // 190 â†’ 235
    b = Math.round(123 - 64 * t)   // 123 â†’ 59
  }
  
  return `rgb(${r}, ${g}, ${b})`
}

// ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼Ã—ãƒ‹ãƒ¼ã‚ºé–¢ä¿‚
function hasStakeholderRelation(stakeholderId: string, needId: string): boolean {
  return stakeholderNeedRelations.value.some(
    r => r.stakeholder_id === stakeholderId && r.need_id === needId
  )
}

// ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãã®ãƒ‹ãƒ¼ã‚ºã«å¯¾ã—ã¦æŒã¤ç¥¨æ•°ã‚’è¨ˆç®—
function getStakeholderVotesForNeed(stakeholderId: string, needId: string): number {
  // é–¢ä¿‚ãŒãªã„å ´åˆã¯0
  if (!hasStakeholderRelation(stakeholderId, needId)) {
    return 0
  }
  
  // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã®ç·ç¥¨æ•°ã‚’å–å¾—
  const stakeholder = stakeholders.value.find(s => s.id === stakeholderId)
  if (!stakeholder) return 0
  
  // ã“ã®ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ãŒé–¢å¿ƒã‚’æŒã¤ãƒ‹ãƒ¼ã‚ºã®æ•°ã‚’è¨ˆç®—
  const relatedNeedsCount = stakeholderNeedRelations.value.filter(
    r => r.stakeholder_id === stakeholderId
  ).length
  
  if (relatedNeedsCount === 0) return 0
  
  // ç·ç¥¨æ•°ã‚’é–¢å¿ƒã®ã‚ã‚‹ãƒ‹ãƒ¼ã‚ºæ•°ã§æŒ‰åˆ†
  return stakeholder.votes / relatedNeedsCount
}

// ãƒ‹ãƒ¼ã‚ºã”ã¨ã®åˆè¨ˆç¥¨æ•°ã‚’è¨ˆç®—
function getTotalVotesForNeed(needId: string): number {
  let total = 0
  
  // å…¨ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã«ã¤ã„ã¦ã€ã“ã®ãƒ‹ãƒ¼ã‚ºã¸ã®ç¥¨æ•°ã‚’åˆè¨ˆ
  stakeholders.value.forEach(stakeholder => {
    total += getStakeholderVotesForNeed(stakeholder.id, needId)
  })
  
  return total
}

// ãƒ‹ãƒ¼ã‚ºã«å¯¾ã™ã‚‹æ€§èƒ½ã®æŒ‰åˆ†ç¥¨æ•°ã‚’è¨ˆç®—
function getPerformanceVotesForNeed(needId: string, performanceId: string): number {
  // ã“ã®æ€§èƒ½ã¨ãƒ‹ãƒ¼ã‚ºã®é–¢ä¿‚ãŒãªã„å ´åˆã¯0
  const relation = getPerformanceRelation(needId, performanceId)
  if (!relation) return 0
  
  // ã“ã®ãƒ‹ãƒ¼ã‚ºã®åˆè¨ˆç¥¨æ•°
  const totalVotes = getTotalVotesForNeed(needId)
  if (totalVotes === 0) return 0
  
  // ã“ã®ãƒ‹ãƒ¼ã‚ºã«é–¢é€£ã™ã‚‹æœ«ç«¯æ€§èƒ½ï¼ˆâ†‘ã¨â†“ã®ã¿ã€ç©ºç™½ã¯é™¤ãï¼‰ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const leafPerformanceIds = new Set(performances.value.filter(p => p.is_leaf).map(p => p.id))
  const relatedPerformancesCount = validNeedPerformanceRelations.value.filter(
    r => r.need_id === needId && leafPerformanceIds.has(r.performance_id)
  ).length
  
  if (relatedPerformancesCount === 0) return 0
  
  // åˆè¨ˆç¥¨æ•°ã‚’é–¢é€£æ€§èƒ½æ•°ã§æŒ‰åˆ†
  return totalVotes / relatedPerformancesCount
}

// æ€§èƒ½åˆ—ã”ã¨ã®â†‘ç¥¨æ•°ã‚’é›†è¨ˆ
function getUpVotesForPerformance(performanceId: string): number {
  let total = 0
  
  validNeedPerformanceRelations.value.forEach(relation => {
    if (relation.performance_id === performanceId && relation.direction === 'up') {
      total += getPerformanceVotesForNeed(relation.need_id, performanceId)
    }
  })
  
  return total
}

// æ€§èƒ½åˆ—ã”ã¨ã®â†“ç¥¨æ•°ã‚’é›†è¨ˆ
function getDownVotesForPerformance(performanceId: string): number {
  let total = 0
  
  validNeedPerformanceRelations.value.forEach(relation => {
    if (relation.performance_id === performanceId && relation.direction === 'down') {
      total += getPerformanceVotesForNeed(relation.need_id, performanceId)
    }
  })
  
  return total
}

// Shannon ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã‚’è¨ˆç®—
function calculateEntropy(x: number): number {
  if (x === 0 || x === 1) return 0
  return -x * Math.log2(x) - (1 - x) * Math.log2(1 - x)
}

// æœ‰åŠ¹æŠ•ç¥¨æ•°ã‚’è¨ˆç®—: I(a,b) = (a+b) * {1 + H(x)} where x = a/(a+b)
function getEffectiveVotesForPerformance(performanceId: string): number {
  const upVotes = getUpVotesForPerformance(performanceId)
  const downVotes = getDownVotesForPerformance(performanceId)
  const total = upVotes + downVotes
  
  if (total === 0) return 0
  
  const x = upVotes / total
  const entropy = calculateEntropy(x)
  
  return total * (1 + entropy)
}

async function toggleStakeholderRelation(stakeholderId: string, needId: string) {
  if (hasStakeholderRelation(stakeholderId, needId)) {
    await projectStore.removeStakeholderNeedRelation(stakeholderId, needId)
  } else {
    await projectStore.addStakeholderNeedRelation(stakeholderId, needId)
  }
}

// æ€§èƒ½Ã—ãƒ‹ãƒ¼ã‚ºé–¢ä¿‚ï¼ˆå­˜åœ¨ã™ã‚‹æ€§èƒ½ã®ã¿ï¼‰
function getPerformanceRelation(needId: string, performanceId: string) {
  return validNeedPerformanceRelations.value.find(
    r => r.need_id === needId && r.performance_id === performanceId
  )
}

function getPerformanceRelationSymbol(needId: string, performanceId: string): string {
  const relation = getPerformanceRelation(needId, performanceId)
  if (!relation) return ''
  return relation.direction === 'up' ? 'â†‘' : 'â†“'
}

function getPerformanceRelationClass(needId: string, performanceId: string): string {
  const relation = getPerformanceRelation(needId, performanceId)
  if (!relation) return ''
  return relation.direction === 'up' ? 'direction-up' : 'direction-down'
}

function isUncheckedCell(needId: string, performanceId: string): boolean {
  // ãã®è¡Œ(ãƒ‹ãƒ¼ã‚º)OR åˆ—(æ€§èƒ½)ã®ã©ã¡ã‚‰ã‹ã«1ã¤ã‚‚ãƒã‚§ãƒƒã‚¯ãŒãªã„å ´åˆã«é»„è‰²
  return uncheckedNeedIds.value.has(needId) || uncheckedPerformanceIds.value.has(performanceId)
}

async function cyclePerformanceRelation(needId: string, performanceId: string) {
  const relation = getPerformanceRelation(needId, performanceId)
  const utility = getUtilityFunction(needId, performanceId)
  
  if (!relation) {
    // é–¢ä¿‚ãŒãªã„ â†’ â†‘ã‚’è¿½åŠ 
    await projectStore.addNeedPerformanceRelation(needId, performanceId, 'up')
    
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸåŠ¹ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è­¦å‘ŠçŠ¶æ…‹ã§å¾©å…ƒ
    const archived = utilityFunctions.value.find(
      u => u.need_id === needId && u.performance_id === performanceId && u.archived
    )
    if (archived) {
      archived.archived = false
      archived.warning = true
      archived.direction = 'up'
    }
  } else if (relation.direction === 'up') {
    // â†‘ â†’ â†“ã«æ›´æ–°
    await projectStore.updateNeedPerformanceRelation(needId, performanceId, 'down')
    
    // ä¿å­˜æ¸ˆã¿ã®åŠ¹ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è­¦å‘ŠçŠ¶æ…‹ã«
    if (utility && utility.saved) {
      utility.warning = true
      utility.direction = 'down'
    }
  } else {
    // â†“ â†’ å‰Šé™¤
    await projectStore.removeNeedPerformanceRelation(needId, performanceId)
    
    // ä¿å­˜æ¸ˆã¿ã®åŠ¹ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
    if (utility && utility.saved) {
      utility.archived = true
      utility.warning = false
    }
  }
}

function navigateToPerformanceManagement() {
  emit('navigateToPerformance')
}

// åŠ¹ç”¨é–¢æ•°ç®¡ç†
function getUtilityFunction(needId: string, performanceId: string): UtilityFunction | undefined {
  const result = utilityFunctions.value.find(
    u => u.need_id === needId && u.performance_id === performanceId && !u.archived
  )
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã¯å‰Šé™¤ï¼ˆæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸãŸã‚ï¼‰
  // if (!result && utilityFunctions.value.length > 0) {
  //   // [NeedPerformanceMatrix] åŠ¹ç”¨é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {
  //     æ¢ã—ã¦ã„ã‚‹need_id: needId,
  //     æ¢ã—ã¦ã„ã‚‹performance_id: performanceId,
  //     åˆ©ç”¨å¯èƒ½ãªåŠ¹ç”¨é–¢æ•°æ•°: utilityFunctions.value.length,
  //     æœ€åˆã®åŠ¹ç”¨é–¢æ•°: utilityFunctions.value[0]
  //   })
  // }
  
  return result
}

function getUtilityButtonType(needId: string, performanceId: string): 'none' | 'add' | 'check' | 'warning' {
  const relation = getPerformanceRelation(needId, performanceId)
  if (!relation) return 'none'
  
  const utility = getUtilityFunction(needId, performanceId)
  if (!utility) return 'add'
  
  if (utility.warning) return 'warning'
  if (utility.saved) return 'check'
  return 'add'
}

async function openUtilityModal(needId: string, performanceId: string, event: Event) {
  event.stopPropagation() // ã‚»ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­¢ã‚ã‚‹
  
  const buttonType = getUtilityButtonType(needId, performanceId)
  if (buttonType === 'none') return
  
  // åŒã˜æ€§èƒ½åˆ—ã®ä»–ã®ã‚»ãƒ«ã«æ—¢ã«è¨­å®šãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆåˆ—åŸºæº–ã‚’å–å¾—ï¼‰
  const sameColumnFunctions = utilityFunctions.value.filter(
    u => u.performance_id === performanceId && u.saved
  )
  
  // åˆ—åŸºæº–ã¨ãªã‚‹åŠ¹ç”¨é–¢æ•°ï¼ˆæœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ï¼‰
  const columnStandard = sameColumnFunctions.length > 0 ? sameColumnFunctions[0] : null
  
  // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©¦ã™
  let utility = getUtilityFunction(needId, performanceId)
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãªã„å ´åˆã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
  if (!utility) {
    try {
      const loadedUtility = await projectStore.getUtilityFunction(needId, performanceId)
      if (loadedUtility) {
        utility = loadedUtility
        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚è¿½åŠ 
        utilityFunctions.value.push(loadedUtility)
      }
    } catch (error) {
      console.error('åŠ¹ç”¨é–¢æ•°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
    }
  }
  
  // åˆ—åŸºæº–ãŒã‚ã‚‹å ´åˆã¯ã€type/è»¸ç¯„å›²/é›¢æ•£å€¤ã‚’å¼·åˆ¶çš„ã«åˆã‚ã›ã‚‹
  const effectiveType = columnStandard?.type || utility?.type || 'continuous'
  
  currentUtilityEdit.value = {
    needId,
    performanceId,
    type: effectiveType
  }
  
  // æ¨ªè»¸ç¯„å›²ã®åˆæœŸåŒ–
  if (effectiveType === 'continuous') {
    if (columnStandard?.axisMin !== undefined && columnStandard?.axisMax !== undefined) {
      // åˆ—åŸºæº–ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
      axisRange.value = {
        min: columnStandard.axisMin,
        max: columnStandard.axisMax
      }
    } else if (utility?.axisMin !== undefined && utility?.axisMax !== undefined) {
      axisRange.value = {
        min: utility.axisMin,
        max: utility.axisMax
      }
    } else {
      axisRange.value = {
        min: 0,
        max: 100
      }
    }
  }
  
  // æ—¢å­˜ã®ç‚¹ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆpointsè‡ªä½“ã¯å€‹åˆ¥ã ãŒã€è»¸ç¯„å›²ã¯çµ±ä¸€ï¼‰
  if (utility?.points && utility.points.length > 0) {
    utilityPoints.value = utility.points.map(p => {
      const x = 50 + ((p.valueX - axisRange.value.min) / (axisRange.value.max - axisRange.value.min)) * 330
      const y = 20 + (1 - p.valueY) * 260
      return {
        x,
        y,
        valueX: p.valueX,
        valueY: p.valueY
      }
    })
  } else {
    utilityPoints.value = []
  }
  
  // é›¢æ•£é–¢æ•°ã®è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
  if (effectiveType === 'discrete') {
    if (columnStandard?.discreteRows && columnStandard.discreteRows.length > 0) {
      // åˆ—åŸºæº–ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼ˆé¸æŠè‚¢ã¯çµ±ä¸€ã€å€¤ã¯å€‹åˆ¥ï¼‰
      const standardLabels = columnStandard.discreteRows.map(r => r.label)
      
      if (utility?.discreteRows && utility.discreteRows.length > 0) {
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ãƒ©ãƒ™ãƒ«ã¯åˆ—åŸºæº–ã«åˆã‚ã›ã€å€¤ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ç”¨
        discreteRows.value = standardLabels.map(label => {
          const existing = utility.discreteRows?.find(r => r.label === label)
          return {
            label,
            value: existing?.value ?? 0
          }
        })
      } else {
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€åˆ—åŸºæº–ã®ãƒ©ãƒ™ãƒ«ã§å€¤0ã§åˆæœŸåŒ–
        discreteRows.value = standardLabels.map(label => ({
          label,
          value: 0
        }))
      }
    } else if (utility?.discreteRows && utility.discreteRows.length > 0) {
      discreteRows.value = [...utility.discreteRows]
    } else {
      discreteRows.value = [{ label: '', value: 0 }]
    }
  }
  
  showUtilityModal.value = true
  
  // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
  document.body.style.overflow = 'hidden'
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒDOMã«è¿½åŠ ã•ã‚ŒãŸå¾Œã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
  nextTick(() => {
    if (currentUtilityEdit.value?.type === 'continuous') {
      initRangeSlider()
    }
  })
}

function closeUtilityModal() {
  showUtilityModal.value = false
  currentUtilityEdit.value = null
  utilityPoints.value = []
  discreteRows.value = [{ label: '', value: 0 }]
  
  // èƒŒæ™¯ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–
  document.body.style.overflow = ''
}

async function saveUtilityFunction() {
  if (!currentUtilityEdit.value) return
  
  const { needId, performanceId } = currentUtilityEdit.value
  const relation = getPerformanceRelation(needId, performanceId)
  if (!relation) return
  
  // åŒã˜æ€§èƒ½åˆ—ã®å…¨ã¦ã®é–¢ä¿‚ã‚’å–å¾—
  const sameColumnRelations = currentProject.value?.need_performance_relations.filter(
    r => r.performance_id === performanceId
  ) || []
  
  // ä¿å­˜ã™ã‚‹åŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const utilityData: UtilityFunction = {
    need_id: needId,
    performance_id: performanceId,
    direction: relation.direction,
    type: currentUtilityEdit.value.type,
    axisMin: currentUtilityEdit.value.type === 'continuous' ? axisRange.value.min : undefined,
    axisMax: currentUtilityEdit.value.type === 'continuous' ? axisRange.value.max : undefined,
    points: currentUtilityEdit.value.type === 'continuous' ? [...utilityPoints.value] : [],
    discreteRows: currentUtilityEdit.value.type === 'discrete' ? [...discreteRows.value] : undefined,
    saved: true,
    warning: false,
    archived: false
  }
  
  try {
    // ç¾åœ¨ã®ã‚»ãƒ«ã®åŠ¹ç”¨é–¢æ•°ã‚’ä¿å­˜
    await projectStore.saveUtilityFunction(needId, performanceId, utilityData)
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const existingIndex = utilityFunctions.value.findIndex(
      u => u.need_id === needId && u.performance_id === performanceId
    )
    
    if (existingIndex >= 0) {
      utilityFunctions.value[existingIndex] = utilityData
    } else {
      utilityFunctions.value.push(utilityData)
    }
    
    // åŒã˜åˆ—ï¼ˆåŒã˜æ€§èƒ½ï¼‰ã®ä»–ã®ã‚»ãƒ«ã«ã¯ã€è»¸ã®ç¯„å›²ï¼ˆaxisMin, axisMaxï¼‰ã®ã¿ã‚’åŒæœŸ
    for (const rel of sameColumnRelations) {
      if (rel.need_id === needId) continue; // ç¾åœ¨ã®ã‚»ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
      
      // æ—¢å­˜ã®åŠ¹ç”¨é–¢æ•°ã‚’å–å¾—
      const existingFunc = utilityFunctions.value.find(
        u => u.need_id === rel.need_id && u.performance_id === performanceId
      )
      
      if (existingFunc) {
        // æ—¢å­˜ã®åŠ¹ç”¨é–¢æ•°ãŒã‚ã‚‹å ´åˆã€è»¸ã®ç¯„å›²ã®ã¿æ›´æ–°
        const updatedData: UtilityFunction = {
          ...existingFunc,
          axisMin: utilityData.axisMin,
          axisMax: utilityData.axisMax
          // points, discreteRowsã¯ãã®ã¾ã¾ä¿æŒ
        }
        
        await projectStore.saveUtilityFunction(rel.need_id, performanceId, updatedData)
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®çŠ¶æ…‹ã‚‚æ›´æ–°
        const idx = utilityFunctions.value.findIndex(
          u => u.need_id === rel.need_id && u.performance_id === performanceId
        )
        if (idx >= 0) {
          utilityFunctions.value[idx] = updatedData
        }
      }
      // åŠ¹ç”¨é–¢æ•°ãŒæœªè¨­å®šã®ã‚»ãƒ«ã«ã¯ä½•ã‚‚ã—ãªã„
    }
    
    closeUtilityModal()
  } catch (error) {
    console.error('åŠ¹ç”¨é–¢æ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
    alert('åŠ¹ç”¨é–¢æ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚')
  }
}

async function resetUtilityFunction() {
  if (!currentUtilityEdit.value) return
  
  if (!confirm('åŠ¹ç”¨é–¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    return
  }
  
  const { needId, performanceId } = currentUtilityEdit.value
  
  try {
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰å‰Šé™¤ï¼ˆDELETEãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼‰
    const projectId = projectStore.currentProject?.id
    if (!projectId) {
      throw new Error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒå–å¾—ã§ãã¾ã›ã‚“')
    }
    
    const response = await fetch(
      `http://localhost:8000/api/projects/${projectId}/utility-functions/${needId}/${performanceId}`,
      {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      }
    )
    
    if (!response.ok) {
      throw new Error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ')
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
    const index = utilityFunctions.value.findIndex(
      u => u.need_id === needId && u.performance_id === performanceId
    )
    
    if (index >= 0) {
      utilityFunctions.value.splice(index, 1)
    }
    
    closeUtilityModal()
  } catch (error) {
    console.error('åŠ¹ç”¨é–¢æ•°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
    alert('åŠ¹ç”¨é–¢æ•°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚')
  }
}

function getCurrentPerformanceUnit(): string | undefined {
  if (!currentUtilityEdit.value) return undefined
  
  const performance = performances.value.find(
    p => p.id === currentUtilityEdit.value!.performanceId
  )
  
  return performance?.unit
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŠ¹ç”¨é–¢æ•°ã‚’å…¨ã¦ãƒ­ãƒ¼ãƒ‰
async function loadAllUtilityFunctions() {
  if (!currentProject.value?.id) return
  
  try {
    const loadedFunctions = await projectStore.loadUtilityFunctions()
    utilityFunctions.value = loadedFunctions
    
    // èª­ã¿è¾¼ã¿å¾Œã€åŒã˜åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€
    await normalizeUtilityFunctionsByColumn()
  } catch (error) {
    console.error('åŠ¹ç”¨é–¢æ•°ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
  }
}

// åŒã˜æ€§èƒ½åˆ—ã®åŠ¹ç”¨é–¢æ•°ã‚’çµ±ä¸€ã™ã‚‹ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ï¼‰
async function normalizeUtilityFunctionsByColumn() {
  if (!currentProject.value) return
  
  // æ€§èƒ½IDã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const performanceGroups = new Map<string, typeof utilityFunctions.value>()
  
  utilityFunctions.value.forEach(uf => {
    if (!performanceGroups.has(uf.performance_id)) {
      performanceGroups.set(uf.performance_id, [])
    }
    performanceGroups.get(uf.performance_id)!.push(uf)
  })
  
  let totalNormalized = 0
  
  // å„æ€§èƒ½åˆ—ã”ã¨ã«å‡¦ç†
  for (const [performanceId, functions] of performanceGroups.entries()) {
    if (functions.length <= 1) continue
    
    // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸè¨­å®šã‚’åŸºæº–ã¨ã™ã‚‹
    const standard = functions[0]
    
    // åŸºæº–ã¨ç•°ãªã‚‹è¨­å®šã‚’æŒã¤ã‚‚ã®ã‚’ä¿®æ­£
    for (let i = 1; i < functions.length; i++) {
      const func = functions[i]
      let needsUpdate = false
      
      // é€£ç¶šå€¤ã®å ´åˆ: è»¸ç¯„å›²ã‚’çµ±ä¸€
      if (standard.type === 'continuous' && func.type === 'continuous') {
        if (func.axisMin !== standard.axisMin || func.axisMax !== standard.axisMax) {
          func.axisMin = standard.axisMin
          func.axisMax = standard.axisMax
          needsUpdate = true
        }
      }
      
      // é›¢æ•£å€¤ã®å ´åˆ: é¸æŠè‚¢ï¼ˆlabelï¼‰ã‚’çµ±ä¸€ã€å€¤ã¯ä¿æŒ
      if (standard.type === 'discrete' && func.type === 'discrete') {
        if (standard.discreteRows && func.discreteRows) {
          const standardLabels = standard.discreteRows.map(r => r.label).sort()
          const funcLabels = func.discreteRows.map(r => r.label).sort()
          
          if (JSON.stringify(standardLabels) !== JSON.stringify(funcLabels)) {
            // ãƒ©ãƒ™ãƒ«ã‚’çµ±ä¸€ã€æ—¢å­˜ã®å€¤ã¯ä¿æŒ
            const newRows = standard.discreteRows.map(sr => {
              const existing = func.discreteRows?.find(fr => fr.label === sr.label)
              return {
                label: sr.label,
                value: existing?.value ?? 0
              }
            })
            func.discreteRows = newRows
            needsUpdate = true
          }
        }
      }
      
      // typeãŒç•°ãªã‚‹å ´åˆã‚‚çµ±ä¸€
      if (func.type !== standard.type) {
        func.type = standard.type
        func.axisMin = standard.axisMin
        func.axisMax = standard.axisMax
        func.discreteRows = standard.discreteRows ? [...standard.discreteRows.map(r => ({ ...r, value: 0 }))] : undefined
        needsUpdate = true
      }
      
      if (needsUpdate) {
        try {
          await projectStore.saveUtilityFunction(func.need_id, func.performance_id, func)
          totalNormalized++
        } catch (error) {
          console.error(`åŠ¹ç”¨é–¢æ•°ã®çµ±ä¸€ã«å¤±æ•—: ${func.need_id} x ${func.performance_id}`, error)
        }
      }
    }
  }
  
  if (totalNormalized > 0) {
  }
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰åŠ¹ç”¨é–¢æ•°ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
watch(
  () => currentProject.value?.id,
  (newProjectId) => {
    if (newProjectId) {
      loadAllUtilityFunctions()
    } else {
      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚ã‚¯ãƒªã‚¢
      utilityFunctions.value = []
    }
  },
  { immediate: true }
)

// åˆ†è§£ä¸è¶³ã®æ€§èƒ½åˆ†æ
const insufficientDecompositionAnalysis = computed(() => {
  const result = {
    rootLevel: [] as string[],
    leafLevel: [] as string[]
  }
  
  // HHIå€¤ã‚’æŒã¤å¤§é …ç›®ã‚’åˆ†æï¼ˆé–¾å€¤ä»¥ä¸Šã®ã‚‚ã®ã‚’æŠ½å‡ºï¼‰
  const rootAnalysis = rootGroups.value.map(group => ({
    name: group.rootPerformance.name,
    hhi: getHHIForRoot(group.rootIndex),
    isLeaf: group.rootPerformance.is_leaf
  })).filter(item => item.hhi > 0)
  
  // HHIãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
  rootAnalysis.sort((a, b) => b.hhi - a.hhi)
  
  // å¹³å‡å€¤ã‚’è¨ˆç®—
  const avgHHI = rootAnalysis.length > 0 
    ? rootAnalysis.reduce((sum, item) => sum + item.hhi, 0) / rootAnalysis.length 
    : 0
  
  // å¹³å‡ä»¥ä¸Šã€ã‹ã¤ä¸Šä½50%ã‚’æŠ½å‡ºï¼ˆæœ€å¤§5ä»¶ï¼‰
  const threshold = avgHHI
  const topCount = Math.max(1, Math.ceil(rootAnalysis.length * 0.5))
  result.rootLevel = rootAnalysis
    .filter(item => item.hhi >= threshold)
    .slice(0, Math.min(topCount, 5))
    .map(item => item.name)
  
  // æœ«ç«¯æ€§èƒ½ã®pÂ²å€¤ã‚’åˆ†æ
  const leafAnalysis = getAllPerformanceColumns()
    .filter(perf => perf.is_leaf)
    .map(perf => ({
      name: perf.name,
      pSquared: getPSquaredForPerformance(perf.id)
    }))
    .filter(item => item.pSquared > 0)
  
  // pÂ²ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
  leafAnalysis.sort((a, b) => b.pSquared - a.pSquared)
  
  // å¹³å‡å€¤ã‚’è¨ˆç®—
  const avgPSquared = leafAnalysis.length > 0
    ? leafAnalysis.reduce((sum, item) => sum + item.pSquared, 0) / leafAnalysis.length
    : 0
  
  // å¹³å‡ä»¥ä¸Šã€ã‹ã¤ä¸Šä½50%ã‚’æŠ½å‡ºï¼ˆæœ€å¤§5ä»¶ï¼‰
  const pSquaredThreshold = avgPSquared
  const leafTopCount = Math.max(1, Math.ceil(leafAnalysis.length * 0.5))
  result.leafLevel = leafAnalysis
    .filter(item => item.pSquared >= pSquaredThreshold)
    .slice(0, Math.min(leafTopCount, 5))
    .map(item => item.name)
  
  return result
})

</script>

<style scoped>
.section-header {
  margin-bottom: 20px;
}

.section-header h2 {
  font-size: 24px;
  margin-bottom: 8px;
}

.section-description {
  color: #666;
  font-size: 14px;
  line-height: 1.6;
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.matrix-toolbar {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.toolbar-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #495057;
  transition: all 0.2s ease;
}

.toolbar-button:hover {
  background: #e7f1ff;
  border-color: #107c41;
  color: #107c41;
}

.toolbar-button .excel-icon {
  flex-shrink: 0;
}

.toolbar-button span {
  white-space: nowrap;
}

.toolbar-divider {
  width: 1px;
  height: 43px;
  background: #dee2e6;
  margin: 0 8px;
}

.template-download-button:hover {
  box-shadow: 0 2px 6px rgba(16, 124, 65, 0.2);
}

.matrix-image-button {
  color: #6f42c1;
}

.matrix-image-button:hover {
  background: #f3e8ff;
  border-color: #6f42c1;
  color: #6f42c1;
  box-shadow: 0 2px 6px rgba(111, 66, 193, 0.2);
}

.matrix-excel-button {
  color: #107c41;
}

.matrix-excel-button:hover {
  background: #d1f4e0;
  border-color: #107c41;
  color: #107c41;
  box-shadow: 0 2px 6px rgba(16, 124, 65, 0.2);
}

.matrix-container {
  overflow-x: auto;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
}

.matrix-table {
  width: auto;
  border-collapse: collapse;
  background: white;
  color: #333;
}

.corner-cell {
  background: #f5f5f5;
  padding: 16px;
  font-weight: 600;
  border: 1px solid #ddd;
  min-width: 150px;
  text-align: center;
  vertical-align: middle;
}

.group-header {
  padding: 12px;
  font-weight: 600;
  text-align: center;
  border: 1px solid #ddd;
  font-size: 15px;
}

.stakeholder-group {
  background: #667eea;
  color: white;
}

.total-votes-header {
  background: #f59e0b;
  color: white;
  font-weight: 700;
  min-width: 100px;
}

.performance-group {
  background: #764ba2;
  color: white;
}

.stakeholder-header {
  background: #e8eaf6;
  color: #333;
  padding: 10px 2px;
  border: 1px solid #ddd;
  min-width: 40px;
  text-align: center;
  vertical-align: middle;
  font-size: 13px;
}

.stakeholder-header-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  height: 100%;
  width: 100%;
}

.stakeholder-name-vertical {
  writing-mode: vertical-rl;
  text-orientation: mixed;
  flex: 1;
  font-size: 13px;
  text-align: center;
  line-height: 1.2;
  display: inline-block;
  white-space: nowrap;
  -webkit-writing-mode: vertical-rl;
  -ms-writing-mode: tb-rl;
}

.stakeholder-votes-horizontal {
  writing-mode: horizontal-tb;
  font-size: 9px;
  font-weight: 600;
  color: #666;
  white-space: nowrap;
}

.performance-header {
  padding: 10px 2px;
  border: 1px solid #ddd;
  width: 28px;
  vertical-align: middle;
  text-align: center;
  font-size: 11px;
  writing-mode: vertical-rl;
  text-orientation: upright;
}

/* å¤§é …ç›®0: èµ¤ç³»çµ± */
.performance-header.root-0.level-1 {
  background: #ef9a9a;
}

.performance-header.root-0.level-2 {
  background: #ffcdd2;
}

.performance-header.root-0.level-3 {
  background: #ffebee;
}

/* å¤§é …ç›®1: é’ç³»çµ± */
.performance-header.root-1.level-1 {
  background: #90caf9;
}

.performance-header.root-1.level-2 {
  background: #bbdefb;
}

.performance-header.root-1.level-3 {
  background: #e3f2fd;
}

/* å¤§é …ç›®2: ç·‘ç³»çµ± */
.performance-header.root-2.level-1 {
  background: #a5d6a7;
}

.performance-header.root-2.level-2 {
  background: #c8e6c9;
}

.performance-header.root-2.level-3 {
  background: #e8f5e9;
}

/* å¤§é …ç›®3: é»„ç³»çµ± */
.performance-header.root-3.level-1 {
  background: #fff59d;
}

.performance-header.root-3.level-2 {
  background: #fff9c4;
}

.performance-header.root-3.level-3 {
  background: #fffde7;
}

/* å¤§é …ç›®4: ç´«ç³»çµ± */
.performance-header.root-4.level-1 {
  background: #e1bee7;
}

.performance-header.root-4.level-2 {
  background: #f3e5f5;
}

.performance-header.root-4.level-3 {
  background: #f8f5fa;
}

/* å¤§é …ç›®5: ã‚ªãƒ¬ãƒ³ã‚¸ç³»çµ± */
.performance-header.root-5.level-1 {
  background: #ffcc80;
}

.performance-header.root-5.level-2 {
  background: #ffe0b2;
}

.performance-header.root-5.level-3 {
  background: #fff3e0;
}

/* å¤§é …ç›®6: ã‚·ã‚¢ãƒ³ç³»çµ± */
.performance-header.root-6.level-1 {
  background: #80deea;
}

.performance-header.root-6.level-2 {
  background: #b2ebf2;
}

.performance-header.root-6.level-3 {
  background: #e0f7fa;
}

/* å¤§é …ç›®7: ãƒ”ãƒ³ã‚¯ç³»çµ± */
.performance-header.root-7.level-1 {
  background: #f48fb1;
}

.performance-header.root-7.level-2 {
  background: #f8bbd0;
}

.performance-header.root-7.level-3 {
  background: #fce4ec;
}

/* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãã‚Œä»¥ä¸Šã®å¤§é …ç›®ï¼‰ */
.performance-header.level-1 {
  background: #b0bec5;
}

.performance-header.level-2 {
  background: #cfd8dc;
}

.performance-header.level-3 {
  background: #eceff1;
}

/* æœ«ç«¯ã‚»ãƒ«ã®å¢ƒç•Œç·š: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
.performance-header.is-leaf {
  border: 2px solid #9c27b0;
  font-weight: 600;
}

/* æœ«ç«¯ã‚»ãƒ«ã®å¢ƒç•Œç·š: å¤§é …ç›®ã”ã¨ */
.performance-header.root-0.is-leaf {
  border: 2px solid #c62828;
}

.performance-header.root-1.is-leaf {
  border: 2px solid #1565c0;
}

.performance-header.root-2.is-leaf {
  border: 2px solid #2e7d32;
}

.performance-header.root-3.is-leaf {
  border: 2px solid #f9a825;
}

.performance-header.root-4.is-leaf {
  border: 2px solid #9c27b0;
}

.performance-header.root-5.is-leaf {
  border: 2px solid #ef6c00;
}

.performance-header.root-6.is-leaf {
  border: 2px solid #00838f;
}

.performance-header.root-7.is-leaf {
  border: 2px solid #c2185b;
}

.header-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.votes-display {
  font-size: 9px;
  color: #666;
}

.unit-text {
  font-size: 9px;
  opacity: 0.8;
}

.leaf-badge {
  background: #9c27b0;
  color: white;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 9px;
  font-weight: 600;
}

.need-header {
  background: #f8f9fa;
  padding: 8px 10px;
  border: 1px solid #ddd;
  width: 100px;
  font-weight: 600;
  font-size: 12px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.need-info {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}

.category-tag {
  background: #e0e0e0;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: normal;
}

.matrix-cell {
  border: 1px solid #ddd;
  padding: 6px 2px;
  text-align: center;
  width: 28px;
  min-height: 45px;
  transition: background-color 0.2s;
}

.stakeholder-cell {
  cursor: pointer;
}

.stakeholder-cell:hover {
  background: #f0f0f0;
}

.stakeholder-cell.active {
  background: #d4edda;
}

.total-votes-cell {
  background: #fef3c7;
  font-weight: 700;
  border-left: 3px solid #f59e0b;
  border-right: 3px solid #f59e0b;
}

.total-votes-value {
  color: #b45309;
  font-size: 18px;
}

.performance-cell.non-leaf {
  background: #fafafa;
  cursor: not-allowed;
}

.matrix-cell.unchecked {
  background-color: #fffbeb;
}

.performance-cell:not(.non-leaf) {
  cursor: pointer;
}

.performance-cell:not(.non-leaf):hover {
  background: #f0f0f0;
}

.performance-cell.direction-up {
  background: #d4edda;
}

.performance-cell.direction-down {
  background: #f8d7da;
}

.cell-content {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  height: 100%;
  gap: 2px;
}

.arrow-symbol {
  font-size: 18px;
  font-weight: bold;
}

.performance-votes {
  font-size: 10px;
  font-weight: 600;
  color: #666;
}

.stakeholder-cell.active .cell-content {
  color: #28a745;
}

.performance-cell.direction-up .arrow-symbol {
  color: #28a745;
}

.performance-cell.direction-down .arrow-symbol {
  color: #dc3545;
}

.non-leaf-indicator {
  color: #ccc;
  font-size: 16px;
}

.summary-row {
  background: #f8f9fa;
  border-top: 2px solid #6c757d;
}

.summary-empty {
  background: transparent;
  border: none;
}

.summary-label-cell {
  background: #e9ecef;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border: 1px solid #ddd;
  text-align: center;
  min-width: 100px;
}

.effective-votes-label {
  background: #e9ecef;
  color: #495057;
  font-weight: 600;
}

.summary-cell {
  background: #ffffff;
  padding: 10px 8px;
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  color: #495057;
  border: 1px solid #ddd;
}

.summary-value {
  font-size: 14px;
  font-weight: 700;
}

.effective-votes-row {
  border-top: 2px solid #6c757d;
  background: #f8f9fa;
}

.effective-votes-empty {
  background: transparent;
  border-top: 2px solid #6c757d;
}

.effective-votes-cell {
  background: #ffffff;
  color: #495057;
  font-weight: 600;
}

.effective-votes-cell .summary-value {
  font-size: 15px;
}

.root-summary-row {
  border-top: 2px solid #6c757d;
  background: #f8f9fa;
}

.root-summary-empty {
  background: transparent;
  border-top: 2px solid #6c757d;
}

.root-summary-label {
  background: #e9ecef;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border: 1px solid #ddd;
  text-align: center;
  min-width: 100px;
}

.root-summary-cell {
  padding: 10px 8px;
  text-align: center;
  font-weight: 700;
  border: 2px solid #6c757d;
}

/* Vè¡Œã‚»ãƒ«ã®èƒŒæ™¯è‰²: å¤§é …ç›®ã”ã¨ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜è‰²ï¼‰ */
.root-summary-cell.root-cell-0 {
  background: #ef9a9a;
  border: 2px solid #c62828;
}

.root-summary-cell.root-cell-1 {
  background: #90caf9;
  border: 2px solid #1565c0;
}

.root-summary-cell.root-cell-2 {
  background: #a5d6a7;
  border: 2px solid #2e7d32;
}

.root-summary-cell.root-cell-3 {
  background: #fff59d;
  border: 2px solid #f9a825;
}

.root-summary-cell.root-cell-4 {
  background: #e1bee7;
  border: 2px solid #9c27b0;
}

.root-summary-cell.root-cell-5 {
  background: #ffcc80;
  border: 2px solid #ef6c00;
}

.root-summary-cell.root-cell-6 {
  background: #80deea;
  border: 2px solid #00838f;
}

.root-summary-cell.root-cell-7 {
  background: #f48fb1;
  border: 2px solid #c2185b;
}

.root-value {
  font-size: 16px;
  font-weight: 700;
  color: #212529;
}

.p-value-row {
  border-top: 2px solid #6c757d;
  background: #f8f9fa;
}

.p-value-empty {
  background: transparent;
  border-top: 2px solid #6c757d;
}

.p-value-label {
  background: #e9ecef;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border: 1px solid #ddd;
  text-align: center;
  min-width: 100px;
}

.p-value-cell {
  background: #ffffff;
  color: #495057;
  font-weight: 600;
  border: 1px solid #ddd;
}

.p-value-cell .summary-value {
  font-size: 13px;
}

.p-squared-row {
  border-top: 2px solid #6c757d;
  background: #f8f9fa;
}

.p-squared-empty {
  background: transparent;
  border-top: 2px solid #6c757d;
}

.p-squared-label {
  background: #e9ecef;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border: 1px solid #ddd;
  text-align: center;
  min-width: 100px;
}

.p-squared-cell {
  color: #212529;
  font-weight: 700;
  border: 1px solid #ddd;
}

.p-squared-cell .summary-value {
  font-size: 12px;
  font-weight: 700;
}

.hhi-row {
  border-top: 3px solid #6c757d;
  background: #f8f9fa;
}

.hhi-empty {
  background: transparent;
  border-top: 3px solid #6c757d;
}

.hhi-label {
  background: #e9ecef;
  padding: 10px 12px;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  border: 1px solid #ddd;
  text-align: center;
  min-width: 100px;
}

.hhi-cell {
  color: #212529;
  font-weight: 700;
  border: 2px solid #ddd;
}

.hhi-value {
  font-size: 15px;
  font-weight: 700;
}

.decomposition-analysis {
  margin-top: 30px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #667eea;
}

.decomposition-analysis h3 {
  font-size: 18px;
  margin-bottom: 16px;
  color: #333;
}

.analysis-item {
  margin-bottom: 12px;
  line-height: 1.8;
}

.analysis-item strong {
  color: #495057;
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}

.performance-list {
  color: #e74c3c;
  font-weight: 600;
  font-size: 15px;
}

.analysis-action {
  margin-top: 16px;
  text-align: center;
}

.decompose-button {
  padding: 12px 32px;
  font-size: 16px;
  font-weight: 600;
  color: white;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
}

.decompose-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
}

.decompose-button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.empty-matrix {
  text-align: center;
  padding: 60px 20px;
  color: #999;
  background: #f8f9fa;
  border-radius: 8px;
}

/* åŠ¹ç”¨é–¢æ•°ãƒœã‚¿ãƒ³ */
.utility-button {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 14px;
  height: 14px;
  border-radius: 3px;
  border: none;
  font-size: 10px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  pointer-events: auto;
  transition: all 0.2s ease;
  line-height: 1;
  padding: 0;
}

.utility-button-add {
  background: #3b82f6;
  color: white;
}

.utility-button-add:hover {
  background: #2563eb;
  transform: scale(1.1);
}

.utility-button-check {
  background: #10b981;
  color: white;
}

.utility-button-check:hover {
  background: #059669;
  transform: scale(1.1);
}

.utility-button-warning {
  background: #f59e0b;
  color: white;
  animation: pulse 2s infinite;
}

.utility-button-warning:hover {
  background: #d97706;
  transform: scale(1.1);
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.cell-content {
  position: relative;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.utility-modal h3 {
  margin-bottom: 20px;
  font-size: 20px;
  color: #333;
}

.modal-info {
  background: #f8f9fa;
  padding: 10px 14px;
  border-radius: 6px;
  margin-bottom: 16px;
}

.info-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
  font-size: 13px;
}

.info-row:last-child {
  margin-bottom: 0;
}

.info-row strong {
  min-width: 60px;
  color: #495057;
  font-size: 12px;
}

.direction-badge {
  background: #667eea;
  color: white;
  padding: 3px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.graph-section {
  margin-bottom: 20px;
}

.graph-section label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #495057;
  font-size: 14px;
}

.graph-description {
  font-size: 12px;
  color: #6c757d;
  margin-bottom: 12px;
  font-style: italic;
}

.graph-container {
  background: white;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 12px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
  max-width: 650px;
  margin: 0 auto;
}

.graph-controls {
  position: relative;
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-bottom: 8px;
}

.graph-control-button {
  padding: 6px 8px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #495057;
}

.graph-control-button:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #212529;
}

.graph-control-button.copy-button {
  color: #0d6efd;
}

.graph-control-button.copy-button:hover {
  background: #e7f1ff;
  border-color: #0d6efd;
  color: #0a58ca;
}

.graph-control-button.camera-button {
  color: #6f42c1;
}

.graph-control-button.camera-button:hover {
  background: #f3e8ff;
  border-color: #6f42c1;
  color: #59359a;
}

.graph-control-button.import-button {
  color: #0dcaf0;
}

.graph-control-button.import-button:hover {
  background: #cff4fc;
  border-color: #0dcaf0;
  color: #087990;
}

.graph-control-button.excel-button {
  color: #107c41;
}

.graph-control-button.excel-button:hover {
  background: #d1f4e0;
  border-color: #107c41;
  color: #0b6631;
}

.graph-control-button.paste-button {
  color: #198754;
}

.graph-control-button.paste-button:hover {
  background: #d1f4e0;
  border-color: #198754;
  color: #146c43;
}

.graph-popup {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 280px;
  max-width: 320px;
  z-index: 1000;
  animation: popupFadeIn 0.2s ease;
}

@keyframes popupFadeIn {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #e9ecef;
}

.popup-header h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #212529;
}

.popup-close {
  background: none;
  border: none;
  font-size: 20px;
  color: #6c757d;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.popup-close:hover {
  background: #f8f9fa;
  color: #212529;
}

.popup-content {
  padding: 12px 16px;
}

.info-list {
  margin: 0;
  padding-left: 20px;
  list-style: none;
}

.info-list li {
  margin-bottom: 8px;
  font-size: 13px;
  color: #495057;
  line-height: 1.5;
  position: relative;
}

.info-list li::before {
  content: "â–¸";
  position: absolute;
  left: -16px;
  color: #3b82f6;
  font-weight: bold;
}

.info-list li:last-child {
  margin-bottom: 0;
}

.info-section-title {
  font-size: 12px;
  font-weight: 600;
  color: #212529;
  margin: 12px 0 8px 0;
  padding-left: 4px;
  border-left: 3px solid #3b82f6;
}

.info-section-title:first-child {
  margin-top: 0;
}

.setting-item {
  margin-bottom: 12px;
}

.setting-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #495057;
  margin-bottom: 6px;
}

.setting-select {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 13px;
  color: #495057;
  background: white;
  cursor: pointer;
  transition: border-color 0.2s ease;
}

.setting-select:hover {
  border-color: #adb5bd;
}

.setting-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.setting-select:disabled {
  background: #e9ecef;
  color: #6c757d;
  cursor: not-allowed;
  opacity: 0.6;
}

.setting-description {
  font-size: 12px;
  color: #6c757d;
  font-style: italic;
  margin-top: 8px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 4px;
}

.utility-graph {
  width: 100%;
  height: auto;
  display: block;
  cursor: crosshair;
}

.utility-point {
  transition: all 0.2s ease;
}

.utility-point:hover {
  r: 7;
  filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.4));
}

.discrete-point:hover {
  filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.4));
}

.custom-tooltip {
  pointer-events: none;
  animation: tooltipFadeIn 0.15s ease;
}

@keyframes tooltipFadeIn {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.type-switcher {
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 12px 0;
  margin-top: 8px;
}

.type-label {
  font-size: 14px;
  font-weight: 600;
  color: #495057;
  margin-right: 4px;
}

.type-button {
  padding: 6px 16px;
  border: 2px solid #dee2e6;
  border-radius: 6px;
  background: white;
  font-size: 13px;
  font-weight: 500;
  color: #495057;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  gap: 6px;
  align-items: center;
}

.type-button:hover {
  border-color: #0066cc;
  background: #f8f9fa;
}

.type-button.active {
  background: #0066cc;
  border-color: #0066cc;
  color: white;
}

.type-icon {
  font-size: 10px;
  font-weight: bold;
}

.axis-range-control {
  margin-top: 16px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.discrete-matrix-control {
  margin-top: 16px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #dee2e6;
}

.matrix-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.matrix-label {
  font-size: 14px;
  font-weight: 600;
  color: #495057;
}

.add-row-button {
  padding: 6px 12px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s ease;
}

.add-row-button:hover {
  background: #2563eb;
}

.discrete-matrix {
  overflow-x: auto;
}

.discrete-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 6px;
  overflow: hidden;
}

.discrete-table thead {
  background: #e9ecef;
}

.discrete-table th {
  padding: 10px 12px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  color: #495057;
  border-bottom: 2px solid #dee2e6;
}

.label-column {
  width: 50%;
}

.value-column {
  width: 40%;
}

.action-column {
  width: 10%;
  text-align: center;
}

.discrete-row {
  border-bottom: 1px solid #e9ecef;
}

.discrete-row:last-child {
  border-bottom: none;
}

.discrete-row:hover {
  background: #f8f9fa;
}

.label-cell,
.value-cell,
.action-cell {
  padding: 8px 12px;
}

.discrete-input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 13px;
  transition: border-color 0.2s ease;
}

.discrete-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.remove-row-button {
  padding: 4px 8px;
  background: #dc2626;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.remove-row-button:hover:not(:disabled) {
  background: #b91c1c;
}

.remove-row-button:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}

.matrix-hint {
  margin-top: 12px;
  padding: 10px 12px;
  background: #eff6ff;
  border-left: 3px solid #3b82f6;
  border-radius: 4px;
  font-size: 12px;
  color: #1e40af;
  line-height: 1.5;
}

.range-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.range-label {
  font-size: 14px;
  font-weight: 600;
  color: #495057;
}

.range-tip {
  font-size: 11px;
  color: #6c757d;
  font-style: italic;
}

.range-single-row {
  display: flex;
  gap: 12px;
  align-items: center;
}

.range-input {
  padding: 8px 12px;
  border: 2px solid #dee2e6;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  width: 100px;
  transition: border-color 0.2s ease;
}

.range-input:focus {
  outline: none;
  border-color: #0066cc;
}

.nouislider-container {
  flex: 1;
  height: 40px;
  display: flex;
  align-items: center;
}

/* noUiSliderã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
.nouislider-container :deep(.noUi-target) {
  border: none;
  box-shadow: none;
  background: #dee2e6;
  height: 8px;
  border-radius: 4px;
}

.nouislider-container :deep(.noUi-connect) {
  background: #0066cc;
}

.nouislider-container :deep(.noUi-handle) {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 3px solid #0066cc;
  background: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  top: 50%;
  transform: translate(-50%, -50%);
}

.nouislider-container :deep(.noUi-handle:hover) {
  background: #f0f8ff;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
}

.nouislider-container :deep(.noUi-handle:before),
.nouislider-container :deep(.noUi-handle:after) {
  display: none;
}

.nouislider-container :deep(.noUi-tooltip) {
  background: #495057;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  padding: 4px 8px;
  bottom: 140%;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  align-items: center;
}

.modal-actions .spacer {
  flex: 1;
}

.modal-actions button {
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.modal-actions .secondary {
  background: #e9ecef;
  color: #495057;
  border: 1px solid #dee2e6;
}

.modal-actions .secondary:hover {
  background: #dee2e6;
}

.modal-actions .primary {
  background: #667eea;
  color: white;
  border: none;
}

.modal-actions .primary:hover {
  background: #5568d3;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
}

.modal-actions .danger {
  background: #fee;
  color: #dc3545;
  border: 2px solid #dc3545;
  font-weight: 700;
}

.modal-actions .danger:hover {
  background: #dc3545;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}
</style>
# Deep Traceability System - アーキテクチャ図集

**作成日**: 2025年1月14日
**用途**: 論文用図表の素材

---

## 目次

1. [C4モデル](#1-c4モデル)
   - Context図
   - Container図
   - Component図
2. [ER図（データモデル）](#2-erデータモデル)
3. [レイヤー図](#3-レイヤー図)
4. [シーケンス図](#4-シーケンス図)
5. [データフロー図](#5-データフロー図)
6. [状態遷移図](#6-状態遷移図)
7. [ユースケース図](#7-ユースケース図)
8. [配置図](#8-配置図)
9. [モジュール依存図](#9-モジュール依存図)
10. [計算パイプライン図](#10-計算パイプライン図)
11. [PAVEネットワーク構造図](#11-paveネットワーク構造図)

---

## 1. C4モデル

### 1.1 Context図（システム境界）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部環境                                        │
│                                                                             │
│    ┌──────────────┐                                    ┌──────────────┐    │
│    │              │                                    │              │    │
│    │   設計者     │                                    │  ステーク    │    │
│    │  (Designer)  │                                    │  ホルダー    │    │
│    │              │                                    │              │    │
│    └──────┬───────┘                                    └──────┬───────┘    │
│           │ 設計案の作成・比較                                │            │
│           │ トレードオフ分析                                  │ 要求定義   │
│           │                                                   │ 優先度設定 │
│           ▼                                                   ▼            │
│    ┌──────────────────────────────────────────────────────────────────┐    │
│    │                                                                  │    │
│    │              Deep Traceability System                           │    │
│    │                                                                  │    │
│    │  ・多目的設計意思決定支援                                        │    │
│    │  ・ステークホルダー要求の定量化                                  │    │
│    │  ・設計案の可視化・比較                                         │    │
│    │  ・構造的トレードオフ分析                                       │    │
│    │                                                                  │    │
│    └──────────────────────────────────────────────────────────────────┘    │
│                              │                                              │
│                              │ データ永続化                                 │
│                              ▼                                              │
│                    ┌──────────────────┐                                    │
│                    │   SQLite/        │                                    │
│                    │   PostgreSQL     │                                    │
│                    └──────────────────┘                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Container図（システム構成）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Deep Traceability System                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Frontend Container                              │   │
│  │                      (Vue 3 + TypeScript)                           │   │
│  │                                                                      │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │Stakeholder │ │ Matrix     │ │ Mountain   │ │ Network    │       │   │
│  │  │Management  │ │ Views      │ │ View       │ │ Editor     │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │
│  │  │ Two-Axis   │ │ Tradeoff   │ │ Shapley    │ │ OPM 3D     │       │   │
│  │  │ Evaluation │ │ Analysis   │ │ Breakdown  │ │ View       │       │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │
│  │                                                                      │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │                   Pinia State Store                          │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────┬──────────────────────────────────┘   │
│                                     │                                       │
│                                     │ REST API (JSON)                       │
│                                     │ HTTP/HTTPS                            │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Backend Container                               │   │
│  │                      (FastAPI + Python)                             │   │
│  │                                                                      │   │
│  │  ┌────────────────────────────────────────────────────────────┐     │   │
│  │  │                      API Layer                              │     │   │
│  │  │  /api/projects  │  /api/calculations  │  /api/mds          │     │   │
│  │  └────────────────────────────────────────────────────────────┘     │   │
│  │                              │                                       │   │
│  │  ┌────────────────────────────────────────────────────────────┐     │   │
│  │  │                    Service Layer                            │     │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │     │   │
│  │  │  │  Mountain    │ │  Tradeoff    │ │  Energy      │        │     │   │
│  │  │  │  Calculator  │ │  Calculator  │ │  Calculator  │        │     │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘        │     │   │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │     │   │
│  │  │  │  Shapley     │ │  SCC         │ │  Matrix      │        │     │   │
│  │  │  │  Calculator  │ │  Analyzer    │ │  Utils       │        │     │   │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘        │     │   │
│  │  └────────────────────────────────────────────────────────────┘     │   │
│  │                              │                                       │   │
│  │  ┌────────────────────────────────────────────────────────────┐     │   │
│  │  │                    Data Layer (SQLAlchemy ORM)             │     │   │
│  │  └────────────────────────────────────────────────────────────┘     │   │
│  └──────────────────────────────────┬──────────────────────────────────┘   │
│                                     │                                       │
│                                     │ SQL                                   │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Database Container                              │   │
│  │                      (SQLite / PostgreSQL)                          │   │
│  │                                                                      │   │
│  │  Projects │ Stakeholders │ Needs │ Performances │ DesignCases      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Component図（バックエンド詳細）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Backend Components                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           API Router                                 │   │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐        │   │
│  │  │ projects.py     │ │ calculations.py │ │ mds.py          │        │   │
│  │  │                 │ │                 │ │                 │        │   │
│  │  │ - CRUD Projects │ │ - /mountain     │ │ - WL Kernel     │        │   │
│  │  │ - CRUD Entities │ │ - /energy       │ │ - MDS座標計算   │        │   │
│  │  │ - Relations     │ │ - /tradeoff     │ │                 │        │   │
│  │  │ - Export/Import │ │ - /shapley      │ │                 │        │   │
│  │  │ - Network Nodes │ │ - /scc          │ │                 │        │   │
│  │  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘        │   │
│  └───────────┼──────────────────┼──────────────────┼────────────────────┘   │
│              │                  │                  │                        │
│              ▼                  ▼                  ▼                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Service Layer                                 │   │
│  │                                                                      │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐               │   │
│  │  │ mountain_calculator  │    │ structural_tradeoff  │               │   │
│  │  │                      │    │                      │               │   │
│  │  │ - distribute_votes() │    │ - 総効果行列計算     │               │   │
│  │  │ - calculate_utility()│    │ - cos θ 判定        │               │   │
│  │  │ - calculate_height() │    │                      │               │   │
│  │  │ - MDS座標マッピング  │    │                      │               │   │
│  │  └──────────┬───────────┘    └──────────┬───────────┘               │   │
│  │             │                           │                            │   │
│  │             ▼                           ▼                            │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐               │   │
│  │  │ energy_calculator    │    │ structural_energy    │               │   │
│  │  │                      │    │                      │               │   │
│  │  │ - Match値計算        │    │ - 損失関数 L(x)      │               │   │
│  │  │ - クーロン力モデル   │    │ - 論文準拠エネルギー │               │   │
│  │  └──────────────────────┘    └──────────┬───────────┘               │   │
│  │                                         │                            │   │
│  │             ┌───────────────────────────┘                            │   │
│  │             ▼                                                        │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐               │   │
│  │  │ matrix_utils         │    │ weight_normalization │               │   │
│  │  │                      │◄───│                      │               │   │
│  │  │ - 隣接行列構築       │    │ - 重みスキーム定義   │               │   │
│  │  │ - 総効果行列 T       │    │ - 正規化関数         │               │   │
│  │  │ - 内積計算           │    │ - 離散↔連続変換     │               │   │
│  │  └──────────────────────┘    └──────────────────────┘               │   │
│  │                                                                      │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐               │   │
│  │  │ shapley_calculator   │    │ scc_analyzer         │               │   │
│  │  │                      │    │                      │               │   │
│  │  │ - Shapley値計算      │    │ - Tarjanアルゴリズム │               │   │
│  │  │ - 寄与度分解         │    │ - スペクトル半径     │               │   │
│  │  │ - ノード/エッジ寄与  │    │ - ループ解消提案     │               │   │
│  │  └──────────────────────┘    └──────────────────────┘               │   │
│  │                                                                      │   │
│  │  ┌──────────────────────┐    ┌──────────────────────┐               │   │
│  │  │ discretization_      │    │ data_migration       │               │   │
│  │  │ confidence           │    │                      │               │   │
│  │  │                      │    │ - バージョン管理     │               │   │
│  │  │ - 符号保存確率       │    │ - スキーママイグレ   │               │   │
│  │  │ - 順序保存確率       │    │ - 重み形式変換       │               │   │
│  │  └──────────────────────┘    └──────────────────────┘               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. ER図（データモデル）

### 2.1 完全版ER図

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│  ┌──────────────────┐                                                              │
│  │     Project      │                                                              │
│  ├──────────────────┤                                                              │
│  │ PK: id (UUID)    │                                                              │
│  │ name             │                                                              │
│  │ description      │                                                              │
│  │ created_at       │                                                              │
│  │ updated_at       │                                                              │
│  │ two_axis_plots   │──── JSON配列                                                 │
│  └────────┬─────────┘                                                              │
│           │                                                                         │
│           │ 1                                                                       │
│           │                                                                         │
│     ┌─────┴─────┬──────────────┬──────────────┐                                    │
│     │           │              │              │                                     │
│     ▼ N         ▼ N            ▼ N            ▼ N                                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐                          │
│  │Stakeholder│ │  Need    │ │Performance │ │ DesignCase   │                          │
│  ├──────────┤ ├──────────┤ ├──────────┤ ├──────────────┤                          │
│  │PK: id    │ │PK: id    │ │PK: id    │ │PK: id        │                          │
│  │FK: proj  │ │FK: proj  │ │FK: proj  │ │FK: project_id│                          │
│  │name      │ │name      │ │name      │ │name          │                          │
│  │category  │ │category  │ │parent_id │ │description   │                          │
│  │votes     │ │priority  │ │level     │ │color         │                          │
│  │description│ │description│ │is_leaf   │ │perf_values   │──── JSON                 │
│  └────┬─────┘ └────┬─────┘ │unit      │ │network       │──── JSON (nodes, edges)  │
│       │            │       │description│ │perf_snapshot │──── JSON                 │
│       │            │       └────┬─────┘ │mountain_pos  │──── JSON                 │
│       │            │            │       │utility_vector│──── JSON                 │
│       │            │            │       │partial_heights│──── JSON                │
│       │            │            │       │energy        │──── JSON                 │
│       │            │            │       │weight_mode   │ ('discrete_3/5/7/continuous')
│       │            │            │       │scc_analysis  │──── JSON                 │
│       │            │            │       │paper_metrics │──── JSON                 │
│       │            │            │       │kernel_type   │                          │
│       │            │            │       └──────────────┘                          │
│       │            │            │                                                  │
│       └──────┬─────┴────────────┘                                                  │
│              │                                                                      │
│              ▼                                                                      │
│  ┌───────────────────────────┐      ┌───────────────────────────┐                 │
│  │ StakeholderNeedRelation   │      │ NeedPerformanceRelation   │                 │
│  ├───────────────────────────┤      ├───────────────────────────┤                 │
│  │ PK: (stakeholder_id,      │      │ PK: (need_id,             │                 │
│  │     need_id)              │      │     performance_id)       │                 │
│  │ FK: stakeholder_id        │      │ FK: need_id               │                 │
│  │ FK: need_id               │      │ FK: performance_id        │                 │
│  │ weight (1.0 / 0.5)        │      │ direction ('up'/'down')   │                 │
│  └───────────────────────────┘      │ utility_function          │──── JSON        │
│                                     └───────────────────────────┘                 │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 PAVEネットワークのデータ構造

```
NetworkStructure (JSON in DesignCase.network)
│
├── nodes: NetworkNode[]
│   │
│   ├── id: string (UUID)
│   ├── layer: 1 | 2 | 3 | 4
│   │         1 = Performance (性能)
│   │         2 = Attribute (属性)
│   │         3 = Variable (変数)
│   │         4 = Entity (実体)
│   ├── type: 'performance' | 'attribute' | 'variable' | 'object' | 'environment'
│   ├── label: string
│   ├── x, y: number (2D座標)
│   ├── x3d, y3d: number (3D座標, オプション)
│   └── performance_id?: string (Layer 1のみ)
│
└── edges: NetworkEdge[]
    │
    ├── id: string (UUID)
    ├── source_id: string
    ├── target_id: string
    ├── type: 'type1' | 'type2' | 'type3' | 'type4'
    │         type1 = A→P (属性→性能)
    │         type2 = A→A (属性→属性)
    │         type3 = V→A (変数→属性)
    │         type4 = V↔E, E↔E (無向)
    │
    └── weight?: number
              離散7段階: {-5, -3, -1, 0, 1, 3, 5}
              離散5段階: {-3, -1, 0, 1, 3}
              離散3段階: {-1, 0, 1}
              連続: [-1.0, +1.0]
```

---

## 3. レイヤー図

### 3.1 システムレイヤー構造

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         プレゼンテーション層                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      Vue 3 Components                                  │ │
│  │                                                                        │ │
│  │   Views          │  Components        │  Stores           │  Utils    │ │
│  │   ・Home         │  ・StakeholderMat  │  ・projectStore   │  ・api    │ │
│  │   ・ProjectList  │  ・NeedPerfMatrix  │                   │  ・format │ │
│  │   ・ProjectDetail│  ・MountainView    │                   │           │ │
│  │                  │  ・NetworkEditor   │                   │           │ │
│  │                  │  ・TradeoffAnalysis│                   │           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ Axios (REST API)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API層                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      FastAPI Routers                                   │ │
│  │                                                                        │ │
│  │   /api/projects/*      │  /api/calculations/*   │  /api/mds/*        │ │
│  │   ・CRUD操作           │  ・mountain計算        │  ・WLカーネル      │ │
│  │   ・関係管理           │  ・energy計算          │  ・MDS座標         │ │
│  │   ・Import/Export      │  ・tradeoff計算        │                    │ │
│  │                        │  ・shapley計算         │                    │ │
│  │                        │  ・scc分析             │                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ 関数呼び出し
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ビジネスロジック層                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Services                                       │ │
│  │                                                                        │ │
│  │   計算サービス              │  分析サービス           │  共通基盤      │ │
│  │   ・mountain_calculator    │  ・shapley_calculator  │  ・matrix_utils│ │
│  │   ・energy_calculator      │  ・scc_analyzer        │  ・weight_norm │ │
│  │   ・tradeoff_calculator    │  ・discretization_conf │  ・data_migrat │ │
│  │   ・structural_tradeoff    │                        │                │ │
│  │   ・structural_energy      │                        │                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ SQLAlchemy ORM
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           データ永続化層                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      SQLAlchemy Models                                 │ │
│  │                                                                        │ │
│  │   ProjectModel │ StakeholderModel │ NeedModel │ PerformanceModel     │ │
│  │   DesignCaseModel │ *RelationModels                                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      Database                                          │ │
│  │                      SQLite (ローカル) / PostgreSQL (本番)            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 フロントエンドコンポーネント階層

```
App.vue
│
├── Header.vue
│
└── Router View
    │
    ├── Home.vue
    │
    ├── ProjectList.vue
    │
    └── ProjectDetail.vue
        │
        ├── Tab: Stakeholders
        │   └── StakeholderMatrix.vue
        │
        ├── Tab: Performance
        │   ├── PerformanceManagement.vue
        │   └── PerformanceTree.vue
        │
        ├── Tab: Matrix
        │   ├── NeedPerformanceMatrix.vue
        │   └── DecompositionAnalysis.vue
        │
        ├── Tab: Mountain View
        │   ├── MountainView.vue (Three.js 3D)
        │   │   └── DesignCaseDetail.vue
        │   ├── DesignCaseList.vue
        │   └── DesignCaseForm.vue
        │
        ├── Tab: 2-Axis
        │   └── TwoAxisEvaluation.vue (Chart.js)
        │
        ├── Tab: Tradeoff Analysis
        │   ├── TradeoffAnalysisPanel.vue
        │   ├── TradeoffAnalysisModal.vue
        │   │   ├── TradeoffNetworkViewer.vue
        │   │   ├── MatrixHeatmap.vue
        │   │   ├── TradeoffMatrixMini.vue
        │   │   ├── ShapleyBreakdown.vue
        │   │   └── DiscretizationConfidence.vue
        │   └── SCCWarningBanner.vue
        │
        ├── Tab: 3D OPM
        │   └── OPM3DView.vue
        │       └── OPM3DScene.vue (Three.js)
        │
        └── Tab: Network
            ├── NetworkEditor.vue (D3.js)
            ├── NetworkViewer.vue
            └── NetworkHighlightViewer.vue
```

---

## 4. シーケンス図

### 4.1 山座標計算フロー

```
  Frontend              API                   Services                Database
     │                   │                       │                       │
     │  POST /mountain   │                       │                       │
     │──────────────────>│                       │                       │
     │                   │                       │                       │
     │                   │  get_project()        │                       │
     │                   │──────────────────────────────────────────────>│
     │                   │<─────────────────────────────────────────────│
     │                   │                       │                       │
     │                   │  mountain_calculator. │                       │
     │                   │  calculate_mountain() │                       │
     │                   │──────────────────────>│                       │
     │                   │                       │                       │
     │                   │                       │ 1. 票配分計算          │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │distribute_votes │   │
     │                   │                       │ │to_needs()       │   │
     │                   │                       │ └────────┬────────┘   │
     │                   │                       │          │            │
     │                   │                       │          ▼            │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │distribute_votes │   │
     │                   │                       │ │to_performances()│   │
     │                   │                       │ └────────┬────────┘   │
     │                   │                       │          │            │
     │                   │                       │          ▼            │
     │                   │                       │ 2. 効用値計算          │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │calculate_       │   │
     │                   │                       │ │utility_vector() │   │
     │                   │                       │ └────────┬────────┘   │
     │                   │                       │          │            │
     │                   │                       │          ▼            │
     │                   │                       │ 3. 標高計算           │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │calculate_       │   │
     │                   │                       │ │elevation()      │   │
     │                   │                       │ └────────┬────────┘   │
     │                   │                       │          │            │
     │                   │                       │          ▼            │
     │                   │                       │ 4. MDS座標計算        │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │compute_wl_kernel│   │
     │                   │                       │ │circular_mds()   │   │
     │                   │                       │ └────────┬────────┘   │
     │                   │                       │          │            │
     │                   │                       │          ▼            │
     │                   │                       │ 5. エネルギー計算      │
     │                   │                       │ ┌─────────────────┐   │
     │                   │                       │ │compute_         │   │
     │                   │                       │ │structural_energy│   │
     │                   │                       │ └─────────────────┘   │
     │                   │                       │                       │
     │                   │<─────────────────────│                       │
     │                   │  {positions, H_max}   │                       │
     │                   │                       │                       │
     │                   │  update_design_case() │                       │
     │                   │──────────────────────────────────────────────>│
     │                   │                       │                       │
     │<─────────────────│                       │                       │
     │  positions[]      │                       │                       │
     │                   │                       │                       │
```

### 4.2 構造的トレードオフ分析フロー

```
  Frontend                    API                        Services
     │                         │                             │
     │ GET /structural-        │                             │
     │ tradeoff/{case_id}      │                             │
     │────────────────────────>│                             │
     │                         │                             │
     │                         │  StructuralTradeoff         │
     │                         │  Calculator()               │
     │                         │────────────────────────────>│
     │                         │                             │
     │                         │                     ┌───────┴───────┐
     │                         │                     │ matrix_utils  │
     │                         │                     │               │
     │                         │                     │ 1. build_     │
     │                         │                     │ adjacency_    │
     │                         │                     │ matrices()    │
     │                         │                     │               │
     │                         │                     │   B_VA, B_AA, │
     │                         │                     │   B_AP        │
     │                         │                     │               │
     │                         │                     │ 2. compute_   │
     │                         │                     │ total_effect_ │
     │                         │                     │ matrix()      │
     │                         │                     │               │
     │                         │                     │   T = B_AP ×  │
     │                         │                     │   (I-B_AA)^-1 │
     │                         │                     │   × B_VA      │
     │                         │                     │               │
     │                         │                     │ 3. compute_   │
     │                         │                     │ inner_products│
     │                         │                     │               │
     │                         │                     │   C_ij =      │
     │                         │                     │   T_i · T_j   │
     │                         │                     │               │
     │                         │                     │ 4. compute_   │
     │                         │                     │ structural_   │
     │                         │                     │ tradeoff()    │
     │                         │                     │               │
     │                         │                     │   cos θ判定   │
     │                         │                     └───────┬───────┘
     │                         │<───────────────────────────│
     │                         │                             │
     │<────────────────────────│                             │
     │  {matrix, pairs,        │                             │
     │   summary, raw_matrix}  │                             │
```

### 4.3 Shapley値計算フロー

```
  TradeoffAnalysisModal        API                  shapley_calculator
         │                      │                          │
         │  GET /shapley/       │                          │
         │  {case}/{pi}/{pj}    │                          │
         │─────────────────────>│                          │
         │                      │                          │
         │                      │  calculate_shapley_     │
         │                      │  decomposition()         │
         │                      │─────────────────────────>│
         │                      │                          │
         │                      │                  ┌───────┴───────┐
         │                      │                  │               │
         │                      │                  │ 1. 属性ノード │
         │                      │                  │    抽出        │
         │                      │                  │               │
         │                      │                  │ 2. 全連合列挙 │
         │                      │                  │    2^n パターン│
         │                      │                  │               │
         │                      │                  │ 3. 各連合の   │
         │                      │                  │    C_ij 計算  │
         │                      │                  │               │
         │                      │                  │ 4. Shapley値  │
         │                      │                  │    算出        │
         │                      │                  │    φ_k = ...  │
         │                      │                  │               │
         │                      │                  └───────┬───────┘
         │                      │<────────────────────────│
         │                      │                          │
         │<────────────────────│                          │
         │  {shapley_values,    │                          │
         │   total_C_ij,        │                          │
         │   coalition_details} │                          │
         │                      │                          │
         │                      │                          │
         ▼                      │                          │
  ┌──────────────┐             │                          │
  │ShapleyBreak- │             │                          │
  │down.vue      │             │                          │
  │              │             │                          │
  │ 棒グラフ表示 │             │                          │
  └──────────────┘             │                          │
```

---

## 5. データフロー図

### 5.1 票配分フロー（DFD Level 0）

```
                               Deep Traceability System
                                        │
  ┌─────────────┐                      │                      ┌─────────────┐
  │ステーク     │    投票数            │                      │  設計案     │
  │ホルダー     │─────────────────────>│                      │  評価結果   │
  │             │    (votes)           │                      │             │
  └─────────────┘                      │                      └─────────────┘
                                       │                             ▲
  ┌─────────────┐                      │                             │
  │  ニーズ     │    優先度            │                             │
  │             │─────────────────────>│   山座標・エネルギー        │
  │             │    (priority)        │   トレードオフ指標          │
  └─────────────┘                      │─────────────────────────────┘
                                       │
  ┌─────────────┐                      │
  │  性能       │    効用関数          │
  │             │─────────────────────>│
  │             │                      │
  └─────────────┘                      │
                                       │
  ┌─────────────┐                      │
  │  設計案     │    ネットワーク構造  │
  │  (Network)  │─────────────────────>│
  │             │    性能値            │
  └─────────────┘                      │
```

### 5.2 票配分フロー（DFD Level 1）

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│  ┌──────────────┐                                                                  │
│  │ Stakeholder  │──── votes ────┐                                                  │
│  └──────────────┘               │                                                  │
│                                 ▼                                                  │
│                        ┌───────────────┐                                           │
│  ┌──────────────┐      │   P1: 票配分   │                                           │
│  │    Need      │─────>│  (SH → Need)  │                                           │
│  │  Relations   │      │               │                                           │
│  └──────────────┘      │ weight: ○/△   │                                           │
│                        └───────┬───────┘                                           │
│                                │                                                    │
│                          need_votes                                                │
│                                │                                                    │
│                                ▼                                                    │
│                        ┌───────────────┐                                           │
│  ┌──────────────┐      │   P2: 票配分   │                                           │
│  │    Need-     │─────>│ (Need → Perf) │                                           │
│  │  Performance │      │               │                                           │
│  │  Relations   │      │ direction ↑↓  │                                           │
│  └──────────────┘      │ + エントロピー │                                           │
│                        └───────┬───────┘                                           │
│                                │                                                    │
│                         perf_weights                                               │
│                                │                                                    │
│          ┌─────────────────────┼─────────────────────┐                             │
│          │                     │                     │                             │
│          ▼                     ▼                     ▼                             │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐                      │
│  │   P3: 効用    │    │   P4: 標高    │    │   P5: MDS     │                      │
│  │   値計算      │    │   計算        │    │   座標計算    │                      │
│  │               │    │               │    │               │                      │
│  │ utility_fn() │    │ H = Σw×u/Σw  │    │ WL Kernel    │                      │
│  └───────┬───────┘    └───────┬───────┘    └───────┬───────┘                      │
│          │                     │                     │                             │
│          │              H (標高)               x, y (座標)                         │
│          │                     │                     │                             │
│          │                     └──────────┬──────────┘                             │
│          │                                │                                        │
│          │                                ▼                                        │
│          │                       ┌───────────────┐                                 │
│          │                       │   P6: 円錐    │                                 │
│          │                       │   マッピング  │                                 │
│          │                       │               │                                 │
│          │                       │  x,y,z 座標   │                                 │
│          │                       └───────┬───────┘                                 │
│          │                               │                                         │
│          └───────────────────────────────┤                                         │
│                                          │                                         │
│                                          ▼                                         │
│                                 ┌─────────────────┐                                │
│                                 │ Mountain Position│                                │
│                                 │ {x, y, z, H,    │                                │
│                                 │  utility_vector,│                                │
│                                 │  partial_heights}│                                │
│                                 └─────────────────┘                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 総効果行列計算フロー

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           総効果行列 T の計算                                        │
│                                                                                     │
│   Network (nodes, edges)                                                           │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────┐                                                             │
│   │ 隣接行列構築     │                                                             │
│   │                  │                                                             │
│   │ ・V→A: B_VA     │                                                             │
│   │ ・A→A: B_AA     │                                                             │
│   │ ・A→P: B_AP     │                                                             │
│   └────────┬─────────┘                                                             │
│            │                                                                        │
│            ├──────────────┬──────────────┐                                         │
│            │              │              │                                         │
│            ▼              ▼              ▼                                         │
│       ┌────────┐    ┌────────┐    ┌────────┐                                      │
│       │ B_VA   │    │ B_AA   │    │ B_AP   │                                      │
│       │ (a×v)  │    │ (a×a)  │    │ (p×a)  │                                      │
│       └────┬───┘    └────┬───┘    └────┬───┘                                      │
│            │              │              │                                         │
│            │              ▼              │                                         │
│            │    ┌─────────────────┐     │                                         │
│            │    │ (I - B_AA)^{-1} │     │                                         │
│            │    │                 │     │                                         │
│            │    │ Neumann級数     │     │                                         │
│            │    │ または直接逆行列│     │                                         │
│            │    └────────┬────────┘     │                                         │
│            │              │              │                                         │
│            └──────────────┼──────────────┘                                         │
│                           │                                                         │
│                           ▼                                                         │
│             ┌───────────────────────────┐                                          │
│             │                           │                                          │
│             │  T = B_AP × (I-B_AA)^-1   │                                          │
│             │        × B_VA             │                                          │
│             │                           │                                          │
│             │  T[p][v] = 変数vが        │                                          │
│             │           性能pに与える   │                                          │
│             │           総効果          │                                          │
│             │                           │                                          │
│             └─────────────┬─────────────┘                                          │
│                           │                                                         │
│                           ▼                                                         │
│              ┌───────────────────────────┐                                         │
│              │ 内積計算                  │                                         │
│              │                           │                                         │
│              │ C_ij = T_i · T_j          │                                         │
│              │      = Σ_v T[i][v]×T[j][v]│                                         │
│              │                           │                                         │
│              │ C_ij > 0: シナジー        │                                         │
│              │ C_ij < 0: トレードオフ    │                                         │
│              └───────────────────────────┘                                         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 状態遷移図

### 6.1 設計案の状態遷移

```
                              ┌─────────────────┐
                              │                 │
         create               │    Created      │
    ─────────────────────────>│   (初期状態)    │
                              │                 │
                              └────────┬────────┘
                                       │
                                       │ 性能値入力
                                       │ ネットワーク編集
                                       ▼
                              ┌─────────────────┐
                              │                 │
                              │    Editing      │
                              │  (編集中)       │◄──────────────────┐
                              │                 │                   │
                              └────────┬────────┘                   │
                                       │                            │
                                       │ Save                       │ Edit
                                       ▼                            │
                              ┌─────────────────┐                   │
                              │                 │                   │
                              │    Saved        │───────────────────┘
                              │  (保存済み)     │
                              │                 │
                              └────────┬────────┘
                                       │
                                       │ Calculate Mountain
                                       ▼
                              ┌─────────────────┐
                              │                 │
                              │   Calculated    │
                              │  (計算済み)     │
                              │                 │
                              │ - mountain_pos  │
                              │ - energy        │
                              │ - utility_vec   │
                              │                 │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
   ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
   │  Analyzed     │         │   Compared    │         │   Exported    │
   │ (トレードオフ │         │  (MDS比較)    │         │  (JSON出力)   │
   │  分析済み)    │         │              │         │              │
   └───────────────┘         └───────────────┘         └───────────────┘
```

### 6.2 ネットワーク編集の状態遷移

```
                                    ┌──────────────────────┐
                                    │                      │
                                    │   Idle (待機)        │
                                    │                      │
                                    └──────────┬───────────┘
                                               │
                    ┌──────────────────────────┼──────────────────────────┐
                    │                          │                          │
                    ▼                          ▼                          ▼
         ┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐
         │                  │       │                  │       │                  │
         │  Node Selected   │       │  Edge Creating   │       │  Panning/Zooming │
         │  (ノード選択)    │       │  (エッジ作成中)  │       │  (画面操作)      │
         │                  │       │                  │       │                  │
         └────────┬─────────┘       └────────┬─────────┘       └────────┬─────────┘
                  │                          │                          │
         ┌────────┴────────┐                 │                          │
         │                 │                 │                          │
         ▼                 ▼                 ▼                          │
  ┌────────────┐   ┌────────────┐   ┌────────────────┐                 │
  │   Node     │   │   Node     │   │  Edge Weight   │                 │
  │  Dragging  │   │  Editing   │   │   Setting      │                 │
  │ (移動中)   │   │ (編集中)   │   │  (重み設定)    │                 │
  └─────┬──────┘   └─────┬──────┘   └───────┬────────┘                 │
        │                │                   │                          │
        │                │                   │                          │
        └────────────────┴───────────────────┴──────────────────────────┘
                                    │
                                    ▼
                          ┌──────────────────┐
                          │                  │
                          │  Network Updated │
                          │  (更新完了)      │
                          │                  │
                          └──────────────────┘
```

---

## 7. ユースケース図

### 7.1 全体ユースケース

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Deep Traceability System                               │
│                                                                                     │
│                                                                                     │
│                        ┌─────────────────────────────────┐                         │
│     ┌────────┐         │       プロジェクト管理          │         ┌────────┐      │
│     │        │         │  ┌─────────────────────────┐   │         │        │      │
│     │  設計  │─────────│──│ プロジェクト作成/削除   │   │─────────│ ステーク│      │
│     │  者    │         │  └─────────────────────────┘   │         │ ホルダー│      │
│     │        │         │  ┌─────────────────────────┐   │         │        │      │
│     └────┬───┘         │──│ インポート/エクスポート │   │         └────┬───┘      │
│          │             │  └─────────────────────────┘   │              │          │
│          │             └─────────────────────────────────┘              │          │
│          │                                                              │          │
│          │             ┌─────────────────────────────────┐              │          │
│          │             │       要求定義                   │              │          │
│          │             │  ┌─────────────────────────┐   │              │          │
│          ├─────────────│──│ ステークホルダー登録    │───│──────────────┤          │
│          │             │  └─────────────────────────┘   │              │          │
│          │             │  ┌─────────────────────────┐   │              │          │
│          │             │──│ ニーズ定義              │───│──────────────┘          │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ 投票数/優先度設定       │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             └─────────────────────────────────┘                         │
│          │                                                                          │
│          │             ┌─────────────────────────────────┐                         │
│          │             │       性能構造定義               │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          ├─────────────│──│ 性能ツリー構築          │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ 効用関数設計            │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ ニーズ-性能関係設定     │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             └─────────────────────────────────┘                         │
│          │                                                                          │
│          │             ┌─────────────────────────────────┐                         │
│          │             │       設計案作成                 │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          ├─────────────│──│ 性能値入力              │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ PAVEネットワーク編集    │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ 設計案コピー/削除       │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             └─────────────────────────────────┘                         │
│          │                                                                          │
│          │             ┌─────────────────────────────────┐                         │
│          │             │       分析・評価                 │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          ├─────────────│──│ Mountain View表示       │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ 2軸評価グラフ           │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ トレードオフ分析        │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          │             │──│ Shapley値分解           │   │                         │
│          │             │  └─────────────────────────┘   │                         │
│          │             │  ┌─────────────────────────┐   │                         │
│          └─────────────│──│ SCC(ループ)警告確認     │   │                         │
│                        │  └─────────────────────────┘   │                         │
│                        └─────────────────────────────────┘                         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 配置図

### 8.1 ローカル開発環境

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              開発者マシン                                           │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              Browser                                         │   │
│  │                         (Chrome / Safari)                                   │   │
│  │                                                                              │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                │   │
│  │  │   Vue 3 SPA    │  │   Three.js     │  │   D3.js        │                │   │
│  │  │                │  │   (3D View)    │  │   (Network)    │                │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘                │   │
│  └──────────────────────────────────┬──────────────────────────────────────────┘   │
│                                     │                                               │
│                                     │ http://localhost:5173                         │
│                                     │                                               │
│  ┌──────────────────────────────────┼──────────────────────────────────────────┐   │
│  │                           Vite Dev Server                                   │   │
│  │                            (Node.js)                                        │   │
│  │                           localhost:5173                                    │   │
│  │                                                                              │   │
│  │  ・HMR (Hot Module Replacement)                                             │   │
│  │  ・TypeScript トランスパイル                                                 │   │
│  │  ・Vue SFC コンパイル                                                        │   │
│  └──────────────────────────────────┬──────────────────────────────────────────┘   │
│                                     │                                               │
│                                     │ http://localhost:8000/api/*                   │
│                                     │ (CORS enabled)                                │
│                                     │                                               │
│  ┌──────────────────────────────────┼──────────────────────────────────────────┐   │
│  │                           FastAPI Server                                    │   │
│  │                          (uvicorn --reload)                                 │   │
│  │                           localhost:8000                                    │   │
│  │                                                                              │   │
│  │  ・REST API エンドポイント                                                   │   │
│  │  ・NumPy / scikit-learn 計算                                                │   │
│  │  ・Swagger UI (localhost:8000/docs)                                         │   │
│  └──────────────────────────────────┬──────────────────────────────────────────┘   │
│                                     │                                               │
│                                     │ SQLAlchemy ORM                                │
│                                     │                                               │
│  ┌──────────────────────────────────┼──────────────────────────────────────────┐   │
│  │                              SQLite                                         │   │
│  │                         ./backend/database.db                               │   │
│  │                                                                              │   │
│  │  ・ファイルベース DB                                                         │   │
│  │  ・開発時はマイグレーション不要                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Docker Compose 構成

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Docker Host                                            │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                           docker-compose.yml                                 │   │
│  │                                                                              │   │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │   │
│  │   │                    frontend (Container)                           │     │   │
│  │   │                                                                   │     │   │
│  │   │  Image: node:18-alpine                                           │     │   │
│  │   │  Ports: 5173:5173                                                │     │   │
│  │   │  Volumes: ./frontend:/app                                        │     │   │
│  │   │  Command: npm run dev                                            │     │   │
│  │   │                                                                   │     │   │
│  │   └───────────────────────────────────────────────────────────────────┘     │   │
│  │                                     │                                        │   │
│  │                                     │ depends_on                             │   │
│  │                                     ▼                                        │   │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │   │
│  │   │                    backend (Container)                            │     │   │
│  │   │                                                                   │     │   │
│  │   │  Image: python:3.10-slim                                         │     │   │
│  │   │  Ports: 8000:8000                                                │     │   │
│  │   │  Volumes: ./backend:/app                                         │     │   │
│  │   │  Command: uvicorn app.main:app --host 0.0.0.0 --reload          │     │   │
│  │   │                                                                   │     │   │
│  │   └───────────────────────────────────────────────────────────────────┘     │   │
│  │                                     │                                        │   │
│  │                                     │ depends_on (optional)                  │   │
│  │                                     ▼                                        │   │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │   │
│  │   │                    postgres (Container) - Optional               │     │   │
│  │   │                                                                   │     │   │
│  │   │  Image: postgres:15                                              │     │   │
│  │   │  Ports: 5432:5432                                                │     │   │
│  │   │  Volumes: postgres_data:/var/lib/postgresql/data                 │     │   │
│  │   │  Environment: POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD      │     │   │
│  │   │                                                                   │     │   │
│  │   └───────────────────────────────────────────────────────────────────┘     │   │
│  │                                                                              │   │
│  │   Volumes:                                                                   │   │
│  │     - postgres_data                                                         │   │
│  │                                                                              │   │
│  │   Networks:                                                                  │   │
│  │     - app_network (bridge)                                                  │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. モジュール依存図

### 9.1 バックエンドサービス依存関係

```
                              ┌─────────────────────┐
                              │   API Routers       │
                              │                     │
                              │ projects.py         │
                              │ calculations.py     │
                              │ mds.py              │
                              └──────────┬──────────┘
                                         │
         ┌───────────────────────────────┼───────────────────────────────┐
         │                               │                               │
         ▼                               ▼                               ▼
┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
│mountain_        │           │structural_      │           │shapley_         │
│calculator       │           │tradeoff         │           │calculator       │
│                 │           │                 │           │                 │
│・票配分計算     │           │・構造的トレード │           │・Shapley値計算  │
│・MDS座標        │           │  オフ分析       │           │・寄与度分解     │
│・標高計算       │           │                 │           │                 │
└────────┬────────┘           └────────┬────────┘           └────────┬────────┘
         │                             │                             │
         │                             │                             │
         ▼                             ▼                             ▼
┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
│structural_      │           │matrix_utils     │◄──────────│scc_analyzer     │
│energy           │──────────>│                 │           │                 │
│                 │           │・隣接行列構築   │           │・Tarjanアルゴ   │
│・損失関数       │           │・総効果行列     │           │・ループ検出     │
│・論文準拠       │           │・内積計算       │           │                 │
│  エネルギー     │           │                 │           │                 │
└────────┬────────┘           └────────┬────────┘           └─────────────────┘
         │                             │
         │                             │
         └──────────────┬──────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │weight_          │
              │normalization    │
              │                 │
              │・重みスキーム   │
              │・正規化関数     │
              │・離散↔連続変換 │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐           ┌─────────────────┐
              │discretization_  │           │data_migration   │
              │confidence       │           │                 │
              │                 │           │・バージョン管理 │
              │・符号保存確率   │           │・スキーマ変換   │
              │・順序保存確率   │           │                 │
              └─────────────────┘           └─────────────────┘


外部ライブラリ依存:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  matrix_utils ─────────────> numpy
                              scipy.stats

  mountain_calculator ──────> sklearn.manifold.MDS
                              scipy.spatial.distance

  mds.py ───────────────────> grakel (WL Kernel)
                              networkx

  scc_analyzer ─────────────> numpy (spectral radius)
```

### 9.2 フロントエンドコンポーネント依存関係

```
                              ┌─────────────────────┐
                              │   App.vue           │
                              │                     │
                              │  ・Router View      │
                              │  ・Header           │
                              └──────────┬──────────┘
                                         │
                                         ▼
                              ┌─────────────────────┐
                              │   projectStore.ts   │
                              │   (Pinia)           │
                              │                     │
                              │  ・currentProject   │
                              │  ・CRUD actions     │
                              │  ・computed getters │
                              └──────────┬──────────┘
                                         │
         ┌───────────────────────────────┼───────────────────────────────┐
         │                               │                               │
         ▼                               ▼                               ▼
┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
│StakeholderMatrix│           │NeedPerformance  │           │MountainView     │
│                 │           │Matrix           │           │                 │
│・マトリクス編集 │           │・方向設定       │           │・Three.js 3D    │
│・投票数管理     │           │・効用関数       │           │・球体プロット   │
└─────────────────┘           └─────────────────┘           └────────┬────────┘
                                                                      │
                                                                      ▼
                                                            ┌─────────────────┐
                                                            │DesignCaseDetail │
                                                            │                 │
                                                            │・詳細表示       │
                                                            │・RadarChart     │
                                                            └─────────────────┘

┌─────────────────┐           ┌─────────────────┐
│NetworkEditor    │           │TradeoffAnalysis │
│                 │           │Modal            │
│・D3.js SVG      │           │                 │
│・ノード/エッジ  │           │・タブ切り替え   │
│  編集           │           │                 │
│・重み設定       │           └────────┬────────┘
│・Excel入出力    │                    │
└─────────────────┘          ┌─────────┴─────────┐
                              │                   │
                              ▼                   ▼
                    ┌─────────────────┐ ┌─────────────────┐
                    │TradeoffNetwork  │ │ShapleyBreakdown │
                    │Viewer           │ │                 │
                    │                 │ │・棒グラフ       │
                    │・ハイライト表示 │ │・寄与度表示     │
                    └─────────────────┘ └─────────────────┘

外部ライブラリ依存:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  MountainView ─────────────> three.js
  OPM3DView ────────────────> three.js

  NetworkEditor ────────────> d3.js
  NetworkViewer ────────────> d3.js (force simulation)

  TwoAxisEvaluation ────────> chart.js / vue-chartjs

  StakeholderMatrix ────────> xlsx (Excel export)
  NeedPerfMatrix ───────────> xlsx (Excel export)
  NetworkEditor ────────────> xlsx (Excel import/export)
```

---

## 10. 計算パイプライン図

### 10.1 標高計算パイプライン

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                             標高計算パイプライン                                     │
│                                                                                     │
│  Input                                                                              │
│  ═════                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │ Stakeholders │  │    Needs     │  │ Performances │  │ Design Cases │           │
│  │              │  │              │  │              │  │              │           │
│  │ votes: 100   │  │ priority:0.5 │  │ utility_fn   │  │ perf_values  │           │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘           │
│         │                 │                 │                 │                    │
│         └────────┬────────┴─────────────────┴────────┬────────┘                    │
│                  │                                   │                             │
│                  ▼                                   │                             │
│  ┌───────────────────────────────────────┐          │                             │
│  │  Stage 1: 票配分 (SH → Need)           │          │                             │
│  │                                        │          │                             │
│  │  need_votes[n] = Σ (sh.votes × w[s,n]) │          │                             │
│  │                  / count(related_sh)   │          │                             │
│  │                                        │          │                             │
│  │  × priority[n]  ← ニーズ優先度で調整   │          │                             │
│  └──────────────────┬────────────────────┘          │                             │
│                     │                                │                             │
│                     ▼                                │                             │
│  ┌───────────────────────────────────────┐          │                             │
│  │  Stage 2: 票配分 (Need → Perf)         │          │                             │
│  │                                        │          │                             │
│  │  up_votes = Σ need_votes (dir='up')   │          │                             │
│  │  down_votes = Σ need_votes (dir='down')│          │                             │
│  │                                        │          │                             │
│  │  entropy = H(up, down)                 │          │                             │
│  │  perf_weight = total × (1 - H/log2)   │          │                             │
│  └──────────────────┬────────────────────┘          │                             │
│                     │                                │                             │
│                     │                                │                             │
│                     ▼                                ▼                             │
│  ┌───────────────────────────────────────────────────────────────────┐            │
│  │  Stage 3: 効用値計算                                               │            │
│  │                                                                    │            │
│  │  for each performance p:                                          │            │
│  │    value = design_case.perf_values[p]                             │            │
│  │    utility[p] = interpolate(utility_fn[p], value)  ∈ [0, 1]      │            │
│  └──────────────────────────────────┬────────────────────────────────┘            │
│                                     │                                              │
│                                     ▼                                              │
│  ┌───────────────────────────────────────────────────────────────────┐            │
│  │  Stage 4: 標高計算                                                 │            │
│  │                                                                    │            │
│  │            Σ (perf_weight[p] × utility[p])                        │            │
│  │  H   =   ─────────────────────────────────                        │            │
│  │                  Σ perf_weight[p]                                  │            │
│  │                                                                    │            │
│  │  partial_height[p] = perf_weight[p] × utility[p] / Σ weights     │            │
│  └──────────────────────────────────┬────────────────────────────────┘            │
│                                     │                                              │
│                                     ▼                                              │
│  Output                                                                            │
│  ══════                                                                            │
│  ┌──────────────────────────────────────────────────────────────────┐             │
│  │  MountainPosition {                                              │             │
│  │    H: float,              // 標高 (0 ~ 1)                        │             │
│  │    utility_vector: {},    // 各性能の効用値                       │             │
│  │    partial_heights: {},   // 各性能の部分標高                     │             │
│  │    performance_weights: {} // 各性能の重み（票数）                │             │
│  │  }                                                               │             │
│  └──────────────────────────────────────────────────────────────────┘             │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 構造的トレードオフ計算パイプライン

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        構造的トレードオフ計算パイプライン                            │
│                                                                                     │
│  Input: PAVEネットワーク                                                            │
│  ═════════════════════                                                              │
│  ┌──────────────────────────────────────────────────────────────────────────┐      │
│  │  Network { nodes: [...], edges: [...] }                                  │      │
│  │                                                                          │      │
│  │  Layer 1 (P): Performance nodes  ← 評価対象                              │      │
│  │  Layer 2 (A): Attribute nodes    ← 中間媒介                              │      │
│  │  Layer 3 (V): Variable nodes     ← 設計自由度                            │      │
│  │  Layer 4 (E): Entity nodes       ← 物理的実体                            │      │
│  └──────────────────────────────────────────────────────────────────────────┘      │
│                     │                                                               │
│                     ▼                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐             │
│  │  Stage 1: 隣接行列構築                                             │             │
│  │                                                                    │             │
│  │  B_VA : V × A 行列 (Variable → Attribute)                         │             │
│  │  B_AA : A × A 行列 (Attribute → Attribute)                        │             │
│  │  B_AP : A × P 行列 (Attribute → Performance)                      │             │
│  │                                                                    │             │
│  │  ※ 重みは weight_normalization で正規化                           │             │
│  │     discrete_7: {-5,...,5} → [-1, 1]                              │             │
│  │     continuous: そのまま使用                                       │             │
│  └──────────────────────────────────┬────────────────────────────────┘             │
│                                     │                                               │
│                                     ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────┐             │
│  │  Stage 2: ループ処理 (B_AA ≠ 0 の場合)                            │             │
│  │                                                                    │             │
│  │  ρ(B_AA) = スペクトル半径                                         │             │
│  │                                                                    │             │
│  │  if ρ < 1:                                                        │             │
│  │    (I - B_AA)^{-1} = I + B_AA + B_AA² + ...  (Neumann級数)       │             │
│  │  else:                                                            │             │
│  │    直接逆行列計算 or SCC分解                                       │             │
│  └──────────────────────────────────┬────────────────────────────────┘             │
│                                     │                                               │
│                                     ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────┐             │
│  │  Stage 3: 総効果行列計算                                           │             │
│  │                                                                    │             │
│  │  T = B_AP × (I - B_AA)^{-1} × B_VA                                │             │
│  │                                                                    │             │
│  │  T[p][v] = 変数 v が性能 p に与える総効果                         │             │
│  │            (直接効果 + 属性経由の間接効果の合計)                   │             │
│  └──────────────────────────────────┬────────────────────────────────┘             │
│                                     │                                               │
│                                     ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────┐             │
│  │  Stage 4: 内積計算（トレードオフ指標）                             │             │
│  │                                                                    │             │
│  │  C_ij = T_i · T_j = Σ_v T[i][v] × T[j][v]                        │             │
│  │                                                                    │             │
│  │  C_ij > 0: シナジー (同じ変数が両方を改善)                        │             │
│  │  C_ij < 0: トレードオフ (改善が競合)                              │             │
│  │  C_ij ≈ 0: 独立 (相互作用なし)                                    │             │
│  │                                                                    │             │
│  │  cos θ = C_ij / (||T_i|| × ||T_j||)  ∈ [-1, 1]                   │             │
│  └──────────────────────────────────┬────────────────────────────────┘             │
│                                     │                                               │
│                                     ▼                                               │
│  Output                                                                             │
│  ══════                                                                             │
│  ┌──────────────────────────────────────────────────────────────────┐              │
│  │  {                                                               │              │
│  │    matrix: [[C_ij, ...], ...],     // 内積行列                   │              │
│  │    pairs: [{pi, pj, value, type}, ...], // ペア情報              │              │
│  │    summary: {                                                    │              │
│  │      synergy_count, tradeoff_count, neutral_count,              │              │
│  │      synergy_ratio, tradeoff_ratio                              │              │
│  │    },                                                            │              │
│  │    total_effect_matrix: T          // 総効果行列                 │              │
│  │  }                                                               │              │
│  └──────────────────────────────────────────────────────────────────┘              │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. PAVEネットワーク構造図

### 11.1 4層構造の概念図

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              PAVEネットワーク構造                                    │
│                                                                                     │
│  Layer 1: Performance（性能）                                                       │
│  ════════════════════════════                                                       │
│  評価対象となる性能指標                                                             │
│  例: 速度、燃費、コスト、信頼性                                                     │
│                                                                                     │
│     ┌───────┐     ┌───────┐     ┌───────┐                                          │
│     │  P1   │     │  P2   │     │  P3   │      ← 性能ノード (黄色)                 │
│     │ 速度  │     │ 燃費  │     │コスト │                                          │
│     └───┬───┘     └───┬───┘     └───┬───┘                                          │
│         │             │             │                                              │
│         │ +0.8        │ -0.6        │ +0.4    ← A→P エッジ (因果方向)              │
│         │             │             │                                              │
│  ═══════╪═════════════╪═════════════╪═══════════════════════════════════════════   │
│         │             │             │                                              │
│  Layer 2: Attribute（属性）                                                        │
│  ════════════════════════════                                                       │
│  性能に直接影響する設計特性                                                         │
│  例: 重量、空力係数、出力密度                                                       │
│                                                                                     │
│         ▼             ▼             ▼                                              │
│     ┌───────┐     ┌───────┐     ┌───────┐                                          │
│     │  A1   │◄───│  A2   │───►│  A3   │      ← 属性ノード (シアン)                │
│     │ 重量  │     │空力係数│     │出力密度│                                          │
│     └───┬───┘     └───┬───┘     └───┬───┘                                          │
│         │             │             │                                              │
│         │     A→A ループ (属性間相互作用)                                          │
│         │                                                                          │
│         │ +0.7        │ -0.5        │ +0.9    ← V→A エッジ                         │
│         │             │             │                                              │
│  ═══════╪═════════════╪═════════════╪═══════════════════════════════════════════   │
│         │             │             │                                              │
│  Layer 3: Variable（変数）                                                         │
│  ════════════════════════════                                                       │
│  設計者が制御可能な設計パラメータ                                                   │
│  例: エンジン出力、翼面積、材料選択                                                 │
│                                                                                     │
│         ▼             ▼             ▼                                              │
│     ┌───────┐     ┌───────┐     ┌───────┐                                          │
│     │  V1   │     │  V2   │     │  V3   │      ← 変数ノード (マゼンタ)             │
│     │エンジン│     │翼面積 │     │ 材料  │                                          │
│     │ 出力  │     │       │     │       │                                          │
│     └───┬───┘     └───┬───┘     └───┬───┘                                          │
│         │             │             │                                              │
│         │             │             │         ← V↔E エッジ (無向)                  │
│         │             │             │                                              │
│  ═══════╪═════════════╪═════════════╪═══════════════════════════════════════════   │
│         │             │             │                                              │
│  Layer 4: Entity（実体）                                                           │
│  ════════════════════════════                                                       │
│  物理的な構成要素と外部環境                                                         │
│  例: エンジン、翼、燃料タンク、大気                                                 │
│                                                                                     │
│         ▼             ▼             ▼                                              │
│     ┌───────┐     ┌───────┐     ┌───────┐                                          │
│     │  E1   │─────│  E2   │─────│  E3   │      ← 実体ノード (オレンジ)             │
│     │エンジン│     │  翼   │     │燃料タンク│    E↔E: 物理的接続                     │
│     └───────┘     └───────┘     └───────┘                                          │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 エッジタイプと重み

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                             エッジタイプと重みスキーム                               │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  有向エッジ（因果関係）                                                      │   │
│  │                                                                              │   │
│  │  Type 1: A → P (属性 → 性能)                                                │   │
│  │  ────────────────────────                                                    │   │
│  │    ・属性が性能に与える直接的な影響                                          │   │
│  │    ・重み: 影響の強さと方向                                                  │   │
│  │                                                                              │   │
│  │  Type 2: A → A (属性 → 属性)                                                │   │
│  │  ────────────────────────                                                    │   │
│  │    ・属性間の相互作用（ループ形成の可能性）                                  │   │
│  │    ・収束条件: スペクトル半径 ρ < 1                                         │   │
│  │                                                                              │   │
│  │  Type 3: V → A (変数 → 属性)                                                │   │
│  │  ────────────────────────                                                    │   │
│  │    ・設計変数が属性に与える影響                                              │   │
│  │    ・設計自由度の定義                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  無向エッジ（物理的接続）                                                    │   │
│  │                                                                              │   │
│  │  Type 4: V ↔ E, E ↔ E                                                       │   │
│  │  ────────────────────────                                                    │   │
│  │    ・変数と実体の関連付け                                                    │   │
│  │    ・実体間の物理的接続                                                      │   │
│  │    ・重みなし（接続の有無のみ）                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  重みスキーム                                                                │   │
│  │                                                                              │   │
│  │  離散7段階 (discrete_7)                                                     │   │
│  │  ──────────────────────                                                      │   │
│  │    -5    -3    -1     0    +1    +3    +5                                   │   │
│  │    強負  中負  弱負  なし  弱正  中正  強正                                  │   │
│  │                                                                              │   │
│  │  離散5段階 (discrete_5)                                                     │   │
│  │  ──────────────────────                                                      │   │
│  │          -3    -1     0    +1    +3                                         │   │
│  │          強負  弱負  なし  弱正  強正                                        │   │
│  │                                                                              │   │
│  │  離散3段階 (discrete_3)                                                     │   │
│  │  ──────────────────────                                                      │   │
│  │                -1     0    +1                                               │   │
│  │                負   なし   正                                               │   │
│  │                                                                              │   │
│  │  連続 (continuous)                                                          │   │
│  │  ────────────────                                                            │   │
│  │    [-1.0, +1.0] の任意の実数値                                              │   │
│  │    より精密な因果強度の表現                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.3 総効果行列の幾何学的解釈

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          総効果行列の幾何学的解釈                                    │
│                                                                                     │
│  総効果行列 T = B_AP × (I - B_AA)^{-1} × B_VA                                      │
│                                                                                     │
│  各行 T_i は「変数空間における性能 i の効果ベクトル」                               │
│                                                                                     │
│                              Variable Space (V次元)                                 │
│                                                                                     │
│                                      │                                              │
│                                      │  V2                                          │
│                                      │                                              │
│                           T_2 ╲     │     ╱ T_1                                    │
│                               ╲    │    ╱                                          │
│                                ╲   │   ╱    θ < 90°: シナジー                      │
│                                 ╲  │  ╱     (cos θ > 0)                            │
│                                  ╲ │ ╱                                              │
│                        ───────────┼───────────── V1                                │
│                                  ╱ │ ╲                                              │
│                                 ╱  │  ╲                                             │
│                                ╱   │   ╲   θ > 90°: トレードオフ                   │
│                               ╱    │    ╲  (cos θ < 0)                             │
│                           T_3╱     │     ╲                                          │
│                                      │                                              │
│                                      │                                              │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  内積と角度の関係                                                            │   │
│  │                                                                              │   │
│  │  C_ij = T_i · T_j = ||T_i|| × ||T_j|| × cos θ                              │   │
│  │                                                                              │   │
│  │  cos θ = C_ij / (||T_i|| × ||T_j||)                                        │   │
│  │                                                                              │   │
│  │  ・cos θ ≈ +1: 強いシナジー（同方向）                                       │   │
│  │  ・cos θ ≈  0: 独立（直交）                                                 │   │
│  │  ・cos θ ≈ -1: 強いトレードオフ（逆方向）                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  設計への示唆                                                                │   │
│  │                                                                              │   │
│  │  シナジー (θ < 90°):                                                        │   │
│  │    → 同じ変数調整で両性能を改善可能                                         │   │
│  │    → Win-Win の設計変更を探索                                               │   │
│  │                                                                              │   │
│  │  トレードオフ (θ > 90°):                                                    │   │
│  │    → 一方を改善すると他方が悪化                                             │   │
│  │    → バランス点の決定が必要                                                 │   │
│  │    → Shapley値で寄与度を分解して対策検討                                    │   │
│  │                                                                              │   │
│  │  独立 (θ ≈ 90°):                                                           │   │
│  │    → 個別に最適化可能                                                       │   │
│  │    → 設計自由度が高い                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 付録A: 記法一覧

| 記号 | 意味 |
|------|------|
| P | Performance（性能）レイヤー |
| A | Attribute（属性）レイヤー |
| V | Variable（変数）レイヤー |
| E | Entity（実体）レイヤー |
| B_VA | 変数→属性 隣接行列 |
| B_AA | 属性→属性 隣接行列 |
| B_AP | 属性→性能 隣接行列 |
| T | 総効果行列 |
| C_ij | 性能ペア(i,j)の内積（トレードオフ指標） |
| H | 標高（設計案の総合評価値） |
| φ_k | 属性kのShapley値 |
| ρ | スペクトル半径 |
| SCC | 強連結成分 |

---

*このドキュメントは論文執筆用の図表素材です*
*最終更新: 2025年1月14日*
